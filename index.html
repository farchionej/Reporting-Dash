<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketing Analytics Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* Primary Purple Palette */
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --primary-light: #a78bfa;
            --primary-lighter: #6d45d1;
            --primary-glow: rgba(139, 92, 246, 0.4);

            /* Secondary Colors */
            --secondary: #1a1b23;
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --accent-pink: #ec4899;

            /* Text Colors */
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --text-tertiary: #6b7280;

            /* Border & Background */
            --border: #2d2e3a;
            --border-light: #3d3e4a;
            --bg-primary: #0d0e14;
            --bg-secondary: #050609;
            --bg-tertiary: #000000;
            --bg-glass: rgba(13, 14, 20, 0.7);

            /* Status Colors */
            --success: #10b981;
            --success-light: #064e3b;
            --success-glow: rgba(16, 185, 129, 0.3);
            --danger: #ef4444;
            --danger-light: #7f1d1d;
            --danger-glow: rgba(239, 68, 68, 0.3);
            --warning: #f59e0b;
            --warning-glow: rgba(245, 158, 11, 0.3);

            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.6);
            --shadow-glow: 0 0 40px var(--primary-glow);

            /* Animation Timings */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background:
                radial-gradient(ellipse at 20% 30%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 70%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(6, 182, 212, 0.08) 0%, transparent 50%),
                linear-gradient(135deg, #050609 0%, #0a0b0f 50%, #050609 100%);
            background-attachment: fixed;
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 10% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(236, 72, 153, 0.08) 0%, transparent 40%);
            animation: meshGlow 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes meshGlow {
            0%, 100% {
                opacity: 0.5;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.1);
            }
        }
        
        .container {
            max-width: 1320px;
            margin: 0 auto;
            padding: 24px;
            position: relative;
            z-index: 1;
        }
        
        /* Header Styles */
        .header {
            background: linear-gradient(135deg,
                rgba(13, 14, 20, 0.95) 0%,
                rgba(13, 14, 20, 0.85) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.05),
                0 0 0 1px rgba(139, 92, 246, 0.1);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(139, 92, 246, 0.5) 50%,
                transparent 100%);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }
        
        .header h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
            letter-spacing: -0.5px;
            position: relative;
            filter: drop-shadow(0 2px 8px rgba(139, 92, 246, 0.3));
        }
        
        .header-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 400;
        }
        
        .header-controls {
            display: flex;
            gap: 12px;
        }
        
        .btn {
            padding: 10px 18px;
            border-radius: 10px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition-normal);
            background: linear-gradient(135deg,
                rgba(13, 14, 20, 0.8) 0%,
                rgba(26, 27, 35, 0.6) 100%);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent,
                rgba(139, 92, 246, 0.1),
                transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            background: linear-gradient(135deg,
                rgba(26, 27, 35, 0.9) 0%,
                rgba(13, 14, 20, 0.8) 100%);
            border-color: rgba(139, 92, 246, 0.4);
            box-shadow:
                0 4px 16px rgba(139, 92, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: 1px solid rgba(167, 139, 250, 0.3);
            box-shadow:
                0 4px 20px rgba(139, 92, 246, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #6d28d9 100%);
            box-shadow:
                0 8px 32px rgba(139, 92, 246, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
            transform: translateY(-2px) scale(1.02);
        }

        .btn:active {
            transform: translateY(0) scale(0.98);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: linear-gradient(135deg,
                rgba(0, 0, 0, 0.6) 0%,
                rgba(13, 14, 20, 0.5) 100%);
            backdrop-filter: blur(10px);
            padding: 6px;
            border-radius: 14px;
            border: 1px solid rgba(139, 92, 246, 0.15);
            box-shadow:
                inset 0 1px 2px rgba(0, 0, 0, 0.5),
                0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .tab {
            flex: 1;
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
            transition: all var(--transition-normal);
            position: relative;
            z-index: 1;
        }

        .tab::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 10px;
            background: linear-gradient(135deg,
                rgba(139, 92, 246, 0.0) 0%,
                rgba(139, 92, 246, 0.1) 100%);
            opacity: 0;
            transition: opacity var(--transition-normal);
            z-index: -1;
        }

        .tab:hover::before {
            opacity: 1;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            background: linear-gradient(135deg,
                rgba(139, 92, 246, 0.3) 0%,
                rgba(124, 58, 237, 0.2) 100%);
            color: var(--text-primary);
            box-shadow:
                0 4px 16px rgba(139, 92, 246, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 0 0 1px rgba(139, 92, 246, 0.4);
            font-weight: 600;
        }

        .tab.active::before {
            opacity: 0;
        }
        
        /* KPIs Section */
        .kpis-section {
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding-left: 4px;
            position: relative;
            display: inline-block;
        }
        
        .section-title::before {
            content: '';
            position: absolute;
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 24px;
            background: var(--primary);
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }
        
        /* Enhanced KPI Cards with Sparklines */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        /* Special layout for 6 cards - center the last 2 */
        .kpi-grid.six-cards {
            grid-template-columns: repeat(4, 1fr);
        }
        
        .kpi-grid.six-cards .kpi-card:nth-child(5) {
            grid-column: 2 / 3;
        }
        
        .kpi-grid.six-cards .kpi-card:nth-child(6) {
            grid-column: 3 / 4;
        }
        
        @media (max-width: 1200px) {
            .kpi-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .kpi-card {
            background: linear-gradient(135deg,
                rgba(13, 14, 20, 0.9) 0%,
                rgba(13, 14, 20, 0.7) 100%);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            padding: 28px;
            border-radius: 16px;
            border: 1px solid rgba(139, 92, 246, 0.15);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
            box-shadow:
                0 4px 24px rgba(0, 0, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.03);
            animation: fadeInGlow 0.8s ease-out backwards;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg,
                transparent 0%,
                var(--primary) 50%,
                transparent 100%);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .kpi-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle,
                rgba(139, 92, 246, 0.08) 0%,
                transparent 70%);
            opacity: 0;
            transition: opacity var(--transition-slow);
            pointer-events: none;
        }

        .kpi-card:hover::before {
            opacity: 1;
        }

        .kpi-card:hover::after {
            opacity: 1;
        }

        .kpi-card:hover {
            box-shadow:
                0 8px 40px rgba(139, 92, 246, 0.25),
                0 0 0 1px rgba(139, 92, 246, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            transform: translateY(-4px) scale(1.01);
            border-color: rgba(139, 92, 246, 0.3);
        }
        
        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .kpi-label {
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            opacity: 0.8;
        }
        
        .kpi-value {
            font-size: 56px;
            font-weight: 800;
            background: linear-gradient(135deg,
                #ffffff 0%,
                #e0e7ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 16px 0 12px 0;
            letter-spacing: -2px;
            line-height: 1;
            filter: drop-shadow(0 4px 12px rgba(139, 92, 246, 0.2));
            font-variant-numeric: tabular-nums;
        }
        
        .kpi-comparison {
            display: flex;
            gap: 16px;
        }
        
        .kpi-change {
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 8px;
            transition: all var(--transition-normal);
            font-variant-numeric: tabular-nums;
        }

        .kpi-change.positive {
            color: #34d399;
            background: linear-gradient(135deg,
                rgba(16, 185, 129, 0.2) 0%,
                rgba(16, 185, 129, 0.1) 100%);
            border: 1px solid rgba(16, 185, 129, 0.2);
            box-shadow:
                0 2px 8px rgba(16, 185, 129, 0.15),
                inset 0 1px 0 rgba(16, 185, 129, 0.1);
        }

        .kpi-change.positive:hover {
            background: linear-gradient(135deg,
                rgba(16, 185, 129, 0.25) 0%,
                rgba(16, 185, 129, 0.15) 100%);
            box-shadow:
                0 4px 12px rgba(16, 185, 129, 0.2),
                inset 0 1px 0 rgba(16, 185, 129, 0.15);
            transform: scale(1.05);
        }

        .kpi-change.negative {
            color: #f87171;
            background: linear-gradient(135deg,
                rgba(239, 68, 68, 0.2) 0%,
                rgba(239, 68, 68, 0.1) 100%);
            border: 1px solid rgba(239, 68, 68, 0.2);
            box-shadow:
                0 2px 8px rgba(239, 68, 68, 0.15),
                inset 0 1px 0 rgba(239, 68, 68, 0.1);
        }

        .kpi-change.negative:hover {
            background: linear-gradient(135deg,
                rgba(239, 68, 68, 0.25) 0%,
                rgba(239, 68, 68, 0.15) 100%);
            box-shadow:
                0 4px 12px rgba(239, 68, 68, 0.2),
                inset 0 1px 0 rgba(239, 68, 68, 0.15);
            transform: scale(1.05);
        }
        
        .kpi-period {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }
        
        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }
        
        .content-grid-2col {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        
        .card {
            background: linear-gradient(135deg,
                rgba(13, 14, 20, 0.9) 0%,
                rgba(13, 14, 20, 0.7) 100%);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            padding: 28px;
            border-radius: 16px;
            border: 1px solid rgba(139, 92, 246, 0.12);
            box-shadow:
                0 4px 24px rgba(0, 0, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.03);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(139, 92, 246, 0.3) 50%,
                transparent 100%);
        }

        .card:hover {
            box-shadow:
                0 8px 32px rgba(139, 92, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            border-color: rgba(139, 92, 246, 0.25);
            transform: translateY(-2px);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .card h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* Section Tabs for Performance */
        .section-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--bg-primary);
            border-radius: 12px;
            border: 1px solid var(--border);
            justify-content: center;
        }
        
        .section-tab {
            padding: 12px 28px;
            background: linear-gradient(135deg,
                rgba(13, 14, 20, 0.6) 0%,
                rgba(26, 27, 35, 0.4) 100%);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 10px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .section-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent,
                rgba(139, 92, 246, 0.15),
                transparent);
            transition: left 0.5s ease;
        }

        .section-tab:hover::before {
            left: 100%;
        }

        .section-tab:hover {
            background: linear-gradient(135deg,
                rgba(139, 92, 246, 0.15) 0%,
                rgba(124, 58, 237, 0.1) 100%);
            color: var(--text-primary);
            border-color: rgba(139, 92, 246, 0.3);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
        }

        .section-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-color: rgba(167, 139, 250, 0.4);
            box-shadow:
                0 6px 24px rgba(139, 92, 246, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            font-weight: 600;
        }

        .section-tab.active::before {
            display: none;
        }
        
        .section-content {
            display: block;
        }
        
        .section-content.hidden {
            display: none;
        }
        
        /* Performance Table */
        .performance-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .performance-table th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid var(--border);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .performance-table td {
            padding: 16px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }
        
        .performance-table tr:hover {
            background: rgba(139, 92, 246, 0.05);
        }
        
        .metric-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .metric-badge.up {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }
        
        .metric-badge.down {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }
        
        .metric-badge.large {
            font-size: 16px;
            padding: 6px 12px;
            font-weight: 700;
        }
        
        /* Conversion Bars Chart */
        .conversion-bars {
            display: flex;
            align-items: flex-end;
            gap: 32px;
            padding: 24px;
            height: 350px;
        }
        
        .conversion-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }
        
        .conversion-bar {
            width: 100%;
            position: relative;
            display: flex;
            align-items: flex-end;
            margin-bottom: 16px;
        }
        
        .conversion-bar .bar-fill {
            width: 100%;
            background:
                linear-gradient(180deg,
                    rgba(167, 139, 250, 1) 0%,
                    rgba(139, 92, 246, 1) 50%,
                    rgba(124, 58, 237, 1) 100%);
            border-radius: 10px 10px 0 0;
            box-shadow:
                0 0 20px rgba(139, 92, 246, 0.4),
                inset 0 2px 4px rgba(255, 255, 255, 0.1);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .conversion-bar .bar-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent);
            animation: shimmerBar 2s infinite;
        }

        @keyframes shimmerBar {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .conversion-bar:hover .bar-fill {
            box-shadow:
                0 0 40px rgba(139, 92, 246, 0.6),
                inset 0 2px 6px rgba(255, 255, 255, 0.15);
            transform: translateY(-4px) scale(1.02);
        }
        
        .conversion-label {
            text-align: center;
        }
        
        .conversion-label strong {
            display: block;
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .conversion-value {
            display: block;
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .conversion-change {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .conversion-change.positive {
            color: var(--success);
            background: rgba(16, 185, 129, 0.15);
        }
        
        .conversion-change.negative {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.15);
        }
        
        /* Session Chart */
        .session-chart {
            position: relative;
            padding: 24px 24px 24px 60px;
            height: 400px;
        }
        
        .session-bars {
            display: flex;
            align-items: flex-end;
            gap: 24px;
            height: 100%;
        }
        
        .session-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }
        
        .session-bar {
            width: 100%;
            position: relative;
            display: flex;
            align-items: flex-end;
            margin-bottom: 12px;
        }
        
        .session-bar .bar-fill {
            width: 100%;
            background: linear-gradient(180deg, var(--primary-light), var(--primary));
            border-radius: 8px 8px 0 0;
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
            position: relative;
        }
        
        .session-bar .bar-fill.dark {
            background: linear-gradient(180deg, #6d45d1, #5a38b5);
        }
        
        .session-bar .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
        }
        
        .session-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
        }
        
        /* Modern Analytics Dashboard Styles */
        .analytics-dashboard {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 24px;
            padding: 24px;
            background: linear-gradient(135deg, #0a0b0f 0%, #1a1b2e 100%);
            border-radius: 12px;
        }
        
        .analytics-left-column {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .analytics-right-column {
            display: flex;
            flex-direction: column;
        }
        
        .analytics-section {
            background: rgba(20, 21, 28, 0.8);
            border: 1px solid rgba(139, 92, 246, 0.1);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .analytics-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #a78bfa;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Event Metrics Section */
        .event-metrics-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .event-metric-item {
            display: grid;
            grid-template-columns: 100px 1fr 60px 80px;
            align-items: center;
            gap: 12px;
        }
        
        .event-metric-name {
            font-size: 12px;
            color: #94a3b8;
        }
        
        .event-metric-bar {
            position: relative;
            height: 32px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .event-metric-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #a78bfa);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            position: relative;
        }
        
        .event-metric-fill.highlight {
            background: linear-gradient(90deg, #10b981, #34d399);
        }
        
        .event-metric-value {
            color: white;
            font-size: 12px;
            font-weight: 600;
        }
        
        .event-metric-change {
            font-size: 11px;
            font-weight: 600;
            text-align: right;
        }
        
        .event-metric-change.positive {
            color: #10b981;
        }
        
        .event-metric-change.negative {
            color: #ef4444;
        }
        
        .event-metric-sparkline {
            width: 60px;
            height: 20px;
        }
        
        /* Traffic Sources Section */
        .traffic-sources-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .traffic-source-item {
            display: grid;
            grid-template-columns: 80px 1fr 60px 60px;
            align-items: center;
            gap: 12px;
        }
        
        .traffic-source-name {
            font-size: 12px;
            color: #94a3b8;
        }
        
        .traffic-source-bar {
            height: 28px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .traffic-source-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
        }
        
        .traffic-source-value {
            color: white;
            font-size: 11px;
            font-weight: 600;
        }
        
        .traffic-source-change {
            font-size: 11px;
            font-weight: 600;
            text-align: right;
        }
        
        .traffic-source-change.positive {
            color: #10b981;
        }
        
        .traffic-source-change.negative {
            color: #ef4444;
        }
        
        /* New Users by Channel Section */
        .channel-users-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .channel-user-item {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
        }
        
        .channel-user-item:last-child {
            border-bottom: none;
        }
        
        .channel-user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .channel-user-name {
            font-size: 13px;
            color: #cbd5e1;
            font-weight: 500;
            min-width: 120px;
        }
        
        .channel-user-stats {
            display: flex;
            gap: 16px;
            align-items: center;
            font-size: 13px;
        }
        
        .channel-user-value {
            color: #f1f5f9;
            font-weight: 600;
            min-width: 60px;
            text-align: right;
        }
        
        .channel-user-change {
            font-weight: 600;
            min-width: 60px;
            text-align: right;
        }
        
        .channel-user-change.positive {
            color: #10b981;
        }
        
        .channel-user-change.negative {
            color: #ef4444;
        }
        
        .channel-user-bars {
            position: relative;
            height: 32px;
            display: flex;
            align-items: center;
        }
        
        .channel-bar-container {
            position: relative;
            width: 100%;
            height: 24px;
        }
        
        .channel-bar-background {
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(139, 92, 246, 0.08);
            border-radius: 6px;
        }
        
        .channel-bar-previous {
            position: absolute;
            height: 100%;
            background: rgba(139, 92, 246, 0.25);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
        }
        
        .channel-bar-current {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #9333ea);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            box-shadow: 0 2px 4px rgba(139, 92, 246, 0.3);
        }
        
        .channel-bar-label {
            color: white;
            font-size: 11px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
        }
        
        /* GBP Metric Cards */
        .gbp-metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .gbp-metric-card {
            background: rgba(13, 14, 20, 0.6);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .gbp-metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            opacity: 0.8;
        }
        
        .gbp-metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.4);
        }
        
        .gbp-metric-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.1));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            font-size: 20px;
        }
        
        .gbp-metric-label {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .gbp-metric-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
            line-height: 1;
        }
        
        .gbp-metric-change {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .gbp-metric-change.positive {
            color: var(--success);
        }
        
        .gbp-metric-change.negative {
            color: var(--danger);
        }
        
        .gbp-metric-change-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .gbp-metric-change-badge.positive {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .gbp-metric-change-badge.negative {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .gbp-metric-sparkline-mini {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 80px;
            height: 30px;
            opacity: 0.8;
        }
        
        .gbp-metric-sparkline-mini svg {
            width: 100%;
            height: 100%;
        }
        
        .gbp-metric-sparkline-mini path {
            fill: none;
            stroke: var(--primary);
            stroke-width: 2;
        }
        
        /* Performance KPIs Section */
        .performance-kpis {
            background: rgba(20, 21, 28, 0.9);
            border: 1px solid rgba(139, 92, 246, 0.1);
            border-radius: 12px;
            padding: 24px;
            margin-top: 24px;
            backdrop-filter: blur(10px);
        }
        
        .kpis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .kpis-title {
            font-size: 14px;
            font-weight: 600;
            color: #f97316;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .kpis-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 32px;
        }
        
        .kpi-card {
            text-align: center;
        }
        
        .kpi-label {
            font-size: 10px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            color: #e2e8f0;
            margin-bottom: 4px;
        }
        
        .kpi-change {
            font-size: 12px;
            font-weight: 600;
        }
        
        .kpi-change.positive {
            color: #10b981;
        }
        
        .kpi-change.negative {
            color: #ef4444;
        }
        
        /* Sparkline Styles */
        .sparkline {
            display: inline-block;
            width: 60px;
            height: 20px;
            margin-left: 8px;
        }
        
        .sparkline svg {
            width: 100%;
            height: 100%;
        }
        
        .sparkline path {
            fill: none;
            stroke: #8b5cf6;
            stroke-width: 2;
            opacity: 0.6;
        }
        
        .sparkline.positive path {
            stroke: #10b981;
        }
        
        .sparkline.negative path {
            stroke: #ef4444;
        }
        
        /* Legend */
        .channel-legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 11px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        
        .legend-color.current {
            background: #8b5cf6;
        }
        
        .legend-color.previous {
            background: rgba(139, 92, 246, 0.3);
        }
        
        .legend-label {
            color: #94a3b8;
        }
        
        /* Checkbox for percentage toggle */
        .show-percentage-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .show-percentage-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #8b5cf6;
        }
        
        .show-percentage-toggle label {
            font-size: 12px;
            color: #94a3b8;
            cursor: pointer;
        }
        
        /* Metric Grid */
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            padding: 24px;
        }
        
        .metric-item {
            text-align: center;
        }
        
        .metric-item .metric-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .metric-item .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .metric-item .metric-change {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Google Ads Styles */
        .cost-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 12px;
            padding: 20px 24px;
            text-align: center;
            margin-bottom: 24px;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
        }
        
        .cost-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .cost-value {
            font-size: 32px;
            font-weight: 700;
            color: white;
            margin-bottom: 4px;
        }
        
        .cost-period {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 16px;
        }
        
        .cost-metrics-row {
            display: flex;
            justify-content: center;
            gap: 40px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .cost-metric {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        
        .metric-label {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .metric-value {
            font-size: 16px;
            font-weight: 600;
            color: white;
        }
        
        #performanceChange {
            color: #86efac;
        }
        
        #performanceChange.negative {
            color: #fca5a5;
        }
        
        @media (max-width: 640px) {
            .cost-metrics-row {
                gap: 20px;
            }
            
            .cost-value {
                font-size: 28px;
            }
            
            .metric-value {
                font-size: 14px;
            }
        }
        
        /* Ads Performance Table */
        .ads-performance-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .ads-performance-table th {
            text-align: left;
            padding: 16px;
            background: var(--bg-tertiary);
            border-bottom: 2px solid var(--primary);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .ads-performance-table td {
            padding: 20px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 16px;
        }
        
        .conversion-name {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .conversion-icon {
            font-size: 22px;
        }
        
        .conversion-name strong {
            font-size: 16px;
        }
        
        .count-cell {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', monospace;
        }
        
        /* Standardized numeric display for consistency across all data uploads */
        .numeric-value {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', monospace;
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.02em;
        }
        
        .numeric-value-large {
            font-size: 20px;
            font-weight: 600;
        }
        
        .numeric-value-medium {
            font-size: 16px;
            font-weight: 600;
        }
        
        .numeric-value-small {
            font-size: 14px;
            font-weight: 500;
        }
        
        .cost-cell {
            font-weight: 500;
            color: var(--primary-light);
        }
        
        /* Simple Metrics Chart */
        .simple-metrics-chart {
            padding: 20px 0;
        }
        
        .metric-bar-row {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(13, 14, 20, 0.5);
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .metric-bar-label {
            width: 200px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .metric-bar-container {
            flex: 1;
            position: relative;
            height: 32px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .metric-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 4px;
            transition: width 1s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.4);
        }
        
        .metric-bar-value {
            color: white;
            font-size: 12px;
            font-weight: 600;
        }
        
        .metric-bar-change {
            width: 100px;
            text-align: right;
            font-size: 13px;
            font-weight: 600;
            margin-left: 12px;
        }
        
        .metric-bar-change.positive {
            color: var(--success);
        }
        
        .metric-bar-change.negative {
            color: var(--danger);
        }
        
        /* Comparison Table */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .comparison-table th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid var(--border);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .comparison-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }
        
        .comparison-table tr:hover {
            background: rgba(139, 92, 246, 0.08);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.1);
        }
        
        /* Data table for Overview section */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            text-align: left;
            padding: 14px 16px;
            border-bottom: 2px solid var(--border);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            background: var(--bg-secondary);
        }
        
        .data-table th:first-child {
            width: 60%;
        }
        
        .data-table th:nth-child(2),
        .data-table th:nth-child(3) {
            width: 20%;
            text-align: center;
        }
        
        .data-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }
        
        .data-table td:nth-child(2),
        .data-table td:nth-child(3) {
            text-align: center;
        }
        
        .data-table tr:hover {
            background: var(--hover);
        }
        
        /* Parser Textarea */
        .parser-textarea {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            resize: vertical;
            background: rgba(0, 0, 0, 0.7);
            color: var(--text-primary);
        }
        
        .parser-controls {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }
        
        .hidden {
            display: none;
        }
        
        @keyframes fadeInGlow {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
                box-shadow: 0 0 0 rgba(139, 92, 246, 0);
            }
            50% {
                opacity: 0.5;
                box-shadow: 0 0 40px rgba(139, 92, 246, 0.5);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
                box-shadow: 0 4px 24px rgba(0, 0, 0, 0.6);
            }
        }

        @keyframes pulseGlow {
            0%, 100% {
                box-shadow:
                    0 4px 24px rgba(0, 0, 0, 0.6),
                    0 0 0 rgba(139, 92, 246, 0);
            }
            50% {
                box-shadow:
                    0 4px 24px rgba(0, 0, 0, 0.6),
                    0 0 20px rgba(139, 92, 246, 0.3);
            }
        }

        @keyframes slideInFromLeft {
            0% {
                opacity: 0;
                transform: translateX(-30px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInFromRight {
            0% {
                opacity: 0;
                transform: translateX(30px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes scaleIn {
            0% {
                opacity: 0;
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Parsing animation styles */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        
        button.parsing {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            opacity: 0.9;
            cursor: wait;
            position: relative;
            overflow: hidden;
        }
        
        button.parsing::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* ===================================
           ACCESSIBILITY IMPROVEMENTS
           =================================== */

        /* Focus States for Keyboard Navigation */
        *:focus {
            outline: none;
        }

        button:focus-visible,
        .tab:focus-visible,
        .section-tab:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
            box-shadow:
                0 0 0 4px rgba(139, 92, 246, 0.2),
                0 4px 16px rgba(139, 92, 246, 0.3);
        }

        .btn:focus-visible {
            outline: 2px solid var(--primary-light);
            outline-offset: 3px;
            box-shadow:
                0 0 0 4px rgba(139, 92, 246, 0.25),
                0 6px 20px rgba(139, 92, 246, 0.4);
        }

        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }

            body::before {
                animation: none !important;
            }

            .conversion-bar .bar-fill::before,
            .btn::before,
            .section-tab::before {
                animation: none !important;
            }
        }

        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            :root {
                --border: #4d4e5a;
                --text-secondary: #c0c0c0;
            }

            .kpi-card,
            .card,
            .header {
                border-width: 2px;
            }

            .btn-primary {
                border: 2px solid #ffffff;
            }
        }

        /* Dark Mode Enhancements (already dark, but for completeness) */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #0d0e14;
                --bg-secondary: #050609;
            }
        }

        /* Print Styles */
        @media print {
            body::before {
                display: none;
            }

            .header-controls,
            .tabs,
            #import {
                display: none !important;
            }

            .card,
            .kpi-card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #333;
            }
        }

        /* Staggered Animation Delays for KPI Cards */
        .kpi-card:nth-child(1) { animation-delay: 0.05s; }
        .kpi-card:nth-child(2) { animation-delay: 0.1s; }
        .kpi-card:nth-child(3) { animation-delay: 0.15s; }
        .kpi-card:nth-child(4) { animation-delay: 0.2s; }
        .kpi-card:nth-child(5) { animation-delay: 0.25s; }
        .kpi-card:nth-child(6) { animation-delay: 0.3s; }

        /* Smooth Scrolling */
        html {
            scroll-behavior: smooth;
        }

        @media (prefers-reduced-motion: reduce) {
            html {
                scroll-behavior: auto;
            }
        }

        /* Selection Styles */
        ::selection {
            background: rgba(139, 92, 246, 0.3);
            color: var(--text-primary);
        }

        ::-moz-selection {
            background: rgba(139, 92, 246, 0.3);
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <div>
                    <h1>Marketing Analytics Dashboard</h1>
                    <div class="header-subtitle" id="headerSubtitle">Restaurant Performance Metrics</div>
                </div>
                <div class="header-controls">
                    <button class="btn btn-primary" onclick="loadSampleReport()">
                        <span>📊</span> Load Sample
                    </button>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('overview', this)">Overview</button>
                <button class="tab" onclick="switchTab('performance', this)">Performance</button>
                <button class="tab" onclick="switchTab('import', this)">Import Report</button>
            </div>
        </div>
        
        <!-- Overview Tab -->
        <div id="overview" class="tab-content">
            <div class="kpis-section">
                <h2 class="section-title">Core KPIs</h2>
                <div class="kpi-grid" id="kpiGrid"></div>
            </div>
            
            <!-- GBP Year-over-Year Performance -->
            <div class="content-grid" style="margin-top: 30px;">
                <div class="card" style="grid-column: span 2;">
                    <div class="card-header">
                        <h3>Year-over-Year Performance</h3>
                        <span style="font-size: 12px; color: var(--text-secondary);">Google Business Profile metrics comparison</span>
                    </div>
                    <div id="overviewGbpChart" style="min-height: 400px; padding: 20px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(109, 69, 209, 0.08) 100%); border-radius: 12px; border: 1px solid rgba(139, 92, 246, 0.2);">
                        <!-- Chart will be inserted here -->
                    </div>
                </div>
            </div>
            
            <!-- Google Ads Conversion Performance -->
            <div class="content-grid" style="margin-top: 30px;">
                <div class="card" style="grid-column: span 2;">
                    <div class="card-header">
                        <h3>Google Ads Conversion Performance</h3>
                        <span style="font-size: 12px; color: var(--text-secondary);">Customer actions from paid campaigns</span>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Conversion Action</th>
                                    <th style="text-align: center;">Volume</th>
                                    <th style="text-align: center;">Change</th>
                                </tr>
                            </thead>
                            <tbody id="overviewAdsTable">
                                <!-- Data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- New Users by Channel -->
            <div class="content-grid" style="margin-top: 30px;">
                <div class="card" style="grid-column: span 2;">
                    <div class="card-header">
                        <h3>New Users by Channel</h3>
                        <span style="font-size: 12px; color: var(--text-secondary);">Traffic source breakdown and performance</span>
                    </div>
                    <div style="padding: 20px;">
                        <div class="channel-legend" style="margin-bottom: 20px;">
                            <div class="legend-item">
                                <div class="legend-color current"></div>
                                <span class="legend-label">Current Period</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color previous"></div>
                                <span class="legend-label">Previous Period</span>
                            </div>
                        </div>
                        <div class="channel-users-list" id="overviewChannelUsersList">
                            <!-- Channel data will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recommended Insights -->
            <div class="content-grid" style="margin-top: 30px; margin-bottom: 30px;">
                <div class="card" style="grid-column: span 2;">
                    <div class="card-header">
                        <h3>Recommended Insights</h3>
                        <span style="font-size: 12px; color: var(--text-secondary);">AI-powered analysis and recommendations</span>
                    </div>
                    <div id="recommendedInsights" style="padding: 20px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.03) 0%, rgba(109, 69, 209, 0.05) 100%); border-radius: 8px;">
                        <!-- Insights will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Performance Tab -->
        <div id="performance" class="tab-content hidden">
            <div class="section-tabs">
                <button class="section-tab active" onclick="switchSection('gbp', this)">
                    Google Business Profile
                </button>
                <button class="section-tab" onclick="switchSection('analytics', this)">
                    Google Analytics
                </button>
                <button class="section-tab" onclick="switchSection('ads', this)">
                    Google Ads
                </button>
            </div>
            
            <!-- GBP Section -->
            <div id="gbp-section" class="section-content">
                <div class="content-grid">
                    <div class="card" style="grid-column: span 2;">
                        <div class="card-header">
                            <h3>Google Business Profile Performance</h3>
                        </div>
                        <div class="gbp-metrics-grid" id="gbpMetricsGrid">
                            <!-- GBP metric cards will be inserted here -->
                        </div>
                        
                        <!-- Year-over-Year Comparison Chart -->
                        <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(109, 69, 209, 0.08) 100%); border-radius: 12px; border: 1px solid rgba(139, 92, 246, 0.2);">
                            <h4 style="font-size: 16px; color: var(--text-primary); margin-bottom: 20px; font-weight: 600;">Year-over-Year Performance</h4>
                            <div id="gbpYoyChart" style="min-height: 400px;">
                                <!-- Chart will be inserted here -->
                            </div>
                        </div>
                        
                        <!-- Optional: Keep a mini section for Rating and Reviews -->
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">Reputation Metrics</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div id="gbpRating" style="display: flex; align-items: center; gap: 12px;">
                                    <!-- Rating will be inserted here -->
                                </div>
                                <div id="gbpReviews" style="display: flex; align-items: center; gap: 12px;">
                                    <!-- Reviews count will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Section -->
            <div id="analytics-section" class="section-content hidden">
                <div class="analytics-dashboard">
                    <!-- Left Column -->
                    <div class="analytics-left-column">
                        <!-- Event Metrics Section -->
                        <div class="analytics-section">
                            <h3 class="analytics-section-title">Event Metrics</h3>
                            <div class="event-metrics-list" id="eventMetricsList"></div>
                        </div>
                        
                        <!-- Traffic Sources Section -->
                        <div class="analytics-section">
                            <h3 class="analytics-section-title">Traffic Sources</h3>
                            <div class="traffic-sources-list" id="trafficSourcesList"></div>
                        </div>
                    </div>
                    
                    <!-- Right Column -->
                    <div class="analytics-right-column">
                        <div class="analytics-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 class="analytics-section-title" style="margin-bottom: 0;">New Users by Channel</h3>
                                <div class="show-percentage-toggle">
                                    <input type="checkbox" id="showPercentages" checked>
                                    <label for="showPercentages">Show percentage changes</label>
                                </div>
                            </div>
                            <div class="channel-legend">
                                <div class="legend-item">
                                    <div class="legend-color current"></div>
                                    <span class="legend-label">Current</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color previous"></div>
                                    <span class="legend-label">Previous</span>
                                </div>
                            </div>
                            <div class="channel-users-list" id="channelUsersList"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Performance KPIs Bottom Bar -->
                <div class="performance-kpis">
                    <div class="kpis-header">
                        <h3 class="kpis-title">Performance KPIs</h3>
                    </div>
                    <div class="kpis-grid" id="performanceKPIs"></div>
                </div>
            </div>
            
            <!-- Ads Section -->
            <div id="ads-section" class="section-content hidden">
                <div class="content-grid">
                    <div class="cost-header" id="totalCostHeader">
                        <div class="cost-label">Customer Actions Generated</div>
                        <div class="cost-value" id="totalActionsValue">0</div>
                        <div class="cost-period">From Your Marketing Investment</div>
                        <div class="cost-metrics-row">
                            <div class="cost-metric">
                                <span class="metric-label">Cost per Action</span>
                                <span class="metric-value" id="costPerAction">$0</span>
                            </div>
                            <div class="cost-metric">
                                <span class="metric-label">Investment</span>
                                <span class="metric-value" id="totalInvestment">$0</span>
                            </div>
                            <div class="cost-metric">
                                <span class="metric-label">Performance</span>
                                <span class="metric-value" id="performanceChange">+0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Conversion Performance</h3>
                        </div>
                        <table class="ads-performance-table" id="adsTable">
                            <thead>
                                <tr>
                                    <th>Conversion Action</th>
                                    <th>Count</th>
                                    <th>Change</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Import Tab -->
        <div id="import" class="tab-content hidden">
            <div class="card">
                <h3 style="margin-bottom: 16px;">Import Performance Report</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">
                    Paste your performance report below to automatically extract and visualize metrics.
                </p>
                <textarea id="reportText" class="parser-textarea" placeholder="Paste your report here...

Supports tables with | separators, bullet points, and narrative text."></textarea>
                <div class="parser-controls">
                    <button class="btn btn-primary" onclick="parseReport()">
                        <span>📊</span> Parse & Visualize
                    </button>
                    <button class="btn btn-primary" onclick="generateEmailReport()" id="emailBtn" style="display: none;">
                        <span>✉️</span> Generate Email Report
                    </button>
                    <div id="darkModeToggle" style="display: none; margin-left: 12px;">
                        <label style="display: inline-flex; align-items: center; cursor: pointer; color: var(--text-secondary); font-size: 14px;">
                            <input type="checkbox" id="emailDarkMode" style="margin-right: 8px; accent-color: #8b5cf6;">
                            <span>Dark Mode Email</span>
                        </label>
                    </div>
                    <button class="btn" onclick="clearReport()">
                        <span>✕</span> Clear
                    </button>
                    <div class="dropdown" style="position: relative; display: inline-block;">
                        <button class="btn" onclick="toggleHistoryDropdown()" id="historyBtn">
                            <span>📁</span> History
                        </button>
                        <div id="historyDropdown" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 8px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 250px; max-height: 400px; overflow-y: auto; z-index: 1000;">
                            <!-- History items will be added here -->
                        </div>
                    </div>
                </div>
                <div id="emailOutput" style="margin-top: 24px; display: none;">
                    <h3 style="margin-bottom: 16px;">Email Report Generated</h3>
                    <div id="suggestedSubject" style="background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                        <p style="margin: 0; color: var(--text-secondary); font-size: 13px;">
                            <strong>Suggested Subject Line:</strong> 
                            <span id="subjectLineText" style="color: var(--text-primary); font-size: 14px;"></span>
                        </p>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 12px;">
                        Edit the email preview below, then copy it to Gmail. Click any text to edit it, or use the toolbar to modify sections.
                    </p>
                    <div style="display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="copyEditedEmail()">
                            <span>📧</span> Copy to Gmail
                        </button>
                        <button class="btn" onclick="toggleEditMode()">
                            <span>✏️</span> <span id="editModeText">Enable Editing</span>
                        </button>
                        <button class="btn" onclick="previewInNewWindow()">
                            <span>👁️</span> Preview in New Window
                        </button>
                        <button class="btn" onclick="resetEmail()">
                            <span>↺</span> Reset Changes
                        </button>
                        <div style="flex: 1;"></div>
                        <button class="btn" onclick="toggleHTMLView()" style="margin-left: auto;">
                            <span>{ }</span> View HTML
                        </button>
                    </div>
                    <div id="editingTips" style="display: none; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                        <p style="margin: 0; color: var(--text-secondary); font-size: 13px;">
                            <strong>Editing Mode Active:</strong> 
                            • Click any text to edit it inline
                            • Right-click sections to delete them
                            • Changes are temporary until you copy the email
                        </p>
                    </div>
                    <div id="emailPreview" style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 20px; max-height: 600px; overflow-y: auto;"></div>
                    <textarea id="emailHTML" class="parser-textarea" readonly style="height: 400px; font-size: 12px; display: none;"></textarea>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global data storage
        let dashboardData = {};
        let parserMetadata = {
            businessName: null,
            reportPeriod: null,
            confidence: {},
            warnings: [],
            platform: null
        };
        
        // Universal Dynamic Parser
        function parseReport() {
            const text = document.getElementById('reportText').value;
            if (!text) {
                alert('Please paste a report first');
                return;
            }
            
            // Add parsing animation to button
            const parseBtn = document.querySelector('button[onclick="parseReport()"]');
            if (parseBtn) {
                parseBtn.innerHTML = '<span class="spinner">⟳</span> Parsing...';
                parseBtn.classList.add('parsing');
            }
            
            // Reset data - CRITICAL for preventing carryover
            dashboardData = {};
            parserMetadata = {
                businessName: null,
                reportPeriod: null,
                confidence: {},
                warnings: [],
                platform: null,
                sectionsFound: []
            };
            
            // Multi-pass extraction
            extractBusinessName(text);
            extractReportPeriod(text);
            
            // Try all extraction methods
            const tableData = extractTableData(text);
            const narrativeData = extractNarrativeMetrics(text);
            const bulletData = extractBulletPoints(text);
            const keyValueData = extractKeyValuePairs(text);
            const campaignData = extractCampaignPerformance(text);
            const analyticsData = extractAnalyticsOverview(text);
            const channelData = extractChannelPerformance(text);
            const recommendations = extractRecommendations(text);
            
            // Merge all extracted data with conflict resolution
            dashboardData = reconcileData({
                table: tableData,
                narrative: narrativeData,
                bullets: bulletData,
                keyValue: keyValueData,
                campaign: campaignData,
                analytics: analyticsData,
                channel: channelData
            });
            
            // Store recommendations separately
            if (recommendations.length > 0) {
                parserMetadata.recommendations = recommendations;
            }
            
            // Calculate overall confidence
            calculateConfidence();
            
            // Show parsing results with validation
            console.log('========== PARSING COMPLETE ==========');
            console.log('Sections found:', parserMetadata.sectionsFound);
            console.log('Parsed data:', dashboardData);
            console.log('Metadata:', parserMetadata);
            console.log('Total metrics extracted:', Object.keys(dashboardData).length);
            
            // Log conversion actions specifically
            const conversionActions = Object.keys(dashboardData).filter(key => 
                dashboardData[key].isConversionAction === true
            );
            const aggregatedActions = Object.keys(dashboardData).filter(key => 
                dashboardData[key].aggregatedInto
            );
            console.log('Conversion actions found:', conversionActions);
            console.log('Actions aggregated into groups:', aggregatedActions);
            
            // Warn if expected sections are missing
            if (parserMetadata.sectionsFound.length === 0) {
                console.warn('WARNING: No recognized sections found in the input');
            }
            console.log('======================================');
            
            // Aggregate similar conversion actions for cleaner display
            dashboardData = aggregateConversionActions(dashboardData);
            
            updateAllVisualizations();
            // Stay on current tab - don't switch to overview
            // switchTab('overview', document.querySelector('.tab'));
            
            // Update header with period information
            const headerSubtitle = document.getElementById('headerSubtitle');
            if (headerSubtitle && parserMetadata.reportPeriod) {
                const period = parserMetadata.reportPeriod;
                if (period.startDate && period.endDate) {
                    headerSubtitle.textContent = `${period.startDate} – ${period.endDate}`;
                } else if (period.current) {
                    headerSubtitle.textContent = period.current;
                }
            }
            
            // Show the email button and dark mode toggle after successful parsing
            document.getElementById('emailBtn').style.display = 'inline-flex';
            document.getElementById('darkModeToggle').style.display = 'inline-flex';
            
            // Save to history
            saveToHistory();
            
            // Remove parsing animation
            // parseBtn already declared earlier, just reuse it
            if (parseBtn) {
                parseBtn.innerHTML = '<span>✓</span> Parsed Successfully';
                parseBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                setTimeout(() => {
                    parseBtn.innerHTML = '<span>📊</span> Parse & Visualize';
                    parseBtn.style.background = '';
                    parseBtn.classList.remove('parsing');
                }, 2000);
            }
        }
        
        // Restaurant contact mapping
        const restaurantContacts = {
            'Cote Ouest': { names: 'Laurent & Martin', greeting: 'Chef Laurent & Martin' },
            'Turkey and the Wolf': { names: 'Mason', greeting: 'Mason' },
            'Hot Johnnie\'s': { names: 'Johnnie', greeting: 'Johnnie' },
            'Underdogs Tres': { names: 'Doug', greeting: 'Doug' },
            'Underdogs Cantina': { names: 'Doug', greeting: 'Doug' },
            'Underdogs Basketball': { names: 'Doug', greeting: 'Doug' },
            'San Benito House': { names: 'Chris', greeting: 'Chris' },
            'Nisei': { names: 'Chef David & Anna', greeting: 'Chef David & Anna' },
            'John\'s Grill': { names: 'John', greeting: 'John' },
            'Californios': { names: 'Chef Val', greeting: 'Chef Val' },
            'District SJ': { names: 'Jon & Ryan', greeting: 'Jon & Ryan' },
            '3rd Cousin': { names: 'Chef Greg', greeting: 'Chef Greg' },
            'Dacha': { names: 'Suki & Katya', greeting: 'Suki & Katya' },
            'Harborview': { names: 'Karen', greeting: 'Karen' },
            'Indigo': { names: 'Rakesh', greeting: 'Rakesh' },
            'Grubstake Diner': { names: 'Nick & Jimmy', greeting: 'Nick & Jimmy' },
            'Kei': { names: 'Chad and Kei team', greeting: 'Chad and the Kei team' },
            'Hungry Eyes': { names: 'Phil & Mason', greeting: 'Phil & Mason' },
            'Hot Stuff': { names: 'Nate & Mason', greeting: 'Nate & Mason' },
            'Tacko': { names: 'Chris', greeting: 'Chris' },
            'Twelve Oak': { names: 'Not reasonably assumable', greeting: 'Team' },
            'Limoncello': { names: 'Chris', greeting: 'Chris' },
            'New Spot': { names: 'Sam', greeting: 'Sam' },
            'Amarena': { names: 'Paolo', greeting: 'Paolo' },
            'Mr. Magic': { names: 'Brian and Megan', greeting: 'Brian and Megan' },
            'Crepe House': { names: 'Riham', greeting: 'Riham' },
            'EzyDog': { names: 'John and Brady', greeting: 'John and Brady' }
        };
        
        // Extract business name from various patterns
        function extractBusinessName(text) {
            const patterns = [
                /^#\s*([^:]+):/m,  // Match "# Californios: date range" format
                /^([A-Z][A-Za-z\s]+?)\s+Analysis:/m,
                /^([A-Z][A-Za-z\s]+?)(?:\s+Analysis)?:\s*\w+\s+\d+,?\s+\d{4}/m,
                /^([A-Z][A-Za-z\s]+?)\s+Campaign\s+Performance/m,
                /^([A-Z][A-Za-z\s]+?)\s+Google\s+(?:Analytics|Business)/m,
                /([A-Z][A-Za-z\s]+?)\s+\(web\)/
            ];
            
            for (let pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    parserMetadata.businessName = match[1].trim();
                    console.log('Extracted business name:', parserMetadata.businessName);
                    break;
                }
            }
            
            // Fallback: look for repeated capitalized words
            if (!parserMetadata.businessName) {
                const words = text.match(/\b[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*\b/g);
                if (words) {
                    const frequency = {};
                    words.forEach(word => {
                        if (word.length > 3) {
                            frequency[word] = (frequency[word] || 0) + 1;
                        }
                    });
                    const sorted = Object.entries(frequency).sort((a, b) => b[1] - a[1]);
                    if (sorted[0] && sorted[0][1] > 2) {
                        parserMetadata.businessName = sorted[0][0];
                    }
                }
            }
        }
        
        // Extract report period and detect period type
        function extractReportPeriod(text) {
            const patterns = [
                /Analysis:\s*([A-Z][a-z]+\s+\d+,?\s+\d{4})\s*[–—-]\s*([A-Z][a-z]+\s+\d+,?\s+\d{4})/,
                /([A-Z][a-z]+\s+\d+,?\s+\d{4})\s*[–—-]\s*([A-Z][a-z]+\s+\d+,?\s+\d{4})/,
                /Reporting Period:\s*(.+?)(?:\s+vs\.\s+(.+?))?(?:\n|$)/,
                /Period:\s*(.+?)(?:\n|$)/
            ];
            
            for (let pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    const startStr = match[1];
                    const endStr = match[2] || '';
                    
                    // Calculate period length and type
                    let periodType = 'month';
                    let periodLength = 1;
                    let periodLabel = 'this month';
                    
                    if (startStr && endStr) {
                        // Parse dates to determine period length
                        const startDate = new Date(startStr);
                        const endDate = new Date(endStr);
                        const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                        
                        if (daysDiff >= 85 && daysDiff <= 95) {
                            periodType = 'quarter';
                            periodLength = 3;
                            periodLabel = 'this quarter';
                        } else if (daysDiff >= 175 && daysDiff <= 185) {
                            periodType = 'half-year';
                            periodLength = 6;
                            periodLabel = 'the past 6 months';
                        } else if (daysDiff >= 360 && daysDiff <= 370) {
                            periodType = 'year';
                            periodLength = 12;
                            periodLabel = 'this year';
                        } else if (daysDiff >= 55 && daysDiff <= 65) {
                            periodType = 'two-months';
                            periodLength = 2;
                            periodLabel = 'the past 2 months';
                        } else if (daysDiff >= 28 && daysDiff <= 31) {
                            periodType = 'month';
                            periodLength = 1;
                            periodLabel = 'this month';
                        } else {
                            // Custom period
                            periodLength = Math.round(daysDiff / 30);
                            periodLabel = `the past ${periodLength} months`;
                            periodType = 'custom';
                        }
                    }
                    
                    parserMetadata.reportPeriod = {
                        current: match[1],
                        comparison: match[2] || 'Previous Period',
                        startDate: startStr,
                        endDate: endStr,
                        periodType: periodType,
                        periodLength: periodLength,
                        periodLabel: periodLabel
                    };
                    break;
                }
            }
        }
        
        // Extract data from tables (multiple formats)
        function extractTableData(text) {
            const data = {};
            const lines = text.split('\n');
            let inTable = false;
            let headers = [];
            
            lines.forEach(line => {
                // Skip separator lines
                if (line.match(/^[\s\-:|\+]+$/)) return;
                
                // Detect table by presence of | or multiple spaces/tabs
                if (line.includes('|') || line.match(/\s{2,}|\t/)) {
                    const parts = line.split(/\s*\|\s*|\s{2,}|\t+/).filter(p => p.trim());
                    
                    // Check if this is a header row
                    if (parts.some(p => /^(Metric|Value|Change|Y.?Y|M.?M|Notes?|July|Conversion Action|Conversion Volume|% Change)/i.test(p))) {
                        headers = parts.map(h => h.toLowerCase().replace(/[%\s]+/g, '_'));
                        inTable = true;
                    } else if (inTable && parts.length >= 2 && !parts[0].match(/^(Here|Summary|Total costs)/i)) {
                        // Parse data row
                        const metricName = parts[0];
                        const rowData = { name: metricName };
                        
                        // Map values to headers
                        for (let i = 1; i < parts.length && i < headers.length; i++) {
                            const header = headers[i];
                            const value = parts[i];
                            
                            if (header.includes('value') || header.includes('volume') || header.includes('quantity') || header.includes('count')) {
                                rowData.value = parseValue(value);
                            } else if (header.match(/y.?y|year/i)) {
                                rowData.yoy = parseChange(value);
                            } else if (header.match(/m.?m|month/i)) {
                                rowData.mom = parseChange(value);
                            } else if (header.includes('_change') || header === 'change') {
                                rowData.change = parseChange(value);
                            } else if (header.includes('note')) {
                                rowData.note = value;
                            } else if (header.includes('conversion_volume')) {
                                rowData.value = parseValue(value);
                            }
                        }
                        
                        // Store if we got meaningful data
                        if (rowData.value !== null || rowData.yoy !== null || rowData.mom !== null || rowData.change !== null) {
                            data[metricName] = rowData;
                        }
                    }
                } else {
                    inTable = false;
                }
            });
            
            return data;
        }
        
        // Extract Campaign Performance section specifically
        function extractCampaignPerformance(text) {
            const data = {};
            
            // Find Campaign Performance section
            const campaignSection = text.match(/##?\s*Campaign Performance[\s\S]*?(?=##|$)/i);
            if (!campaignSection) return data;
            
            const sectionText = campaignSection[0];
            
            // Extract total cost from this section
            const costMatch = sectionText.match(/Total costs[^:]*:\s*\$([\d,\.]+)/i);
            if (costMatch) {
                data['Total Cost'] = {
                    value: parseFloat(costMatch[1].replace(/,/g, '')),
                    name: 'Total Cost',
                    isAdsCost: true  // Mark as ads cost from Campaign Performance
                };
            }
            
            // Look for conversion action table
            const lines = sectionText.split('\n');
            let inConversionTable = false;
            
            lines.forEach((line, index) => {
                // Check if we're entering a conversion table
                if (line.match(/Conversion Action|Conversion Volume/i)) {
                    inConversionTable = true;
                    return;
                }
                
                // Parse conversion table rows
                if (inConversionTable && line.includes('|')) {
                    const parts = line.split('|').map(p => p.trim()).filter(p => p);
                    
                    // Skip header rows and separator lines
                    if (parts.length >= 2 && 
                        !parts[0].match(/^:?-+:?$/) && 
                        !parts[0].match(/Conversion Action/i)) {
                        
                        const metricName = parts[0];
                        const value = parseValue(parts[1]);
                        const change = parts[2] ? parseChange(parts[2]) : null;
                        
                        if (value !== null) {
                            data[metricName] = {
                                name: metricName,
                                value: value,
                                change: change,
                                isConversionAction: true  // Mark as conversion action from Campaign Performance
                            };
                        }
                    }
                }
                
                // Exit table if we hit a blank line or new section
                if (inConversionTable && (line.trim() === '' || line.match(/^##/))) {
                    inConversionTable = false;
                }
            });
            
            return data;
        }
        
        // Extract metrics from narrative text
        function extractNarrativeMetrics(text) {
            const data = {};
            
            // First check for "Total costs" pattern - multiple variations
            const costPatterns = [
                /Total costs[^:]*:\s*\$([\d,\.]+)/i,
                /Total (?:Google )?Ads (?:Spend|Cost)[^:]*:\s*\$([\d,\.]+)/i,
                /Campaign costs[^:]*:\s*\$([\d,\.]+)/i,
                /Total spend[^:]*:\s*\$([\d,\.]+)/i
            ];
            
            for (const pattern of costPatterns) {
                const costMatch = text.match(pattern);
                if (costMatch) {
                    data['Total Cost'] = {
                        value: parseFloat(costMatch[1].replace(/,/g, '')),
                        name: 'Total Cost'
                    };
                    break;
                }
            }
            
            // Patterns for narrative extraction
            const patterns = [
                // "metric increased/decreased to X (Y%)"
                /(\w[\w\s]+?)\s+(?:increased|decreased|grew|fell|rose|dropped|jumped|climbed|surged)\s+(?:to\s+)?([\d,.$]+[KMB]?)\s*\(([+\-]?\d+\.?\d*%)\)/gi,
                // "metric up/down X%"
                /(\w[\w\s]+?)\s+(?:up|down)\s+([+\-]?\d+\.?\d*%)/gi,
                // "X% increase/decrease in metric"
                /([+\-]?\d+\.?\d*%)\s+(?:increase|decrease|growth|decline)\s+in\s+(\w[\w\s]+?)(?:\.|,|\s|$)/gi,
                // "metric: value (change)"
                /(\w[\w\s]+?):\s*([\d,.$]+[KMB]?)\s*\(([+\-]?\d+\.?\d*%)\)/gi,
                // "metric doubled/tripled"
                /(\w[\w\s]+?)\s+(doubled|tripled|quadrupled)/gi
            ];
            
            patterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    let metricName, value, change;
                    
                    // Handle different capture group orders
                    if (match[1] && match[1].includes('%')) {
                        // Percentage first
                        change = parseChange(match[1]);
                        metricName = normalizeMetricName(match[2]);
                    } else {
                        metricName = normalizeMetricName(match[1]);
                        
                        if (match[2] === 'doubled') {
                            change = 100;
                        } else if (match[2] === 'tripled') {
                            change = 200;
                        } else if (match[2] && match[2].includes('%')) {
                            change = parseChange(match[2]);
                        } else {
                            value = parseValue(match[2]);
                            change = match[3] ? parseChange(match[3]) : null;
                        }
                    }
                    
                    if (metricName && (value !== null || change !== null)) {
                        if (!data[metricName]) {
                            data[metricName] = {};
                        }
                        if (value !== null) data[metricName].value = value;
                        if (change !== null) data[metricName].change = change;
                    }
                }
            });
            
            return data;
        }
        
        // Extract bullet point data
        function extractBulletPoints(text) {
            const data = {};
            const lines = text.split('\n');
            
            lines.forEach(line => {
                // Match various bullet formats
                if (line.match(/^[\s]*[•\-\*▪▸►◆◇○●]\s+/)) {
                    // Try different patterns
                    const patterns = [
                        /[•\-\*▪▸►◆◇○●]\s*([^:]+):\s*([\d,.$]+[KMB]?)\s*\(([^)]+)\)/,
                        /[•\-\*▪▸►◆◇○●]\s*([^:]+):\s*([\d,.$]+[KMB]?)/,
                        /[•\-\*▪▸►◆◇○●]\s*([^:]+)\s+([+\-]?\d+\.?\d*%)/
                    ];
                    
                    for (let pattern of patterns) {
                        const match = line.match(pattern);
                        if (match) {
                            const metricName = normalizeMetricName(match[1]);
                            data[metricName] = {
                                value: parseValue(match[2]),
                                change: match[3] ? parseChange(match[3]) : null
                            };
                            break;
                        }
                    }
                }
            });
            
            return data;
        }
        
        // Extract key-value pairs
        function extractKeyValuePairs(text) {
            const data = {};
            
            // Look for "Total Cost: $X" and similar patterns
            const patterns = [
                /Total\s+(?:cost|spend|investment).*?:\s*\$?([\d,\.]+)/gi,
                /^([A-Za-z][A-Za-z\s]+?):\s*([\d,.$]+[KMB]?)\s*(?:\(([^)]+)\))?$/gm
            ];
            
            patterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    const metricName = match[1].includes('cost') || match[1].includes('spend') ? 
                        'Total Cost' : normalizeMetricName(match[1]);
                    data[metricName] = {
                        value: parseValue(match[2]),
                        change: match[3] ? parseChange(match[3]) : null
                    };
                }
            });
            
            return data;
        }
        
        // Extract Analytics Overview section
        function extractAnalyticsOverview(text) {
            const data = {};
            
            // Find Analytics Overview section
            const analyticsSection = text.match(/##?\s*Analytics\s*Overview[\s\S]*?(?=##|$)/i);
            if (!analyticsSection) {
                console.log('No Analytics Overview section found');
                return data;
            }
            
            parserMetadata.sectionsFound.push('Analytics Overview');
            const sectionText = analyticsSection[0];
            
            // Parse table format
            const lines = sectionText.split('\n');
            lines.forEach(line => {
                // Match table rows like: | Active Users | 5,000 | -23% |
                const match = line.match(/\|\s*([^|]+)\s*\|\s*([\d,\.KkMm]+)\s*\|\s*([+-]?\d+\.?\d*%?)/i);
                if (match) {
                    const metric = match[1].trim();
                    const value = match[2].trim();
                    const change = match[3].trim();
                    
                    // Map to standard names
                    const metricMap = {
                        'Active Users': 'Active users',
                        'New Users': 'New users',
                        'Returning Users': 'Returning users',
                        'Sessions': 'Sessions',
                        'Pages per Session': 'Pages per Session',
                        'Conversion Rate': 'Conversion Rate',
                        'Bounce Rate': 'Bounce Rate',
                        'Average Session Duration': 'Average Session Duration'
                    };
                    
                    const standardName = metricMap[metric] || metric;
                    
                    data[standardName] = {
                        value: parseValueWithUnits(value),
                        change: parseFloat(change.replace('%', '')) || 0,
                        name: standardName
                    };
                }
            });
            
            console.log('Analytics data extracted:', data);
            return data;
        }
        
        // Extract Channel Performance section
        function extractChannelPerformance(text) {
            const data = {};
            let googleAdsTotal = { value: 0, sessions: 0, changes: [], name: 'Google Ads', isChannel: true };
            
            // Find Channel Performance section
            const channelSection = text.match(/##?\s*Channel\s*Performance[\s\S]*?(?=##|$)/i);
            if (!channelSection) {
                console.log('No Channel Performance section found');
                return data;
            }
            
            parserMetadata.sectionsFound.push('Channel Performance');
            const sectionText = channelSection[0];
            
            // Parse table format
            const lines = sectionText.split('\n');
            lines.forEach(line => {
                // Match table rows like: | Organic Search | 1,634 | +23% |
                const match = line.match(/\|\s*([^|]+)\s*\|\s*([\d,\.KkMm]+)\s*\|\s*([+-]?\d+\.?\d*%?|[–—-]+)/i);
                if (match) {
                    const channel = match[1].trim();
                    const sessions = match[2].trim();
                    const change = match[3].trim();
                    
                    const sessionValue = parseValueWithUnits(sessions);
                    const changeValue = change === '–' || change === '—' ? 0 : parseFloat(change.replace('%', '')) || 0;
                    
                    // Combine Paid Search and Cross-network into Google Ads
                    if (channel === 'Paid Search' || channel === 'Cross-network') {
                        googleAdsTotal.value += sessionValue;
                        googleAdsTotal.sessions += sessionValue;
                        googleAdsTotal.changes.push({ value: sessionValue, change: changeValue });
                    } else {
                        const channelData = {
                            value: sessionValue,
                            sessions: sessionValue,
                            change: changeValue,
                            name: channel,
                            isChannel: true,
                            yoy: changeValue
                        };
                        
                        // Store with multiple keys for better matching
                        data[channel] = channelData;
                        data[`${channel} sessions`] = channelData;
                        data[`${channel} users`] = channelData;
                        
                        // Also store with lowercase and underscore versions
                        const lowerKey = channel.toLowerCase().replace(/\s+/g, '_');
                        data[lowerKey] = channelData;
                        
                        // Special handling for common variations
                        if (channel === 'Organic Search') {
                            data['Organic'] = channelData;
                            data['organic'] = channelData;
                            data['organic_search'] = channelData;
                        }
                    }
                }
            });
            
            // Add combined Google Ads data if we found Paid Search or Cross-network
            if (googleAdsTotal.value > 0) {
                // Calculate weighted average change
                let totalWeight = 0;
                let weightedChange = 0;
                googleAdsTotal.changes.forEach(item => {
                    totalWeight += item.value;
                    weightedChange += item.value * item.change;
                });
                googleAdsTotal.change = totalWeight > 0 ? weightedChange / totalWeight : 0;
                googleAdsTotal.yoy = googleAdsTotal.change;
                
                // Store Google Ads with multiple keys
                data['Google Ads'] = googleAdsTotal;
                data['Google Ads sessions'] = googleAdsTotal;
                data['Google Ads users'] = googleAdsTotal;
                data['google_ads'] = googleAdsTotal;
                data['Paid Search'] = googleAdsTotal;
                data['paid_search'] = googleAdsTotal;
                data['Cross-network'] = googleAdsTotal;
                data['cross_network'] = googleAdsTotal;
            }
            
            console.log('Channel data extracted:', data);
            return data;
        }
        
        // Helper function to parse values with K/M units
        function parseValueWithUnits(value) {
            if (!value) return 0;
            const str = value.toString().replace(/,/g, '');
            
            if (str.match(/[Kk]$/)) {
                return parseFloat(str) * 1000;
            } else if (str.match(/[Mm]$/)) {
                return parseFloat(str) * 1000000;
            } else {
                return parseFloat(str) || 0;
            }
        }
        
        // Extract recommendations
        function extractRecommendations(text) {
            const recommendations = [];
            const lines = text.split('\n');
            
            let inRecommendations = false;
            lines.forEach(line => {
                // Detect recommendation sections
                if (line.match(/Recommendation|Action|Next Step|Improvement/i)) {
                    inRecommendations = true;
                }
                
                // Extract numbered recommendations
                const numberedMatch = line.match(/^\d+\.\s*(.+)/);
                if (numberedMatch && inRecommendations) {
                    recommendations.push(numberedMatch[1]);
                }
                
                // Extract action items
                const actionMatch = line.match(/^Action:\s*(.+)/i);
                if (actionMatch) {
                    recommendations.push(actionMatch[1]);
                }
            });
            
            return recommendations;
        }
        
        // Normalize metric names for consistency
        function normalizeMetricName(name) {
            if (!name) return name;
            
            // Remove extra spaces and trim
            name = name.replace(/\s+/g, ' ').trim();
            
            // Map common variations to standard names
            const mappings = {
                'calls': 'Phone Calls',
                'phone': 'Phone Calls',
                'phone calls': 'Phone Calls',
                'calls from ads': 'Phone Calls',
                'clicks to call': 'Phone Calls',
                'click to call': 'Phone Calls',
                'clicks': 'Website Clicks',
                'website clicks': 'Website Clicks',
                'web clicks': 'Website Clicks',
                'directions': 'Directions Requests',
                'directions requests': 'Directions Requests',
                'direction requests': 'Directions Requests',
                'views': 'Total Views',
                'total views': 'Total Views',
                'impressions': 'Total Views',
                'active users': 'Active Users',
                'users': 'Active Users',
                'new users': 'New Users',
                'page views': 'Page Views',
                'pageviews': 'Page Views',
                'pages per session': 'Pages per Session',
                'average session duration': 'Average Session Duration',
                'avg. session duration': 'Average Session Duration',
                'average engagement time': 'Average Session Duration',
                'avg engagement time per user': 'Average Session Duration',
                'bounce rate': 'Bounce Rate',
                'sessions': 'Sessions',
                'reservation': 'Reservations',
                'reservation_button_click': 'Reservations Button',
                'cote ouest (web) reservation_button_click': 'Reservations Button',
                'booking': 'Reservations',
                'total actions': 'Total Actions',
                'total actions (gmb)': 'Total Actions',
                'local actions - directions': 'Local Actions - Directions',
                'clicks to call': 'Clicks to call'
            };
            
            const lower = name.toLowerCase();
            return mappings[lower] || name;
        }
        
        // List of non-US countries to exclude from insights
        const nonUSCountries = [
            'Australia', 'Austria', 'Belgium', 'Brazil', 'Canada', 'China', 'Denmark',
            'Finland', 'France', 'Germany', 'Greece', 'India', 'Ireland', 'Italy',
            'Japan', 'Mexico', 'Netherlands', 'Norway', 'Poland', 'Portugal', 'Russia',
            'Singapore', 'South Korea', 'Spain', 'Sweden', 'Switzerland', 'UK',
            'United Kingdom', 'Argentina', 'Chile', 'Colombia', 'Egypt', 'Hong Kong',
            'Indonesia', 'Israel', 'Malaysia', 'New Zealand', 'Philippines', 'Saudi Arabia',
            'South Africa', 'Taiwan', 'Thailand', 'Turkey', 'UAE', 'United Arab Emirates',
            'Vietnam', 'International', 'Global', 'Worldwide', 'Foreign', 'Overseas'
        ];
        
        // Check if a metric contains non-US country references
        function containsNonUSCountry(text) {
            if (!text) return false;
            const textLower = text.toLowerCase();
            return nonUSCountries.some(country => 
                textLower.includes(country.toLowerCase())
            );
        }
        
        // Get client-friendly display name for conversion actions and metrics
        function getDisplayName(metricName) {
            if (!metricName) return metricName;
            
            // Skip any metrics with non-US country names
            if (containsNonUSCountry(metricName)) {
                return null; // Return null to signal this metric should be excluded
            }
            
            // First, extract campaign source if in parentheses
            let baseName = metricName;
            let campaignSource = '';
            const parenMatch = metricName.match(/^(.+?)\s*\(([^)]+)\)$/);
            if (parenMatch) {
                baseName = parenMatch[1].trim();
                campaignSource = parenMatch[2].trim();
            }
            
            // Static mappings for common conversions
            const displayMappings = {
                // Phone related - Google Ads conversions (keep separate from GBP Phone Calls)
                'mobile_number': 'Phone Calls (Ads)',
                'mobile number': 'Phone Calls (Ads)',
                'phone_number': 'Phone Calls (Ads)',
                'phone number': 'Phone Calls (Ads)',
                'Clicks to call': 'Phone Calls (Ads)',
                'Click-to-Call': 'Phone Calls (Ads)',
                'click_to_call': 'Phone Calls (Ads)',
                'clicks_to_call': 'Phone Calls (Ads)',
                'Calls from ads': 'Phone Calls (Ads)',
                'calls_from_ads': 'Phone Calls (Ads)',
                'Website Phone Call': 'Phone Calls (Ads)',
                'website_phone_call': 'Phone Calls (Ads)',
                'Click_Call': 'Phone Calls (Ads)',
                'click_call': 'Phone Calls (Ads)',
                // Special case: keep aggregated name clean
                'Phone Calls (Ads)': 'Phone Calls (Ads)',
                
                // Reservations and bookings
                'book_reservation': 'Reservations',
                'book reservation': 'Reservations',
                'book_reservations': 'Reservations',
                'booking': 'Reservations',
                'bookings': 'Reservations',
                'reservation_button_click': 'Reservations',
                'Reservations Button': 'Reservations',
                'reservations_button': 'Reservations',
                'table_booking': 'Reservations',
                'table booking': 'Reservations',
                
                // Inquiries
                'Inquire Now': 'Customer Inquiries',
                'inquire_now': 'Customer Inquiries',
                'inquiry': 'Customer Inquiries',
                'inquiries': 'Customer Inquiries',
                'request_info': 'Information Requests',
                'request info': 'Information Requests',
                
                // Restaurant visits
                'Restaurant visits': 'Restaurant Visits',
                'restaurant_visits': 'Restaurant Visits',
                'Store visits': 'Restaurant Visits',
                'store_visits': 'Restaurant Visits',
                'Store Visits': 'Restaurant Visits',
                'location_visits': 'Restaurant Visits',
                
                // Direction and location related
                'Local Actions - Directions': 'Direction Requests',
                'Local actions – Directions': 'Direction Requests',
                'local_actions_directions': 'Direction Requests',
                'get_directions': 'Direction Requests',
                'directions': 'Direction Requests',
                
                // Forms and contact
                'Contact Us': 'Contact Form',
                'contact_us': 'Contact Form',
                'Contact us submissions': 'Contact Form',
                'contact_us_submissions': 'Contact Form',
                'contact_form': 'Contact Form',
                'Form fill outs': 'Form Submissions',
                'form_fill_outs': 'Form Submissions',
                'form_fill': 'Form Submissions',
                'form_submit': 'Form Submissions',
                
                // Events and catering
                'Private events': 'Private Events',
                'private_events': 'Private Events',
                'Private event submissions': 'Private Events',
                'private_event_submissions': 'Private Events',
                'private_event_form': 'Private Events',
                'Catering': 'Catering Requests',
                'catering': 'Catering Requests',
                'catering_request': 'Catering Requests',
                'catering_form': 'Catering Requests',
                
                // Commerce
                'Gift cards': 'Gift Cards',
                'gift_cards': 'Gift Cards',
                'gift_card': 'Gift Cards',
                'Online Orders': 'Online Orders',
                'online_orders': 'Online Orders',
                'online_order': 'Online Orders',
                'order_online': 'Online Orders',
                'takeout': 'Takeout Orders',
                'takeout_order': 'Takeout Orders',
                'delivery': 'Delivery Orders',
                'delivery_order': 'Delivery Orders',
                
                // Newsletter and email
                'newsletter': 'Newsletter Signups',
                'newsletter_signup': 'Newsletter Signups',
                'email_signup': 'Email Signups',
                'email_list': 'Email Signups',
                
                // Aggregate metrics
                'Total Actions': 'Total Customer Actions',
                'total_actions': 'Total Customer Actions',
                'Total Actions (GMB)': 'Total Customer Actions'
            };
            
            // Check if we have a direct mapping
            let displayName = displayMappings[baseName];
            
            // If no direct mapping, apply intelligent transformations
            if (!displayName) {
                displayName = baseName
                    // Convert snake_case to spaces
                    .replace(/_/g, ' ')
                    // Convert camelCase to spaces
                    .replace(/([a-z])([A-Z])/g, '$1 $2')
                    // Capitalize each word
                    .replace(/\b\w/g, l => l.toUpperCase())
                    // Clean up common patterns
                    .replace(/\bBtn\b/gi, 'Button')
                    .replace(/\bCta\b/gi, 'CTA')
                    .replace(/\bGmb\b/gi, 'GMB')
                    .replace(/\bGbp\b/gi, 'GBP')
                    .replace(/\bPpc\b/gi, 'PPC')
                    .replace(/\bSeo\b/gi, 'SEO')
                    .replace(/\bRoas\b/gi, 'ROAS')
                    .replace(/\bCpc\b/gi, 'CPC')
                    .replace(/\bCtr\b/gi, 'CTR')
                    .replace(/\bUrl\b/gi, 'URL')
                    // Remove redundant words
                    .replace(/\s+Click$/i, '')
                    .replace(/\s+Button$/i, '')
                    .replace(/\s+Form$/i, ' Form')
                    .replace(/\s+Submit$/i, '')
                    .replace(/\s+Submission$/i, '')
                    // Fix spacing
                    .replace(/\s+/g, ' ')
                    .trim();
            }
            
            // Add campaign source back if relevant and not redundant
            if (campaignSource && 
                !displayName.toLowerCase().includes(campaignSource.toLowerCase()) &&
                !['Search', 'Display', 'Shopping', 'Video', 'Discovery'].includes(campaignSource)) {
                // For specific campaign types that add context
                if (campaignSource === 'Reservations' && !displayName.includes('Reservations')) {
                    displayName = displayName + ' (Table Service)';
                } else if (campaignSource === 'Search' && displayName === 'Phone Calls') {
                    // Don't add source for phone calls, they're all combined
                    displayName = 'Phone Calls';
                } else if (['Takeout', 'Delivery', 'Catering'].includes(campaignSource)) {
                    displayName = displayName + ' (' + campaignSource + ')';
                }
            }
            
            return displayName;
        }
        
        // Group similar conversion actions together
        function aggregateConversionActions(dashboardData) {
            const aggregated = {};
            // IMPORTANT: Never combine metrics across different sources:
            // - GBP metrics (Phone Calls, Website Clicks, etc.) stay separate
            // - GA4 metrics (Sessions, Engaged Sessions, etc.) stay separate  
            // - Google Ads conversion actions can be grouped with each other ONLY
            const groups = {
                'Phone Calls (Ads)': ['mobile_number', 'phone_number', 'clicks_to_call', 'calls_from_ads', 'website_phone_call', 'call_from_ad'],
                'Reservations': ['book_reservation', 'booking', 'reservation_button', 'table_booking'],
                'Restaurant Visits': ['restaurant_visits', 'store_visits', 'location_visits'],
                'Customer Inquiries': ['inquire_now', 'inquiry', 'request_info', 'contact_us'],
                'Online Orders': ['online_order', 'order_online', 'takeout', 'delivery']
            };
            
            // Define which metrics are from which source to prevent cross-pollination
            const gbpMetrics = ['Phone Calls', 'Website Clicks', 'Directions Requests', 'Total Views', 
                               'Reviews Count', 'Rating', 'Total Actions'];
            const ga4Metrics = ['Sessions', 'Engaged Sessions', 'New Users', 'Users', 'Engagement Rate',
                               'Average Engagement Time', 'Conversions', 'Revenue'];
            
            // Copy all data first
            Object.keys(dashboardData).forEach(key => {
                aggregated[key] = dashboardData[key];
            });
            
            // Aggregate groups (only for Google Ads conversion actions, never mixing sources)
            Object.entries(groups).forEach(([groupName, patterns]) => {
                let totalValue = 0;
                let totalChange = 0;
                let changeCount = 0;
                let hasData = false;
                
                Object.keys(dashboardData).forEach(metric => {
                    // Skip if this is a GBP metric
                    if (gbpMetrics.includes(metric)) {
                        return; // Never aggregate GBP metrics
                    }
                    
                    // Skip if this is a GA4 metric
                    if (ga4Metrics.includes(metric)) {
                        return; // Never aggregate GA4 metrics
                    }
                    
                    // Only aggregate Google Ads conversion actions
                    if (!dashboardData[metric].isConversionAction) {
                        return;
                    }
                    
                    const metricLower = metric.toLowerCase().replace(/[^a-z0-9]/g, '_');
                    const isMatch = patterns.some(pattern => 
                        metricLower.includes(pattern) || 
                        metric.toLowerCase().includes(pattern)
                    );
                    
                    if (isMatch && dashboardData[metric].value) {
                        totalValue += dashboardData[metric].value;
                        if (dashboardData[metric].yoy || dashboardData[metric].mom || dashboardData[metric].change) {
                            totalChange += dashboardData[metric].yoy || dashboardData[metric].mom || dashboardData[metric].change;
                            changeCount++;
                        }
                        hasData = true;
                        
                        // Mark original as aggregated
                        if (aggregated[metric]) {
                            aggregated[metric].aggregatedInto = groupName;
                        }
                    }
                });
                
                // Add aggregated metric if we found data
                if (hasData && totalValue > 0) {
                    aggregated[groupName] = {
                        value: totalValue,
                        yoy: changeCount > 0 ? totalChange / changeCount : null,
                        isAggregated: true,
                        isConversionAction: true
                    };
                }
            });
            
            return aggregated;
        }
        
        // Reconcile data from multiple sources
        function reconcileData(sources) {
            const reconciled = {};
            const allMetrics = new Set();
            
            // Collect all metric names
            Object.values(sources).forEach(source => {
                Object.keys(source).forEach(metric => allMetrics.add(metric));
            });
            
            // For each metric, reconcile values
            allMetrics.forEach(metric => {
                // Skip metrics with non-US country names
                if (containsNonUSCountry(metric)) {
                    return; // Skip this metric entirely
                }
                
                const values = [];
                
                // Collect values from each source
                Object.entries(sources).forEach(([sourceName, data]) => {
                    if (data[metric]) {
                        values.push({
                            source: sourceName,
                            data: data[metric]
                        });
                    }
                });
                
                if (values.length === 0) return;
                
                // Priority: campaign > table > keyValue > bullets > narrative
                const priority = { campaign: 5, table: 4, keyValue: 3, bullets: 2, narrative: 1 };
                values.sort((a, b) => priority[b.source] - priority[a.source]);
                
                // Use highest priority source
                reconciled[metric] = values[0].data;
                
                // Add confidence based on agreement
                if (values.length > 1) {
                    reconciled[metric].confidence = calculateAgreement(values);
                } else {
                    reconciled[metric].confidence = 0.8; // Single source
                }
            });
            
            return reconciled;
        }
        
        // Calculate confidence score
        function calculateConfidence() {
            let totalConfidence = 0;
            let count = 0;
            
            Object.values(dashboardData).forEach(metric => {
                if (metric.confidence) {
                    totalConfidence += metric.confidence;
                    count++;
                }
            });
            
            parserMetadata.confidence.overall = count > 0 ? totalConfidence / count : 0.5;
            
            // Add warnings for low confidence
            if (parserMetadata.confidence.overall < 0.7) {
                parserMetadata.warnings.push('Some metrics have low confidence. Please review the parsed data.');
            }
        }
        
        // Calculate agreement between sources
        function calculateAgreement(values) {
            if (values.length === 1) return 1.0;
            
            // Check if values agree
            const firstValue = values[0].data.value;
            const agree = values.every(v => 
                Math.abs((v.data.value || 0) - (firstValue || 0)) < 0.01
            );
            
            return agree ? 0.95 : 0.6;
        }
        
        function parseValue(str) {
            if (!str) return null;
            str = str.replace(/[$,]/g, '');
            
            if (str.includes('K')) return parseFloat(str.replace('K', '')) * 1000;
            if (str.includes('M')) return parseFloat(str.replace('M', '')) * 1000000;
            
            const num = parseFloat(str);
            return isNaN(num) ? null : num;
        }
        
        function parseChange(str) {
            if (!str) return null;
            const match = str.match(/([+\-]?\d+\.?\d*)%?/);
            return match ? parseFloat(match[1]) : null;
        }
        
        // ===================================
        // UNIFIED NUMBER FORMATTING SYSTEM
        // ===================================

        // Main formatter - routes to specific formatters based on context
        function formatValue(value, context = 'default') {
            if (value === null || value === undefined || value === '—' || value === '') return '—';

            // Handle special values
            const special = formatSpecialValue(value);
            if (special !== null) return special;

            // Route to appropriate formatter
            switch(context) {
                case 'currency':
                    return formatCurrency(value);
                case 'percentage':
                    return formatPercentage(value);
                case 'rating':
                    return formatRating(value);
                case 'time':
                    return formatTime(value);
                default:
                    return formatNumber(value);
            }
        }

        // Format regular numbers with K/M notation
        function formatNumber(num) {
            if (num === null || num === undefined) return '—';

            const absNum = Math.abs(num);

            // Billions (rare for restaurants)
            if (absNum >= 1_000_000_000) {
                return (num / 1_000_000_000).toFixed(1).replace(/\.0$/, '') + 'B';
            }

            // Millions
            if (absNum >= 1_000_000) {
                return (num / 1_000_000).toFixed(1).replace(/\.0$/, '') + 'M';
            }

            // Thousands - show 1 decimal for 1K-9.9K, whole numbers for 10K+
            if (absNum >= 1_000) {
                const thousands = num / 1_000;

                if (absNum < 10_000) {
                    // 1.0K to 9.9K - show decimal if meaningful
                    return thousands.toFixed(1).replace(/\.0$/, '') + 'K';
                } else {
                    // 10K+ - whole numbers only
                    return Math.round(thousands) + 'K';
                }
            }

            // Under 1,000 - always whole numbers
            return Math.round(num).toLocaleString('en-US');
        }

        // Format percentages with smart rounding
        function formatPercentage(num, includeSign = true) {
            if (num === null || num === undefined || isNaN(num)) return '—';
            if (num === Infinity) return includeSign ? '+∞%' : '∞%';

            const absNum = Math.abs(num);
            const sign = includeSign && num > 0 ? '+' : '';

            // Rounding rules for percentages
            if (absNum >= 10) {
                // 10%+ → whole numbers (e.g., +186%, -53%)
                return `${sign}${Math.round(num)}%`;
            } else {
                // Under 10% → 1 decimal (e.g., +4.4%, -2.5%, +0.3%)
                return `${sign}${num.toFixed(1)}%`;
            }
        }

        // Format currency values
        function formatCurrency(num) {
            if (num === null || num === undefined || isNaN(num)) return '—';

            const absNum = Math.abs(num);

            // $1M+
            if (absNum >= 1_000_000) {
                return '$' + (num / 1_000_000).toFixed(1).replace(/\.0$/, '') + 'M';
            }

            // $1K to $999K
            if (absNum >= 1_000) {
                if (absNum < 10_000) {
                    return '$' + (num / 1_000).toFixed(1).replace(/\.0$/, '') + 'K';
                } else {
                    return '$' + Math.round(num / 1_000) + 'K';
                }
            }

            // $100 to $999 - whole dollars
            if (absNum >= 100) {
                return '$' + Math.round(num).toLocaleString('en-US');
            }

            // Under $100 - show cents if present
            return '$' + num.toFixed(num % 1 === 0 ? 0 : 2);
        }

        // Format rating values
        function formatRating(num) {
            if (num === null || num === undefined || isNaN(num)) return '—';
            // Always show 1 decimal for ratings
            return num.toFixed(1);
        }

        // Format time/duration values
        function formatTime(seconds) {
            if (seconds === null || seconds === undefined || isNaN(seconds)) return '—';

            if (seconds >= 3600) {
                // Hours
                const hours = Math.floor(seconds / 3600);
                const mins = Math.round((seconds % 3600) / 60);
                return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
            } else if (seconds >= 60) {
                // Minutes and seconds
                const mins = Math.floor(seconds / 60);
                const secs = Math.round(seconds % 60);
                return secs > 0 ? `${mins}:${secs.toString().padStart(2, '0')}` : `${mins}m`;
            } else {
                // Seconds only
                return Math.round(seconds) + 's';
            }
        }

        // Format change values with context
        function formatChange(changeValue, changeType = 'yoy') {
            if (changeValue === null || changeValue === undefined || isNaN(changeValue)) return '—';

            const formatted = formatPercentage(changeValue, true);
            const label = changeType === 'yoy' ? 'Y/Y' :
                          changeType === 'mom' ? 'M/M' : '';

            return label ? `${formatted} ${label}` : formatted;
        }

        // Handle special value strings
        function formatSpecialValue(value) {
            if (value === null || value === undefined) return null;
            if (value === '' || value === '—' || value === 'N/A') return '—';
            if (value === Infinity || value === '∞') return '∞';
            if (typeof value === 'string' && value.toLowerCase() === 'new') return 'New';
            return null; // Not a special value
        }

        // Parse and normalize input values (for parsing raw data)
        function parseAndNormalizeValue(rawValue) {
            if (!rawValue) return null;

            const special = formatSpecialValue(rawValue);
            if (special !== null) return { value: null, display: special, isEmpty: special === '—' };

            // Remove formatting
            let cleaned = rawValue.toString()
                .replace(/,/g, '')           // Remove commas
                .replace(/\$/g, '')          // Remove dollar signs
                .replace(/K/gi, '000')       // Convert K to 000
                .replace(/M/gi, '000000')    // Convert M to 000000
                .replace(/%/g, '')           // Remove percent sign
                .replace(/\+/g, '');         // Remove plus sign

            const num = parseFloat(cleaned);

            if (isNaN(num)) return null;

            return { value: num, display: null, isEmpty: false };
        }

        // Legacy compatibility wrapper
        function formatPercentageChange(value) {
            return formatPercentage(value, true);
        }
        
        function updateAllVisualizations() {
            updateKPICards();
            updateMetricsChart(); // Safe with null check
            updateComparisonTable(); // Safe with null check
            updateGBPSection();
            updateAnalyticsSection();
            updateAdsSection();
            updateOverviewSections(); // New overview sections
        }
        
        function updateKPICards() {
            const grid = document.getElementById('kpiGrid');
            grid.innerHTML = '';
            grid.className = 'kpi-grid'; // Reset classes
            
            // Start with priority metrics
            const kpiPriority = ['Total Views', 'Phone Calls', 'Website Clicks', 'Directions Requests'];
            
            // Add any reservation or visit-related metrics from Google Ads
            Object.keys(dashboardData).forEach(metric => {
                const lowerMetric = metric.toLowerCase();
                if ((lowerMetric.includes('reservation') || 
                     lowerMetric.includes('store visit') || 
                     lowerMetric.includes('restaurant visit')) &&
                    !kpiPriority.includes(metric)) {
                    kpiPriority.push(metric);
                }
            });
            
            // Calculate total Google Ads phone calls
            let totalAdsPhoneCalls = 0;
            let hasAdsPhoneCalls = false;
            Object.keys(dashboardData).forEach(metric => {
                const lowerMetric = metric.toLowerCase();
                // Look for Google Ads call metrics (exclude main "Phone Calls" which is from GBP)
                if (lowerMetric.includes('call') && 
                    metric !== 'Phone Calls' && 
                    (lowerMetric.includes('click') || lowerMetric.includes('website') || lowerMetric.includes('ad'))) {
                    totalAdsPhoneCalls += dashboardData[metric].value || 0;
                    hasAdsPhoneCalls = true;
                }
            });
            
            // Add the aggregated phone calls metric if we found any
            if (hasAdsPhoneCalls) {
                dashboardData['_AdsPhoneCalls'] = {
                    value: totalAdsPhoneCalls,
                    // You could calculate weighted average of changes here if needed
                };
                kpiPriority.push('_AdsPhoneCalls');
            }
            
            // Always try to display exactly 6 KPI cards
            // If we have less than 6, add placeholders
            while (kpiPriority.length < 6) {
                // Try to find more metrics to add
                const additionalMetrics = Object.keys(dashboardData).filter(m => 
                    !kpiPriority.includes(m) && 
                    dashboardData[m].value
                );
                if (additionalMetrics.length > 0) {
                    kpiPriority.push(additionalMetrics[0]);
                } else {
                    break; // No more metrics available
                }
            }
            
            // Count how many cards we'll actually display
            const cardsToDisplay = kpiPriority.slice(0, 6).filter(m => dashboardData[m]);
            
            // Add special class if we have exactly 6 cards
            if (cardsToDisplay.length === 6) {
                grid.className = 'kpi-grid six-cards';
            }
            
            // Display up to 6 KPI cards
            cardsToDisplay.forEach((metric, index) => {
                if (dashboardData[metric]) {
                    const data = dashboardData[metric];
                    const card = document.createElement('div');
                    card.className = 'kpi-card';
                    
                    // Format the label - if it's a Google Ads conversion, specify the source
                    let displayLabel = metric;
                    const lowerMetric = metric.toLowerCase();
                    if (metric === '_AdsPhoneCalls') {
                        displayLabel = 'Phone Calls (Google Ads)';
                    } else if (lowerMetric.includes('reservation') && lowerMetric.includes('button')) {
                        displayLabel = 'Reservations (Google Ads)';
                    } else if (lowerMetric.includes('store visit')) {
                        displayLabel = 'Store Visits (Google Ads)';
                    } else if (lowerMetric.includes('restaurant visit')) {
                        displayLabel = 'Restaurant Visits (Google Ads)';
                    }
                    
                    
                    const changes = [];
                    if (data.yoy) {
                        changes.push(`
                            <div>
                                <div class="kpi-change ${data.yoy >= 0 ? 'positive' : 'negative'}">
                                    ${data.yoy >= 0 ? '↑' : '↓'} ${Math.abs(data.yoy).toFixed(1)}% YoY
                                </div>
                                <div class="kpi-period">${parserMetadata.reportPeriod?.periodType === 'quarter' ? 'vs same quarter last year' : 
                                                        parserMetadata.reportPeriod?.periodType === 'year' ? 'vs previous year' :
                                                        'vs last year'}</div>
                            </div>
                        `);
                    }
                    if (data.mom) {
                        changes.push(`
                            <div>
                                <div class="kpi-change ${data.mom >= 0 ? 'positive' : 'negative'}">
                                    ${data.mom >= 0 ? '↑' : '↓'} ${Math.abs(data.mom).toFixed(1)}% MoM
                                </div>
                                <div class="kpi-period">${parserMetadata.reportPeriod?.periodType === 'quarter' ? 'vs last quarter' : 
                                                        parserMetadata.reportPeriod?.periodType === 'year' ? 'vs last year' :
                                                        parserMetadata.reportPeriod?.periodLength > 1 ? `vs previous ${parserMetadata.reportPeriod.periodLength} months` :
                                                        'vs last month'}</div>
                            </div>
                        `);
                    }
                    
                    card.innerHTML = `
                        <div class="kpi-header">
                            <div class="kpi-label">${displayLabel}</div>
                        </div>
                        <div class="kpi-value">${formatValue(data.value)}</div>
                        <div class="kpi-comparison">${changes.join('')}</div>
                    `;
                    grid.appendChild(card);
                }
            });
        }
        
        function updateMetricsChart() {
            const chart = document.getElementById('metricsChart');
            if (!chart) return; // Exit if element doesn't exist
            chart.innerHTML = '';
            
            // Use logarithmic scale for better visualization of different magnitudes
            Object.keys(dashboardData)
                .filter(metric => !containsNonUSCountry(metric)) // Exclude non-US country metrics
                .slice(0, 8)
                .forEach(metric => {
                const data = dashboardData[metric];
                
                // Calculate bar width using log scale for better relative comparison
                let barWidth = 5; // minimum width
                if (data.value > 0) {
                    // Use log scale to compress large values
                    const logValue = Math.log10(data.value + 1);
                    const maxLogValue = Math.log10(100000); // Set reasonable max for scaling
                    barWidth = Math.max(5, Math.min(95, (logValue / maxLogValue) * 100));
                }
                
                const change = data.yoy || data.mom || data.change;
                const changeClass = change >= 0 ? 'positive' : 'negative';
                
                const row = document.createElement('div');
                row.className = 'metric-bar-row';
                row.innerHTML = `
                    <div class="metric-bar-label">${metric}</div>
                    <div class="metric-bar-container">
                        <div class="metric-bar-fill" style="width: ${barWidth}%;">
                            <span class="metric-bar-value">${formatValue(data.value)}</span>
                        </div>
                    </div>
                    <div class="metric-bar-change ${changeClass}">
                        ${change ? `${change >= 0 ? '↑' : '↓'} ${Math.abs(change).toFixed(1)}%` : '—'}
                    </div>
                `;
                chart.appendChild(row);
            });
        }
        
        function updateComparisonTable() {
            const tbody = document.getElementById('comparisonTable');
            if (!tbody) return; // Exit if element doesn't exist
            tbody.innerHTML = '';
            
            Object.keys(dashboardData)
                .filter(metric => !containsNonUSCountry(metric)) // Exclude non-US country metrics
                .forEach(metric => {
                const data = dashboardData[metric];
                const change = data.yoy || data.mom || data.change;
                const previousValue = data.value && change ? 
                    data.value / (1 + change/100) : null;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${metric}</strong></td>
                    <td>${formatValue(data.value)}</td>
                    <td>${previousValue ? formatValue(previousValue) : '—'}</td>
                    <td>${change ? `<span class="metric-badge ${change >= 0 ? 'up' : 'down'}">${change >= 0 ? '+' : ''}${change.toFixed(1)}%</span>` : '—'}</td>
                    <td>${change ? (change >= 0 ? '✅' : '⚠️') : '—'}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Create GBP Year-over-Year Bar Chart
        function createGBPYoyChart() {
            const chartContainer = document.getElementById('gbpYoyChart');
            if (!chartContainer) return;
            
            // Get GBP metrics with YoY data
            const metrics = [
                { name: 'Total Views', key: 'Total Views' },
                { name: 'Website Clicks', key: 'Website Clicks' },
                { name: 'Phone Calls', key: 'Phone Calls' },
                { name: 'Directions', key: 'Directions Requests' }
            ];
            
            // Prepare data for visualization with indexed values
            const chartData = [];
            metrics.forEach(metric => {
                const data = dashboardData[metric.key];
                if (data && data.value) {
                    const currentValue = data.value;
                    const yoyChange = data.yoy || data.change || 0;
                    
                    // Calculate previous year value
                    const previousValue = yoyChange !== 0 ? 
                        currentValue / (1 + yoyChange / 100) : 
                        currentValue;
                    
                    // Calculate index (previous year = 100)
                    const previousIndex = 100;
                    const currentIndex = previousValue > 0 ? (currentValue / previousValue) * 100 : 100;
                    
                    chartData.push({
                        name: metric.name,
                        current: currentValue,
                        previous: Math.round(previousValue),
                        currentIndex: currentIndex,
                        previousIndex: previousIndex,
                        change: yoyChange
                    });
                }
            });
            
            if (chartData.length === 0) {
                chartContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">No year-over-year data available</div>';
                return;
            }
            
            // Use indexed scale (0-200 for good visualization)
            const maxIndex = Math.max(150, ...chartData.map(d => d.currentIndex));
            const scale = Math.ceil(maxIndex / 50) * 50; // Round to nearest 50
            
            // Darker purple colors
            const colors = {
                current: {
                    primary: '#6d28d9',      // Darker purple
                    gradient: 'linear-gradient(135deg, #6d28d9 0%, #5b21b6 100%)'
                },
                previous: {
                    primary: '#8b5cf6',      // Medium purple
                    gradient: 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)'
                }
            };
            
            // Build the chart HTML with more vertical space
            let chartHTML = '<div style="position: relative; padding-left: 45px; padding-top: 50px;">';
            
            // Y-axis labels (indexed)
            const chartHeight = 320; // Increased height
            const yAxisSteps = 4;
            for (let i = 0; i <= yAxisSteps; i++) {
                const indexValue = (scale / yAxisSteps) * (yAxisSteps - i);
                chartHTML += `
                    <div style="position: absolute; left: 0; top: ${50 + i * (chartHeight / yAxisSteps) - 6}px; font-size: 10px; color: var(--text-tertiary); width: 35px; text-align: right;">
                        ${Math.round(indexValue)}
                    </div>`;
            }
            
            // Y-axis line
            chartHTML += '<div style="position: absolute; left: 40px; top: 50px; bottom: 0; width: 1px; background: var(--border); opacity: 0.3;"></div>';
            
            // Chart bars container - wider bars with good spacing and more top padding
            chartHTML += '<div style="display: flex; justify-content: center; align-items: flex-end; gap: 24px; height: 320px; position: relative; padding: 0 15px;">';
            
            chartData.forEach((metric, index) => {
                const currentHeight = (metric.currentIndex / scale) * 100;
                const previousHeight = (metric.previousIndex / scale) * 100;
                
                // Simple centered badge positioning - just above the taller bar's value
                const tallestBar = Math.max(currentHeight, previousHeight);
                
                // Position badge centered between bars, above the taller one's value label
                // Values are 24px above bars, so add clearance above that
                const badgeBottom = tallestBar + 10; // 10% above the tallest bar for value clearance
                
                chartHTML += `
                    <div style="position: relative; height: 100%; width: 110px; display: flex; align-items: flex-end;">
                        <!-- Change Badge - centered between bars, above values -->
                        ${metric.change !== 0 ? `
                        <div style="position: absolute; bottom: ${badgeBottom}%; left: 50%; transform: translateX(-50%); background: ${metric.change > 0 ? '#10b981' : '#ef4444'}; color: white; padding: 3px 7px; border-radius: 4px; font-size: 10px; font-weight: 600; white-space: nowrap; z-index: 10;">
                            ${metric.change > 0 ? '+' : ''}${metric.change.toFixed(1)}%
                        </div>` : ''}
                        
                        <!-- Previous Year Bar -->
                        <div style="position: absolute; bottom: 0; left: 10px; width: 42px; height: ${previousHeight}%; background: ${colors.previous.gradient}; border-radius: 5px 5px 0 0; opacity: 0.6; transition: all 0.3s ease;">
                            <div style="position: absolute; top: -24px; left: 50%; transform: translateX(-50%); font-size: 10px; color: var(--text-secondary); white-space: nowrap; opacity: 0.9;">
                                ${formatValue(metric.previous)}
                            </div>
                        </div>
                        
                        <!-- Current Year Bar -->
                        <div style="position: absolute; bottom: 0; right: 10px; width: 42px; height: ${currentHeight}%; background: ${colors.current.gradient}; border-radius: 5px 5px 0 0; transition: all 0.3s ease;">
                            <div style="position: absolute; top: -24px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #6d28d9; font-weight: 600; white-space: nowrap;">
                                ${formatValue(metric.current)}
                            </div>
                        </div>
                    </div>`;
            });
            
            chartHTML += '</div>';
            
            // Baseline at index 100
            chartHTML += `<div style="position: absolute; left: 45px; right: 20px; bottom: ${100 / scale * 320}px; height: 1px; background: var(--text-tertiary); opacity: 0.3;">
                <span style="position: absolute; left: -45px; top: -7px; font-size: 9px; color: var(--text-tertiary);">100</span>
            </div>`;
            
            // X-axis labels
            chartHTML += '<div style="display: flex; justify-content: center; gap: 24px; margin-top: 12px; padding: 0 15px;">';
            chartData.forEach(metric => {
                chartHTML += `
                    <div style="width: 110px; text-align: center;">
                        <div style="font-size: 11px; color: var(--text-primary); font-weight: 500;">${metric.name}</div>
                    </div>`;
            });
            chartHTML += '</div>';
            
            // Legend
            chartHTML += `
                <div style="display: flex; justify-content: center; gap: 24px; margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(109, 40, 217, 0.1);">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: ${colors.previous.gradient}; border-radius: 2px; opacity: 0.6;"></div>
                        <span style="font-size: 11px; color: var(--text-secondary);">Previous Year</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: ${colors.current.gradient}; border-radius: 2px;"></div>
                        <span style="font-size: 11px; color: var(--text-secondary);">Current Year</span>
                    </div>
                </div>`;
            
            chartHTML += '</div>';
            
            chartContainer.innerHTML = chartHTML;
        }
        
        function updateGBPSection() {
            // Update GBP metric cards
            const metricsGrid = document.getElementById('gbpMetricsGrid');
            if (metricsGrid) {
                metricsGrid.innerHTML = '';
                
                // Define metrics with icons
                const gbpCardMetrics = [
                    { key: 'Total Views', icon: '', label: 'Total Views', color: '#8b5cf6' },
                    { key: 'Website Clicks', icon: '', label: 'Website Clicks', color: '#3b82f6' },
                    { key: 'Phone Calls', icon: '', label: 'Phone Calls', color: '#10b981' },
                    { key: 'Directions Requests', icon: '', label: 'Directions', color: '#f59e0b' }
                ];
                
                // Add conversion metrics if they exist
                const conversionMetrics = [
                    { key: 'Reservations Button', label: 'Reservations', color: '#ec4899' },
                    { key: 'reservation_button_click', label: 'Reservations', color: '#ec4899' },
                    { key: 'Gift cards', label: 'Gift Cards', color: '#a855f7' },
                    { key: 'Gift Cards', label: 'Gift Cards', color: '#a855f7' },
                    { key: 'Online Orders', label: 'Online Orders', color: '#06b6d4' },
                    { key: 'Contact Us', label: 'Contact Form', color: '#14b8a6' }
                ];
                
                // Check if conversion metrics exist and add them
                conversionMetrics.forEach(metric => {
                    if (dashboardData[metric.key] && !gbpCardMetrics.find(m => m.label === metric.label)) {
                        gbpCardMetrics.push(metric);
                    }
                });
                
                gbpCardMetrics.forEach(metricConfig => {
                    const data = dashboardData[metricConfig.key];
                    const card = document.createElement('div');
                    card.className = 'gbp-metric-card';
                    
                    // Default values if no data
                    const value = data?.value || 0;
                    const yoyChange = data?.yoy || 0;
                    const momChange = data?.mom || 0;
                    
                    // Determine which change to show (prioritize YoY)
                    const changeValue = yoyChange || momChange;
                    const changeLabel = yoyChange ? 'YoY' : momChange ? 'MoM' : '';
                    
                    // Generate mini sparkline with simple predefined path
                    const sparklineTrend = changeValue >= 0 ? 'up' : 'down';
                    const sparklinePoints = sparklineTrend === 'up' ? 
                        '0,25 15,20 30,15 45,10 60,5' : 
                        '0,5 15,10 30,15 45,20 60,25';
                    
                    card.innerHTML = 
                        '<div class="gbp-metric-sparkline-mini">' +
                            '<svg viewBox="0 0 60 30">' +
                                '<path d="M ' + sparklinePoints + '" />' +
                            '</svg>' +
                        '</div>' +
                        '<div class="gbp-metric-label">' + metricConfig.label + '</div>' +
                        '<div class="gbp-metric-value">' + formatValue(value) + '</div>' +
                        '<div class="gbp-metric-change ' + (changeValue >= 0 ? 'positive' : 'negative') + '">' +
                            '<span class="gbp-metric-change-badge ' + (changeValue >= 0 ? 'positive' : 'negative') + '">' +
                                (changeValue >= 0 ? '↑' : '↓') + ' ' + Math.abs(changeValue).toFixed(1) + '% ' + changeLabel +
                            '</span>' +
                        '</div>';
                    
                    metricsGrid.appendChild(card);
                });
            }
            
            // Update Year-over-Year Chart
            const chartContainer = document.getElementById('gbpYoyChart');
            if (chartContainer) {
                createGBPYoyChart();
            }
            
            // Update Rating section
            const ratingDiv = document.getElementById('gbpRating');
            if (ratingDiv && dashboardData['Rating']) {
                const rating = dashboardData['Rating'];
                const stars = '';
                ratingDiv.innerHTML = 
                    '<div>' +
                        '<div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">' + 
                            (rating.value || 0).toFixed(1) + 
                        '</div>' +
                        '<div style="font-size: 11px; color: var(--text-secondary);">Average Rating</div>' +
                    '</div>';
            }
            
            // Update Reviews section
            const reviewsDiv = document.getElementById('gbpReviews');
            if (reviewsDiv && dashboardData['Reviews Count']) {
                const reviews = dashboardData['Reviews Count'];
                reviewsDiv.innerHTML = 
                    '<div>' +
                        '<div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">' + 
                            formatValue(reviews.value || 0) + 
                        '</div>' +
                        '<div style="font-size: 11px; color: var(--text-secondary);">Total Reviews</div>' +
                        (reviews.yoy ? 
                            '<div style="font-size: 10px; color: ' + (reviews.yoy >= 0 ? 'var(--success)' : 'var(--danger)') + ';">' +
                                (reviews.yoy >= 0 ? '+' : '') + reviews.yoy.toFixed(1) + '% YoY' +
                            '</div>' : ''
                        ) +
                    '</div>';
            }
            
            // Update conversion bars (keep existing functionality)
            const conversions = document.getElementById('gbpConversions');
            if (conversions) {
                conversions.innerHTML = '';
                
                const conversionMetrics = ['Website Clicks', 'Phone Calls', 'Directions Requests'];
                const maxConv = Math.max(...conversionMetrics.map(m => dashboardData[m]?.value || 0));
                
                conversionMetrics.forEach(metric => {
                    if (dashboardData[metric]) {
                        const data = dashboardData[metric];
                        const heightPct = (data.value / maxConv * 100) || 10;
                        
                        const item = document.createElement('div');
                        item.className = 'conversion-item';
                        item.innerHTML = 
                            '<div class="conversion-bar" style="height: ' + (heightPct * 2.5) + 'px;">' +
                                '<div class="bar-fill" style="height: 100%;"></div>' +
                            '</div>' +
                            '<div class="conversion-label">' +
                                '<strong>' + metric + '</strong>' +
                                '<span class="conversion-value">' + formatValue(data.value) + '</span>' +
                                (data.yoy ? 
                                    '<span class="conversion-change ' + (data.yoy >= 0 ? 'positive' : 'negative') + '">' +
                                        (data.yoy >= 0 ? '↑' : '↓') + formatPercentageChange(data.yoy).replace(/[+-]/, '') +
                                    '</span>' : ''
                                ) +
                            '</div>';
                        conversions.appendChild(item);
                    }
                });
            }
        }
        
        // Helper function to generate sparkline SVG
        function generateSparkline(trend) {
            const points = trend === 'up' ? '0,15 10,10 20,12 30,5 40,8 50,3 60,5' : '0,5 10,8 20,6 30,12 40,10 50,15 60,13';
            return '<svg class="sparkline ' + (trend === 'up' ? 'positive' : 'negative') + '" viewBox="0 0 60 20"><path d="M ' + points + '" /></svg>';
        }
        
        function updateAnalyticsSection() {
            renderEventMetrics();
            renderTrafficSources();
            renderNewUsersByChannel();
            renderPerformanceKPIs();
        }
        
        function renderEventMetrics() {
            const container = document.getElementById('eventMetricsList');
            if (!container) return;
            container.innerHTML = '';
            
            // Use real data if available, otherwise use sample data
            const eventData = [];
            
            // Try to extract event data from dashboardData
            const eventMetrics = ['page_view', 'session_start', 'first_visit', 'scroll', 'click', 'view_item', 'add_to_cart', 'purchase', 'reservations_button'];
            
            eventMetrics.forEach(metric => {
                if (dashboardData[metric] || dashboardData[metric.replace(/_/g, ' ')]) {
                    const data = dashboardData[metric] || dashboardData[metric.replace(/_/g, ' ')];
                    eventData.push({
                        name: metric.replace(/_/g, ' '),
                        value: data.value || 0,
                        change: data.yoy || data.mom || data.change || 0,
                        highlight: metric === 'reservations_button'
                    });
                }
            });
            
            // If no real data, use sample data
            if (eventData.length === 0) {
                eventData.push(
                    { name: 'Page Views', value: 131000, change: 5.6 },
                    { name: 'Sessions', value: 62000, change: 0.6 },
                    { name: 'Scrolls', value: 48000, change: 8.6 },
                    { name: 'First Visits', value: 46000, change: -4.4 },
                    { name: 'Engagements', value: 35000, change: 12.3 },
                    { name: 'Reservations', value: 7500, change: 37.9, highlight: true }
                );
            }
            
            const maxValue = Math.max(...eventData.map(e => e.value));
            
            eventData.forEach(event => {
                const item = document.createElement('div');
                item.className = 'event-metric-item';
                
                const barWidth = (event.value / maxValue * 100) || 10;
                const sparkline = generateSparkline(event.change >= 0 ? 'up' : 'down');
                
                item.innerHTML = '<div class="event-metric-name">' + event.name + '</div>' +
                    '<div class="event-metric-bar">' +
                        '<div class="event-metric-fill ' + (event.highlight ? 'highlight' : '') + '" style="width: ' + barWidth + '%;">' +
                            '<span class="event-metric-value">' + formatValue(event.value) + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="event-metric-change ' + (event.change >= 0 ? 'positive' : 'negative') + '">' +
                        (event.change >= 0 ? '↑' : '↓') + ' ' + formatPercentageChange(event.change).replace(/[+-]/, '') +
                    '</div>' +
                    '<div class="event-metric-sparkline">' + sparkline + '</div>';
                container.appendChild(item);
            });
        }
        
        function renderTrafficSources() {
            const container = document.getElementById('trafficSourcesList');
            if (!container) return;
            container.innerHTML = '';
            
            // Use real channel data if available
            const trafficData = [];
            
            // Expanded list of possible channel names
            const channels = [
                'Organic Search', 'Direct', 'Paid Search', 'Paid Social', 
                'Organic Social', 'Referral', 'Email', 'Cross-network', 
                'Display', 'Unassigned', 'Others'
            ];
            
            // First check exact matches
            channels.forEach(channel => {
                if (dashboardData[channel]) {
                    const data = dashboardData[channel];
                    // Shorten name for display
                    let displayName = channel;
                    if (channel === 'Organic Search') displayName = 'Organic';
                    else if (channel === 'Cross-network') displayName = 'Cross-net';
                    else if (channel === 'Paid Social') displayName = 'Paid Social';
                    else if (channel === 'Paid Search') displayName = 'Paid';
                    else if (channel === 'Organic Social') displayName = 'Social';
                    
                    trafficData.push({
                        source: displayName,
                        value: data.sessions || data.value || 0,
                        change: data.change || data.yoy || data.mom || 0
                    });
                }
            });
            
            // If no real data, use sample data
            if (trafficData.length === 0) {
                trafficData.push(
                    { source: 'Google', value: 8500, change: 12.5 },
                    { source: 'Direct', value: 4700, change: -8.2 },
                    { source: 'Facebook', value: 2100, change: 24.3 },
                    { source: 'Instagram', value: 1800, change: 15.7 },
                    { source: 'Others', value: 950, change: -3.4 }
                );
            }
            
            const maxValue = Math.max(...trafficData.map(t => t.value));
            
            trafficData.forEach(traffic => {
                const item = document.createElement('div');
                item.className = 'traffic-source-item';
                
                const barWidth = (traffic.value / maxValue * 100) || 10;
                
                item.innerHTML = '<div class="traffic-source-name">' + traffic.source + '</div>' +
                    '<div class="traffic-source-bar">' +
                        '<div class="traffic-source-fill" style="width: ' + barWidth + '%;">' +
                            '<span class="traffic-source-value">' + formatValue(traffic.value) + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="traffic-source-value" style="min-width: 60px; text-align: right; color: #94a3b8;">' +
                        formatValue(traffic.value) +
                    '</div>' +
                    '<div class="traffic-source-change ' + (traffic.change >= 0 ? 'positive' : 'negative') + '">' +
                        formatPercentageChange(traffic.change) +
                    '</div>';
                container.appendChild(item);
            });
        }
        
        function renderNewUsersByChannel() {
            // Channel data with current and previous values
            const channelData = [];
            const channelNames = ['Organic Search', 'Direct', 'Referral', 'Google Ads (Paid + Display)', 'Organic Social', 'Unassigned'];
            
            channelNames.forEach(channel => {
                if (dashboardData[channel] || dashboardData[channel.replace(' (Paid + Display)', '')]) {
                    const data = dashboardData[channel] || dashboardData[channel.replace(' (Paid + Display)', '')];
                    const currentValue = data.value || data.users || data.newUsers || 0;
                    const previousValue = currentValue / (1 + (data.change || data.yoy || 0) / 100);
                    
                    channelData.push({
                        name: channel,
                        current: currentValue,
                        previous: Math.round(previousValue),
                        change: data.change || data.yoy || 0
                    });
                }
            });
            
            // If no real data, use sample data
            if (channelData.length === 0) {
                channelData.push(
                    { name: 'Organic Search', current: 18500, previous: 16200, change: 21.7 },
                    { name: 'Direct', current: 12800, previous: 10500, change: 23.1 },
                    { name: 'Referral', current: 13200, previous: 10100, change: 30.7 },
                    { name: 'Google Ads (Paid + Display)', current: 1300, previous: 950, change: 27.6 },
                    { name: 'Organic Social', current: 950, previous: 820, change: 15.9 },
                    { name: 'Unassigned', current: 400, previous: 350, change: 14.3 }
                );
            }
            
            const maxValue = Math.max(...channelData.map(c => Math.max(c.current, c.previous)));
            
            // Render for both Analytics tab and Overview tab
            const containers = [
                document.getElementById('channelUsersList'),
                document.getElementById('overviewChannelUsersList')
            ];
            
            containers.forEach(container => {
                if (!container) return;
                container.innerHTML = '';
                
                channelData.forEach(channel => {
                    const item = document.createElement('div');
                    item.className = 'channel-user-item';
                    
                    const currentWidth = Math.max((channel.current / maxValue * 100) || 0, 2); // Min 2% width for visibility
                    const previousWidth = Math.max((channel.previous / maxValue * 100) || 0, 2);
                    
                    // Determine if label should be inside or outside the bar based on width
                    const showLabelInside = currentWidth > 25; // Show inside if bar is wide enough
                    const currentLabel = formatValue(channel.current);
                    
                    item.innerHTML = '<div class="channel-user-header">' +
                            '<span class="channel-user-name">' + channel.name + '</span>' +
                            '<div class="channel-user-stats">' +
                                '<span class="channel-user-value">' + currentLabel + '</span>' +
                                '<span class="channel-user-change ' + (channel.change >= 0 ? 'positive' : 'negative') + ' showPercentage">' +
                                    formatPercentageChange(channel.change) +
                                '</span>' +
                            '</div>' +
                        '</div>' +
                        '<div class="channel-user-bars">' +
                            '<div class="channel-bar-container">' +
                                '<div class="channel-bar-background"></div>' +
                                '<div class="channel-bar-previous" style="width: ' + previousWidth + '%;">' +
                                    (previousWidth > 20 ? '<span class="channel-bar-label" style="opacity: 0.7;">' + formatValue(channel.previous) + '</span>' : '') +
                                '</div>' +
                                '<div class="channel-bar-current" style="width: ' + currentWidth + '%;">' +
                                    (showLabelInside ? '<span class="channel-bar-label">' + currentLabel + '</span>' : '') +
                                '</div>' +
                            '</div>' +
                        '</div>';
                    container.appendChild(item);
                });
            });
            
            // Handle percentage toggle
            const checkbox = document.getElementById('showPercentages');
            if (checkbox) {
                checkbox.addEventListener('change', (e) => {
                    const percentages = document.querySelectorAll('.showPercentage');
                    percentages.forEach(el => {
                        el.style.display = e.target.checked ? 'inline' : 'none';
                    });
                });
            }
        }
        
        function renderPerformanceKPIs() {
            const container = document.getElementById('performanceKPIs');
            if (!container) return;
            container.innerHTML = '';
            
            // KPI metrics configuration - always show all 4
            const kpiMetrics = [
                { key: 'Page Views', altKeys: ['page_view', 'pageviews'], label: 'PAGE VIEWS', default: 24300, defaultChange: 15.2 },
                { key: 'Active Users', altKeys: ['Users', 'active_users', 'users'], label: 'USERS', default: 8500, defaultChange: 8.7 },
                { key: 'Average Session Duration', altKeys: ['Avg. Session Duration', 'avg_session_duration', 'Average Engagement Time'], label: 'AVG. SESSION', default: 154, defaultChange: -5.2 },
                { key: 'Bounce Rate', altKeys: ['bounce_rate', 'Bounce rate'], label: 'BOUNCE RATE', default: 42.3, defaultChange: -3.1 }
            ];
            
            // Build KPI data - ensure all 4 metrics are present
            const kpiData = [];
            
            kpiMetrics.forEach(kpi => {
                let foundData = null;
                let value = kpi.default;
                let change = kpi.defaultChange;
                
                // Try main key first
                if (dashboardData[kpi.key]) {
                    foundData = dashboardData[kpi.key];
                } else {
                    // Try alternative keys
                    for (let altKey of kpi.altKeys) {
                        if (dashboardData[altKey]) {
                            foundData = dashboardData[altKey];
                            break;
                        }
                    }
                }
                
                if (foundData) {
                    value = foundData.value !== undefined ? foundData.value : value;
                    change = foundData.yoy || foundData.mom || foundData.change || change;
                }
                
                kpiData.push({
                    label: kpi.label,
                    value: value,
                    change: change,
                    format: kpi.label.includes('BOUNCE') ? 'percent' : 
                            kpi.label.includes('SESSION') ? 'time' : 'number'
                });
            });
            
            kpiData.forEach(kpi => {
                const item = document.createElement('div');
                item.className = 'kpi-card';
                
                let displayValue = kpi.value;
                if (kpi.format === 'number' && typeof kpi.value === 'number') {
                    displayValue = formatValue(kpi.value);
                } else if (kpi.format === 'percent') {
                    displayValue = kpi.value + '%';
                } else if (kpi.format === 'time' && typeof kpi.value === 'number') {
                    const minutes = Math.floor(kpi.value / 60);
                    const seconds = kpi.value % 60;
                    displayValue = minutes + ':' + seconds.toString().padStart(2, '0');
                } else if (typeof kpi.value === 'string') {
                    displayValue = kpi.value;
                }
                
                item.innerHTML = '<div class="kpi-label">' + kpi.label + '</div>' +
                    '<div class="kpi-value">' + displayValue + '</div>' +
                    '<div class="kpi-change ' + (kpi.change >= 0 ? 'positive' : 'negative') + '">' +
                        (kpi.change >= 0 ? '+' : '') + kpi.change.toFixed(1) + '%' +
                    '</div>';
                container.appendChild(item);
            });
        }
        
        function updateAdsSection() {
            // Calculate total conversions from conversion actions
            let totalActions = 0;
            let totalCost = 0;
            const conversionData = [];
            
            // Get cost data
            if (dashboardData['Total Cost'] && dashboardData['Total Cost'].isAdsCost) {
                totalCost = dashboardData['Total Cost'].value;
            }
            
            // Calculate total actions from conversion actions
            Object.keys(dashboardData).forEach(metric => {
                const data = dashboardData[metric];
                if (data.isConversionAction === true && metric !== 'Total Cost' && !data.aggregatedInto) {
                    totalActions += data.value || 0;
                    conversionData.push({
                        name: metric,
                        value: data.value,
                        change: data.change || data.yoy || data.mom || 0
                    });
                }
            });
            
            // Calculate metrics
            const costPerAction = totalActions > 0 ? (totalCost / totalActions) : 0;
            const avgChange = conversionData.length > 0 ? 
                conversionData.reduce((sum, item) => sum + item.change, 0) / conversionData.length : 0;
            
            // Update header with value-focused metrics
            document.getElementById('totalActionsValue').textContent = formatValue(totalActions);
            document.getElementById('costPerAction').textContent = formatValue(costPerAction, true);
            document.getElementById('totalInvestment').textContent = formatValue(totalCost, true);
            
            // Update performance change
            const perfElement = document.getElementById('performanceChange');
            if (avgChange !== 0) {
                perfElement.textContent = formatPercentageChange(avgChange);
                perfElement.classList.toggle('negative', avgChange < 0);
            } else {
                perfElement.textContent = '—';
            }
            
            // Update ads table - ONLY use Campaign Performance conversion actions
            const tbody = document.querySelector('#adsTable tbody');
            tbody.innerHTML = '';
            
            // Build ads data ONLY from conversion actions marked from Campaign Performance
            const adsData = [];
            
            // Only include metrics that are specifically marked as conversion actions
            Object.keys(dashboardData).forEach(metric => {
                const data = dashboardData[metric];
                // ONLY include if it's marked as a conversion action from Campaign Performance and not aggregated
                if (data.isConversionAction === true && !data.aggregatedInto) {
                    adsData.push({
                        name: metric,
                        value: data.value,
                        change: data.change || data.yoy || data.mom || 0
                    });
                }
            });
            
            // If no conversion data found, show a message
            if (adsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--text-secondary);">No conversion data available. Please parse a report with Campaign Performance data.</td></tr>';
            } else {
                // Sort by value descending
                adsData.sort((a, b) => b.value - a.value);
                
                adsData.forEach(ad => {
                    const row = document.createElement('tr');
                    const totalCost = dashboardData['Total Cost']?.value || 0;
                    const costPerConv = totalCost && ad.value > 0 ? 
                        (totalCost / ad.value).toFixed(2) : '—';
                    
                    row.innerHTML = `
                        <td>
                            <div class="conversion-name">
                                <strong>${getDisplayName(ad.name)}</strong>
                            </div>
                        </td>
                        <td class="count-cell">${formatValue(ad.value)}</td>
                        <td><span class="metric-badge ${ad.change >= 0 ? 'up' : 'down'}">${ad.change ? (ad.change >= 0 ? '+' : '') + ad.change.toFixed(1) + '%' : '—'}</span></td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }
        
        function updateOverviewSections() {
            // Update GBP Year-over-Year Chart in Overview - using exact same logic as GBP section
            const overviewGbpChart = document.getElementById('overviewGbpChart');
            if (overviewGbpChart) {
                // Get GBP metrics with YoY data (exact same as createGBPYoyChart)
                const metrics = [
                    { name: 'Total Views', key: 'Total Views' },
                    { name: 'Website Clicks', key: 'Website Clicks' },
                    { name: 'Phone Calls', key: 'Phone Calls' },
                    { name: 'Directions', key: 'Directions Requests' }
                ];
                
                // Prepare data for visualization with indexed values
                const chartData = [];
                metrics.forEach(metric => {
                    const data = dashboardData[metric.key];
                    if (data && data.value) {
                        const currentValue = data.value;
                        const yoyChange = data.yoy || data.change || 0;
                        
                        // Calculate previous year value
                        const previousValue = yoyChange !== 0 ? 
                            currentValue / (1 + yoyChange / 100) : 
                            currentValue;
                        
                        // Calculate index (previous year = 100)
                        const previousIndex = 100;
                        const currentIndex = previousValue > 0 ? (currentValue / previousValue) * 100 : 100;
                        
                        chartData.push({
                            name: metric.name,
                            current: currentValue,
                            previous: Math.round(previousValue),
                            currentIndex: currentIndex,
                            previousIndex: previousIndex,
                            change: yoyChange
                        });
                    }
                });
                
                if (chartData.length === 0) {
                    overviewGbpChart.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">No year-over-year data available</div>';
                    return;
                }
                
                // Use indexed scale (0-200 for good visualization)
                const maxIndex = Math.max(150, ...chartData.map(d => d.currentIndex));
                const scale = Math.ceil(maxIndex / 50) * 50; // Round to nearest 50
                
                // Adjusted purple colors - more contrast between years
                const colors = {
                    current: {
                        primary: '#6d28d9',      // Darker purple for current year
                        gradient: 'linear-gradient(135deg, #6d28d9 0%, #5b21b6 100%)'
                    },
                    previous: {
                        primary: '#9333ea',      // Medium-light purple for previous year
                        gradient: 'linear-gradient(135deg, #a855f7 0%, #9333ea 100%)'
                    }
                };
                
                // Build the chart HTML with more vertical space (exact same as createGBPYoyChart)
                let chartHTML = '<div style="position: relative; padding-left: 45px; padding-top: 50px;">';
                
                // Y-axis labels (indexed)
                const chartHeight = 320; // Increased height
                const yAxisSteps = 4;
                for (let i = 0; i <= yAxisSteps; i++) {
                    const indexValue = (scale / yAxisSteps) * (yAxisSteps - i);
                    chartHTML += `
                        <div style="position: absolute; left: 0; top: ${50 + i * (chartHeight / yAxisSteps) - 6}px; font-size: 10px; color: var(--text-tertiary); width: 35px; text-align: right;">
                            ${Math.round(indexValue)}
                        </div>`;
                }
                
                // Y-axis line
                chartHTML += '<div style="position: absolute; left: 40px; top: 50px; bottom: 0; width: 1px; background: var(--border); opacity: 0.3;"></div>';
                
                // Chart bars container - wider bars with good spacing and more top padding
                chartHTML += '<div style="display: flex; justify-content: center; align-items: flex-end; gap: 24px; height: 320px; position: relative; padding: 0 15px;">';
                
                chartData.forEach((metric, index) => {
                    const currentHeight = (metric.currentIndex / scale) * 100;
                    const previousHeight = (metric.previousIndex / scale) * 100;
                    
                    // Simple centered badge positioning - just above the taller bar's value
                    const tallestBar = Math.max(currentHeight, previousHeight);
                    
                    // Position badge centered between bars, above the taller one's value label
                    const badgeBottom = tallestBar + 10; // 10% above the tallest bar for value clearance
                    
                    chartHTML += `
                        <div style="position: relative; height: 100%; width: 110px; display: flex; align-items: flex-end;">
                            <!-- Change Badge - centered between bars, above values -->
                            ${metric.change !== 0 ? `
                            <div style="position: absolute; bottom: ${badgeBottom}%; left: 50%; transform: translateX(-50%); background: ${metric.change > 0 ? '#10b981' : '#ef4444'}; color: white; padding: 3px 7px; border-radius: 4px; font-size: 10px; font-weight: 600; white-space: nowrap; z-index: 10;">
                                ${metric.change > 0 ? '+' : ''}${metric.change.toFixed(1)}%
                            </div>` : ''}
                            
                            <!-- Previous Year Bar -->
                            <div style="position: absolute; bottom: 0; left: 10px; width: 42px; height: ${previousHeight}%; background: ${colors.previous.gradient}; border-radius: 5px 5px 0 0; opacity: 0.7; transition: all 0.3s ease;">
                                <div style="position: absolute; top: -24px; left: 50%; transform: translateX(-50%); font-size: 10px; color: var(--text-secondary); white-space: nowrap; opacity: 0.9;">
                                    ${formatValue(metric.previous)}
                                </div>
                            </div>
                            
                            <!-- Current Year Bar -->
                            <div style="position: absolute; bottom: 0; right: 10px; width: 42px; height: ${currentHeight}%; background: ${colors.current.gradient}; border-radius: 5px 5px 0 0; transition: all 0.3s ease;">
                                <div style="position: absolute; top: -24px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #6d28d9; font-weight: 600; white-space: nowrap;">
                                    ${formatValue(metric.current)}
                                </div>
                            </div>
                        </div>`;
                });
                
                chartHTML += '</div>';
                
                // Baseline at index 100
                chartHTML += `<div style="position: absolute; left: 45px; right: 20px; bottom: ${100 / scale * 320}px; height: 1px; background: var(--text-tertiary); opacity: 0.3;">
                    <span style="position: absolute; left: -45px; top: -7px; font-size: 9px; color: var(--text-tertiary);">100</span>
                </div>`;
                
                // X-axis labels
                chartHTML += '<div style="display: flex; justify-content: center; gap: 24px; margin-top: 12px; padding: 0 15px;">';
                chartData.forEach(metric => {
                    chartHTML += `
                        <div style="width: 110px; text-align: center;">
                            <div style="font-size: 11px; color: var(--text-primary); font-weight: 500;">${metric.name}</div>
                        </div>`;
                });
                chartHTML += '</div>';
                
                // Legend
                chartHTML += `
                    <div style="display: flex; justify-content: center; gap: 24px; margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(109, 40, 217, 0.1);">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 12px; height: 12px; background: ${colors.previous.gradient}; border-radius: 2px; opacity: 0.7;"></div>
                            <span style="font-size: 11px; color: var(--text-secondary);">Previous Year</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 12px; height: 12px; background: ${colors.current.gradient}; border-radius: 2px;"></div>
                            <span style="font-size: 11px; color: var(--text-secondary);">Current Year</span>
                        </div>
                    </div>`;
                
                chartHTML += '</div>';
                
                overviewGbpChart.innerHTML = chartHTML;
            }
            
            // Update Google Ads Conversion Table in Overview
            const overviewAdsTable = document.getElementById('overviewAdsTable');
            if (overviewAdsTable) {
                overviewAdsTable.innerHTML = '';
                
                const conversionData = [];
                Object.keys(dashboardData).forEach(metric => {
                    const data = dashboardData[metric];
                    if (data.isConversionAction === true && 
                        !data.aggregatedInto &&
                        !metric.toLowerCase().includes('total') && 
                        metric !== 'Total') {
                        conversionData.push({
                            name: metric,
                            value: data.value,
                            change: data.change || data.yoy || data.mom || 0
                        });
                    }
                });
                
                if (conversionData.length > 0) {
                    // Sort by value descending
                    conversionData.sort((a, b) => b.value - a.value);
                    
                    // Limit to top 10 for space, but show all if less than 10
                    const displayData = conversionData.slice(0, 10);
                    
                    // Create table rows with better spacing
                    displayData.forEach((ad, index) => {
                        const row = document.createElement('tr');
                        const isTopPerformer = index === 0;
                        
                        row.innerHTML = `
                            <td style="${isTopPerformer ? 'background: rgba(139, 92, 246, 0.08); font-weight: 600;' : ''}">
                                <div class="conversion-name" style="padding: 4px 0;">
                                    <strong>${getDisplayName(ad.name)}</strong>
                                </div>
                            </td>
                            <td class="count-cell" style="text-align: center; ${isTopPerformer ? 'background: rgba(139, 92, 246, 0.08); font-weight: 600;' : ''}">${formatValue(ad.value)}</td>
                            <td style="text-align: center; ${isTopPerformer ? 'background: rgba(139, 92, 246, 0.08);' : ''}">
                                <span class="metric-badge ${ad.change >= 0 ? 'up' : 'down'}">
                                    ${ad.change ? (ad.change >= 0 ? '+' : '') + ad.change.toFixed(1) + '%' : '—'}
                                </span>
                            </td>
                        `;
                        overviewAdsTable.appendChild(row);
                    });
                    
                    // Add summary row if more than 10 items
                    if (conversionData.length > 10) {
                        const row = document.createElement('tr');
                        const remainingCount = conversionData.length - 10;
                        const remainingTotal = conversionData.slice(10).reduce((sum, item) => sum + item.value, 0);
                        
                        row.innerHTML = `
                            <td style="color: var(--text-secondary); font-style: italic; border-top: 2px solid var(--border-color); padding-top: 8px;">
                                +${remainingCount} more actions
                            </td>
                            <td class="count-cell" style="text-align: center; color: var(--text-secondary); border-top: 2px solid var(--border-color); padding-top: 8px;">
                                ${formatValue(remainingTotal)}
                            </td>
                            <td style="border-top: 2px solid var(--border-color); padding-top: 8px;"></td>
                        `;
                        overviewAdsTable.appendChild(row);
                    }
                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="3" style="text-align: center; color: var(--text-secondary); padding: 20px;">No conversion data available</td>';
                    overviewAdsTable.appendChild(row);
                }
            }
            
            // Update Recommended Insights
            const insightsDiv = document.getElementById('recommendedInsights');
            if (insightsDiv) {
                const insights = generateRecommendedInsights();
                insightsDiv.innerHTML = insights;
            }
        }
        
        function generateRecommendedInsights() {
            const periodLabel = parserMetadata.reportPeriod?.periodLabel || 'this period';
            const periodType = parserMetadata.reportPeriod?.periodType || 'month';
            
            // Analyze the data for insights
            let bestMetric = null;
            let bestChange = -999;
            let worstMetric = null;
            let worstChange = 999;
            let totalConversions = 0;
            let conversionGrowth = 0;
            let conversionCount = 0;
            
            Object.keys(dashboardData).forEach(metric => {
                const data = dashboardData[metric];
                const change = data.yoy || data.mom || data.change;
                
                if (change) {
                    if (change > bestChange) {
                        bestChange = change;
                        bestMetric = metric;
                    }
                    if (change < worstChange) {
                        worstChange = change;
                        worstMetric = metric;
                    }
                }
                
                if (data.isConversionAction) {
                    totalConversions += data.value || 0;
                    if (change) {
                        conversionGrowth += change;
                        conversionCount++;
                    }
                }
            });
            
            const avgConversionGrowth = conversionCount > 0 ? conversionGrowth / conversionCount : 0;
            
            let insightsHTML = '<div style="display: flex; flex-direction: column; gap: 16px;">';
            
            // Top performer insight
            if (bestMetric && bestChange > 0) {
                insightsHTML += `
                    <div style="padding: 16px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 8px; color: white;">
                        <div style="margin-bottom: 8px;">
                            <strong style="font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">TOP PERFORMER</strong>
                        </div>
                        <p style="margin: 0; font-size: 15px; line-height: 1.5;">
                            <strong>${getDisplayName(bestMetric)}</strong> is your star metric ${periodLabel}, 
                            with an impressive <strong>${formatPercentageChange(bestChange)}</strong> increase. 
                            This indicates strong ${bestMetric.includes('Phone') ? 'direct customer engagement' : 
                                               bestMetric.includes('Direction') ? 'foot traffic intent' :
                                               bestMetric.includes('Website') ? 'digital interest' :
                                               'market performance'}.
                        </p>
                    </div>
                `;
            }
            
            // Conversion insights if available
            if (totalConversions > 0) {
                const conversionTrend = avgConversionGrowth > 0 ? 'growing' : avgConversionGrowth < 0 ? 'declining' : 'stable';
                insightsHTML += `
                    <div style="padding: 16px; background: linear-gradient(135deg, #6d28d9 0%, #5b21b6 100%); border-radius: 8px; color: white;">
                        <div style="margin-bottom: 8px;">
                            <strong style="font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">CONVERSION PERFORMANCE</strong>
                        </div>
                        <p style="margin: 0; font-size: 15px; line-height: 1.5;">
                            Generated <strong>${formatValue(totalConversions)}</strong> total customer actions ${periodLabel}, 
                            with conversions ${conversionTrend} at ${avgConversionGrowth > 0 ? '+' : ''}${avgConversionGrowth.toFixed(1)}% 
                            ${periodType === 'quarter' ? 'QoQ' : periodType === 'year' ? 'YoY' : 'MoM'}. 
                            ${avgConversionGrowth > 10 ? 'This exceptional growth suggests your campaigns are resonating strongly with your target audience.' :
                              avgConversionGrowth > 0 ? 'Steady progress indicates healthy campaign optimization.' :
                              'Consider A/B testing new ad creatives and landing pages to boost performance.'}
                        </p>
                    </div>
                `;
            }
            
            // Area for improvement
            if (worstMetric && worstChange < -5) {
                insightsHTML += `
                    <div style="padding: 16px; background: #f3f4f6; border-radius: 8px; border-left: 4px solid #6b7280;">
                        <div style="margin-bottom: 8px;">
                            <strong style="font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; color: #374151;">OPPORTUNITY AREA</strong>
                        </div>
                        <p style="margin: 0; font-size: 15px; line-height: 1.5; color: #1f2937;">
                            <strong>${getDisplayName(worstMetric)}</strong> declined by ${Math.abs(worstChange).toFixed(1)}% ${periodLabel}. 
                            ${worstMetric.includes('Phone') ? 'Consider updating your call-to-action buttons and ensuring phone numbers are prominently displayed.' :
                              worstMetric.includes('Website') ? 'Review your organic search rankings and consider refreshing your Google Business Profile posts.' :
                              worstMetric.includes('Direction') ? 'Ensure your location information is accurate and consider promoting special in-store offers.' :
                              'This metric deserves immediate attention to reverse the trend.'}
                        </p>
                    </div>
                `;
            }
            
            // Strategic recommendation
            const totalViews = dashboardData['Total Views']?.value || 0;
            const websiteClicks = dashboardData['Website Clicks']?.value || 0;
            const clickRate = totalViews > 0 ? (websiteClicks / totalViews * 100) : 0;
            
            insightsHTML += `
                <div style="padding: 16px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(109, 69, 209, 0.08) 100%); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.2);">
                    <div style="margin-bottom: 8px;">
                        <strong style="font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; color: #6d28d9;">STRATEGIC FOCUS</strong>
                    </div>
                    <p style="margin: 0; font-size: 15px; line-height: 1.5; color: #1e293b;">
                        ${clickRate < 5 ? 
                            `With a ${clickRate.toFixed(1)}% click-through rate from views, focus on improving your Google Business Profile content. Add fresh photos, respond to reviews, and post weekly updates to boost engagement.` :
                          totalConversions > 100 ? 
                            `Your strong conversion volume indicates healthy demand. Now is the time to scale successful campaigns and test premium offerings to maximize revenue per customer.` :
                          bestChange > 50 ? 
                            `Capitalize on your momentum in ${getDisplayName(bestMetric)} by increasing investment in the channels driving this growth. Track ROI closely to ensure sustainable scaling.` :
                            `Focus on consistency and incremental improvements. Set up A/B tests for your top 3 campaigns and optimize based on cost per acquisition data.`}
                    </p>
                </div>
            `;
            
            insightsHTML += '</div>';
            return insightsHTML;
        }
        
        function switchTab(tabName, element) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabName).classList.remove('hidden');
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');
        }
        
        function switchSection(sectionName, element) {
            document.querySelectorAll('.section-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(sectionName + '-section').classList.remove('hidden');
            
            document.querySelectorAll('.section-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');
        }
        
        function clearReport() {
            document.getElementById('reportText').value = '';
            dashboardData = {};
            updateAllVisualizations();
            document.getElementById('emailBtn').style.display = 'none';
            document.getElementById('darkModeToggle').style.display = 'none';
            document.getElementById('emailOutput').style.display = 'none';
        }
        
        // History Management Functions
        function saveToHistory() {
            if (!parserMetadata.businessName || Object.keys(dashboardData).length === 0) return;
            
            const historyKey = `report_${parserMetadata.businessName}_${new Date().toISOString().slice(0, 7)}`;
            const historyEntry = {
                restaurantName: parserMetadata.businessName,
                date: new Date().toISOString(),
                reportText: document.getElementById('reportText').value,
                parsedData: dashboardData,
                metadata: parserMetadata,
                timestamp: Date.now()
            };
            
            // Save to localStorage
            localStorage.setItem(historyKey, JSON.stringify(historyEntry));
            
            // Clean up old entries (keep only last 20)
            cleanupHistory();
            updateHistoryDropdown();
        }
        
        function cleanupHistory() {
            const allKeys = Object.keys(localStorage).filter(key => key.startsWith('report_'));
            if (allKeys.length > 20) {
                // Sort by timestamp and remove oldest
                const entries = allKeys.map(key => {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        return { key, timestamp: data.timestamp || 0 };
                    } catch {
                        return { key, timestamp: 0 };
                    }
                });
                entries.sort((a, b) => b.timestamp - a.timestamp);
                entries.slice(20).forEach(entry => localStorage.removeItem(entry.key));
            }
        }
        
        function loadFromHistory(key) {
            try {
                const data = JSON.parse(localStorage.getItem(key));
                if (data) {
                    document.getElementById('reportText').value = data.reportText;
                    dashboardData = data.parsedData;
                    parserMetadata = data.metadata;
                    updateAllVisualizations();
                    document.getElementById('emailBtn').style.display = 'inline-flex';
                    document.getElementById('darkModeToggle').style.display = 'inline-flex';
                    document.getElementById('historyDropdown').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading from history:', error);
            }
        }
        
        function toggleHistoryDropdown() {
            const dropdown = document.getElementById('historyDropdown');
            if (dropdown.style.display === 'none') {
                updateHistoryDropdown();
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        
        function updateHistoryDropdown() {
            const dropdown = document.getElementById('historyDropdown');
            const allKeys = Object.keys(localStorage).filter(key => key.startsWith('report_'));
            
            if (allKeys.length === 0) {
                dropdown.innerHTML = '<div style="padding: 16px; color: var(--text-secondary); text-align: center;">No saved reports</div>';
                return;
            }
            
            // Sort by timestamp
            const entries = allKeys.map(key => {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    return {
                        key,
                        name: data.restaurantName,
                        date: new Date(data.date),
                        timestamp: data.timestamp || 0
                    };
                } catch {
                    return null;
                }
            }).filter(Boolean);
            
            entries.sort((a, b) => b.timestamp - a.timestamp);
            
            dropdown.innerHTML = entries.map(entry => {
                const monthYear = entry.date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                return `
                    <div style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.2s;" 
                         onmouseover="this.style.background='var(--hover-bg)'" 
                         onmouseout="this.style.background='transparent'"
                         onclick="loadFromHistory('${entry.key}')">
                        <div style="font-weight: 600; color: var(--text-primary);">${entry.name}</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">${monthYear}</div>
                    </div>
                `;
            }).join('');
        }
        
        // Helper function to build HTML strings safely
        function buildHTML(tag, content, attrs = '') {
            return '<' + tag + (attrs ? ' ' + attrs : '') + '>' + content + '</' + tag + '>';
        }
        
        // Helper to format metric changes
        function formatMetricChange(change, type = 'YoY') {
            if (!change) return '';
            const sign = change >= 0 ? '+' : '';
            const color = change >= 0 ? '#059669' : '#dc2626';
            return '<span style="color: ' + color + '; font-weight: 600;">' + sign + change.toFixed(1) + '% ' + type + '</span>';
        }
        
        // ===================================
        // INTELLIGENT EMAIL GENERATION HELPERS
        // ===================================

        // Metric priority scoring - local intent metrics get highest priority
        const metricPriority = {
            // LOCAL INTENT METRICS (Highest Priority - these drive business)
            'Phone Calls': 100,
            'Phone Calls (Ads)': 98,
            'Directions Requests': 95,
            'Directions': 95,
            'Direction Requests': 95,
            'Restaurant Visits': 90,
            'Store visits': 90,
            'Reservations': 85,
            'Reservations Button': 85,
            'Orders': 80,
            'Online Orders': 80,

            // ENGAGEMENT METRICS (Medium-High Priority)
            'Customer Inquiries': 75,  // Form of local intent - inquiries about the restaurant
            'Catering Requests': 70,    // High-value catering leads
            'Information Requests': 65,  // General info requests
            'Website Clicks': 60,
            'Form Submissions': 55,
            'Contact Form': 50,
            'Private Events': 50,
            'Contact Us': 50,
            'Gift Cards': 45,

            // AWARENESS METRICS (Lower Priority)
            'Total Views': 30,
            'Impressions': 25,
            'Maps Views': 25,

            // VANITY METRICS (Lowest Priority)
            'Page Views': 15,
            'Sessions': 10,
            'Active Users': 10
        };

        // Check if a metric's growth is worth mentioning
        function shouldMentionGrowth(metric, value, change) {
            const priority = metricPriority[metric] || 30; // Default to medium-low

            // High-priority metrics: lower threshold
            const volumeThreshold = priority >= 80 ? 50 : priority >= 60 ? 200 : 500;

            // Don't mention if small absolute numbers with huge %
            // (e.g., 2 → 10 = +400% is not meaningful)
            if (value < volumeThreshold && Math.abs(change) > 100) {
                return false; // "Vanity growth" - ignore
            }

            // Don't mention low-priority metrics with low volume
            if (priority < 50 && value < 1000) {
                return false;
            }

            // DO mention if high-priority metric with any meaningful change
            if (priority >= 80 && Math.abs(change) >= 15) {
                return true;
            }

            // Medium-priority with strong absolute performance
            if (priority >= 60 && value >= volumeThreshold && Math.abs(change) >= 25) {
                return true;
            }

            return false;
        }

        // Score geographic insights for relevance
        function scoreGeographicInsight(location, users, change, homeMarket) {
            const isHomeTerritory = homeMarket && location.toLowerCase().includes(homeMarket.toLowerCase());

            // Calculate absolute impact
            const absoluteImpact = users * (Math.abs(change) / 100);

            let score = 0;

            // 1. Absolute volume matters most
            if (users >= 1000) score += 50;
            else if (users >= 500) score += 30;
            else if (users >= 100) score += 10;

            // 2. Home territory gets major boost
            if (isHomeTerritory) {
                score += 40;
                // Even small growth in home market matters
                if (change > 10) score += 20;
            } else {
                // Non-home markets need BOTH high volume AND growth
                if (users < 500 && change > 100) score -= 30; // Penalize "vanity growth"
                if (users >= 500 && change > 50) score += 15;  // Reward substantial new markets
            }

            // 3. Absolute impact
            score += Math.min(absoluteImpact / 10, 30);

            return score;
        }

        // Detect home market from restaurant name
        function detectHomeMarket(restaurantName) {
            const marketMappings = {
                'Nashville': ['Turkey and the Wolf', 'Hungry Eyes', 'Hot Stuff'],
                'San Francisco': ['Cote Ouest', '3rd Cousin', 'Nisei', 'Californios', 'Hot Johnnie'],
                'New Orleans': ['Turkey and the Wolf Icehouse', 'Hot Stuff'],
                'New York': ['Kei', 'Indigo'],
                'San Jose': ['District SJ', 'San Benito', 'Underdogs'],
                'Oakland': ['John\'s Grill'],
            };

            for (const [market, restaurants] of Object.entries(marketMappings)) {
                if (restaurants.some(r => restaurantName.includes(r))) {
                    return market;
                }
            }

            return null; // Unknown market
        }

        // Calculate impact score for a metric
        function calculateMetricImpactScore(metric, data) {
            const priority = metricPriority[metric] || 30;
            const value = data.value || 0;
            const change = data.yoy || data.mom || data.change || 0;
            const absoluteImpact = value * (Math.abs(change) / 100);

            // Impact = (Priority weight × 0.5) + (Absolute impact × 0.5)
            const score = (priority * 0.5) + (Math.min(absoluteImpact / 100, 50) * 0.5);

            return {
                metric,
                value,
                change,
                priority,
                absoluteImpact,
                score,
                shouldMention: shouldMentionGrowth(metric, value, change)
            };
        }

        function generateEmailReport() {
            if (Object.keys(dashboardData).length === 0) {
                alert('No data to generate report. Please parse data first.');
                return;
            }
            
            const now = new Date();
            // Use the parsed report period if available, otherwise use current date
            let reportMonth;
            let reportMonthYear;
            if (parserMetadata.reportPeriod && (parserMetadata.reportPeriod.startDate || parserMetadata.reportPeriod.current)) {
                // Extract month and year from the report period
                const dateStr = parserMetadata.reportPeriod.startDate || parserMetadata.reportPeriod.current;
                const periodDate = new Date(dateStr);
                if (!isNaN(periodDate.getTime())) {
                    reportMonth = periodDate.toLocaleDateString('en-US', { month: 'long' });
                    reportMonthYear = periodDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                } else {
                    reportMonth = now.toLocaleDateString('en-US', { month: 'long' });
                    reportMonthYear = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                }
            } else {
                reportMonth = now.toLocaleDateString('en-US', { month: 'long' });
                reportMonthYear = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            }
            
            // For display purposes, use just the month/year
            const today = reportMonthYear;
            const hour = now.getHours();
            
            // Determine greeting based on time
            let greeting = 'Good morning';
            if (hour >= 12 && hour < 17) greeting = 'Good afternoon';
            else if (hour >= 17) greeting = 'Good evening';
            
            // Use parsed business name or fallback
            const restaurantName = parserMetadata.businessName || 'your restaurant';
            
            // Add personalized name to greeting if restaurant is mapped
            console.log('Looking for restaurant:', restaurantName);
            const contactInfo = restaurantContacts[restaurantName] || restaurantContacts[restaurantName.trim()];
            console.log('Found contact info:', contactInfo);
            
            if (contactInfo && contactInfo.greeting !== 'Team') {
                greeting = `Hi ${contactInfo.greeting}`;
            } else if (contactInfo && contactInfo.greeting === 'Team') {
                greeting = `Hi Team`;
            }
            console.log('Final greeting:', greeting);
            
            // Check if dark mode is enabled
            const isDarkMode = document.getElementById('emailDarkMode').checked;
            
            // Save preference to localStorage
            localStorage.setItem('emailDarkMode', isDarkMode);
            
            // Define color schemes
            const colors = isDarkMode ? {
                // Dark mode colors
                bodyBg: 'transparent',          // Let Gmail's dark bg show through
                cardBg: '#1a1a1a',              // Dark card background
                headerText: '#ffffff',           // White for headers
                primaryText: '#e2e8f0',          // Light gray for main text
                secondaryText: '#94a3b8',        // Medium-light gray for secondary
                borderColor: '#374151',          // Dark gray borders
                tableBg: 'transparent',          // Transparent table backgrounds
                narrativeBg: '#6d28d9',          // Keep purple for narrative boxes
                linkColor: '#a78bfa',            // Lighter purple for links
                successColor: '#10b981',         // Green for positive metrics
                dangerColor: '#ef4444',          // Red for negative metrics
                channelText: '#e2e8f0',          // Light for channel names
                insightText: '#cbd5e1',          // Light gray for insights
                strongText: '#f3f4f6'            // Almost white for emphasis
            } : {
                // Light mode colors (current)
                bodyBg: '#f8f9fa',
                cardBg: '#ffffff',
                headerText: '#1e293b',
                primaryText: '#1e293b',
                secondaryText: '#475569',
                borderColor: '#e2e8f0',
                tableBg: '#ffffff',
                narrativeBg: '#6d28d9',
                linkColor: '#6d28d9',
                successColor: '#059669',
                dangerColor: '#dc2626',
                channelText: '#475569',
                insightText: '#64748b',
                strongText: '#0f172a'
            };
            
            // Get period-aware text
            const periodInfo = parserMetadata.reportPeriod || {};
            const periodLabel = periodInfo.periodLabel || 'this month';
            const periodType = periodInfo.periodType || 'month';
            const comparisonLabel = periodType === 'quarter' ? 'vs last quarter' : 
                                   periodType === 'year' ? 'vs last year' : 
                                   periodType === 'half-year' ? 'vs previous 6 months' :
                                   periodInfo.periodLength > 1 ? `vs previous ${periodInfo.periodLength} months` : 
                                   'vs last month';
            
            // Get top KPIs
            const topMetrics = ['Total Views', 'Phone Calls', 'Website Clicks', 'Directions Requests', 'Reservations Button', 'Total Cost'];
            const availableMetrics = topMetrics.filter(m => dashboardData[m]);
            
            // Calculate some key insights for the narrative
            const totalViews = dashboardData['Total Views']?.value || 0;
            const phoneCallsData = dashboardData['Phone Calls'] || {};
            const websiteClicksData = dashboardData['Website Clicks'] || {};
            
            // Find the best and worst performing metrics
            let bestMetric = null;
            let bestChange = -999;
            let worstMetric = null;
            let worstChange = 999;
            
            Object.keys(dashboardData).forEach(metric => {
                const change = dashboardData[metric].yoy || dashboardData[metric].mom || dashboardData[metric].change;
                if (change) {
                    if (change > bestChange) {
                        bestChange = change;
                        bestMetric = metric;
                    }
                    if (change < worstChange) {
                        worstChange = change;
                        worstMetric = metric;
                    }
                }
            });
            
            // Calculate total conversions
            let totalConversions = 0;
            const conversionMetrics = ['Phone Calls', 'Website Clicks', 'Directions Requests', 'Clicks to call', 
                                      'Website Phone Call', 'Reservations', 'Reservations Button', 'Online Orders',
                                      'Total Actions', 'Local Actions - Directions', 'reservation_button_click',
                                      'Contact Us', 'Store visits'];
            conversionMetrics.forEach(metric => {
                if (dashboardData[metric]) {
                    totalConversions += dashboardData[metric].value || 0;
                }
            });
            
            // Determine performance narrative type
            let narrativeType = 'balanced';
            const positiveMetrics = Object.values(dashboardData).filter(m => 
                (m.yoy > 0 || m.mom > 0 || m.change > 0)).length;
            const negativeMetrics = Object.values(dashboardData).filter(m => 
                (m.yoy < 0 || m.mom < 0 || m.change < 0)).length;
            
            if (positiveMetrics > negativeMetrics * 2) {
                narrativeType = 'growth';
            } else if (negativeMetrics > positiveMetrics * 2) {
                narrativeType = 'challenging';
            } else if (worstMetric === 'Total Views' && bestMetric && bestChange > 20) {
                narrativeType = 'efficiency'; // Quality over quantity
            }
            
            // Build the email HTML with professional table-based layout for maximum compatibility
            // Using refined color scheme and enhanced visual hierarchy
            let emailHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <meta name="supported-color-schemes" content="light dark">
    <!--[if !mso]><!-->
    <style>
        :root {
            color-scheme: light dark;
            supported-color-schemes: light dark;
        }
        
        @media (prefers-color-scheme: dark) {
            .dark-mode-bg { background-color: #1a1a1a !important; }
            .dark-mode-text { color: #ffffff !important; }
            .dark-mode-subtext { color: #e0e0e0 !important; }
            .dark-mode-card { background-color: #2d2d2d !important; }
            .dark-mode-border { border-color: #404040 !important; }
        }
        
        @media only screen and (max-width: 600px) {
            .mobile-container { width: 100% !important; min-width: 100% !important; }
            .mobile-padding { padding: 10px !important; }
            .mobile-padding-large { padding: 20px 15px !important; }
            .mobile-font-size { font-size: 16px !important; }
            .mobile-font-size-small { font-size: 14px !important; }
            .mobile-stack { width: 100% !important; display: block !important; }
            .mobile-center { text-align: center !important; }
            .mobile-hide { display: none !important; }
            .mobile-width-full { width: 100% !important; max-width: 100% !important; }
        }
    </style>
    <!--<![endif]-->
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background-color: ${colors.bodyBg};">
    <div style="display: none; max-height: 0; overflow: hidden;">
        ${restaurantName} ${reportMonth} Marketing Performance Report
    </div>
    <table cellpadding="0" cellspacing="0" border="0" width="100%" style="background-color: ${colors.bodyBg};">
        <tr>
            <td align="center" style="padding: 20px 0;">
                <table cellpadding="0" cellspacing="0" border="0" width="100%" style="max-width: 600px; min-width: 320px; background-color: ${colors.cardBg}; border-radius: 8px; ${isDarkMode ? '' : 'box-shadow: 0 1px 3px rgba(0,0,0,0.08);'}">
                    <!-- Header -->
                    <tr>
                        <td style="background: linear-gradient(135deg, #6d28d9 0%, #7c3aed 100%); padding: 25px 30px; border-radius: 8px 8px 0 0;">
                            <table cellpadding="0" cellspacing="0" border="0" width="100%">
                                <tr>
                                    <td style="text-align: center;">
                                        <h1 style="margin: 0; color: #ffffff; font-size: 22px; font-weight: 600; letter-spacing: -0.5px; text-transform: uppercase;">
                                            ${restaurantName} Performance Report
                                        </h1>
                                        <div style="margin: 8px auto 0 auto; width: 60px; height: 2px; background: rgba(255,255,255,0.5); border-radius: 2px;"></div>
                                        <p style="margin: 8px 0 0 0; color: #ffffff; font-size: 13px; font-weight: 500; letter-spacing: 0.3px;">
                                            ${today}
                                        </p>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                    <!-- Opening Narrative -->
                    <tr>
                        <td style="padding: 30px 30px 20px 30px;">
                            <p style="margin: 0 0 15px 0; color: ${colors.primaryText}; font-size: 15px; line-height: 1.6;">
                                ${greeting}, <br><br>I'm pleased to share ${today}'s marketing performance update for ${restaurantName}.
                            </p>
                            <p style="margin: 0 0 20px 0; color: ${colors.secondaryText}; font-size: 15px; line-height: 1.6;">
${(() => {
                                    let narrative = '';
                                    if (narrativeType === 'growth') {
                                        narrative = "We're experiencing exceptional growth across key metrics. ";
                                        if (bestMetric) {
                                            narrative += '<strong style="color: ' + colors.strongText + ';">' + getDisplayName(bestMetric) + '</strong> surged by <span style="color: ' + colors.successColor + '; font-weight: 600;">' + formatPercentageChange(bestChange) + '</span>, leading strong performance across the board.';
                                        } else {
                                            narrative += 'Multiple metrics show significant positive momentum.';
                                        }
                                    } else if (narrativeType === 'efficiency') {
                                        narrative = 'While overall visibility ' + (worstChange < -20 ? 'decreased' : 'moderated') + ", we've achieved remarkable efficiency gains. ";
                                        if (bestMetric) {
                                            narrative += '<strong style="color: ' + colors.strongText + ';">' + getDisplayName(bestMetric) + '</strong> improved by <span style="color: ' + colors.successColor + '; font-weight: 600;">' + formatPercentageChange(bestChange) + '</span>, demonstrating that we\'re attracting higher-quality, more engaged customers.';
                                        } else {
                                            narrative += 'Our conversion metrics show significant improvement.';
                                        }
                                    } else if (narrativeType === 'challenging') {
                                        narrative = periodLabel.charAt(0).toUpperCase() + periodLabel.slice(1) + ' presented challenges across several metrics, but we\'ve identified clear opportunities for improvement. ';
                                        if (bestMetric && bestChange > 0) {
                                            narrative += 'Notably, <strong style="color: ' + colors.strongText + ';">' + getDisplayName(bestMetric) + '</strong> showed resilience with a <span style="color: ' + colors.successColor + '; font-weight: 600;">' + formatPercentageChange(bestChange) + '</span> increase.';
                                        } else {
                                            narrative += "Let's focus on the actionable insights to drive recovery.";
                                        }
                                    } else {
                                        narrative = "We're seeing mixed results " + periodLabel + " with both wins and areas for optimization. ";
                                        if (bestMetric && bestChange > 0) {
                                            narrative += '<strong style="color: ' + colors.strongText + ';">' + getDisplayName(bestMetric) + '</strong> led performance with a <span style="color: ' + colors.successColor + '; font-weight: 600;">' + formatPercentageChange(bestChange) + '</span> increase';
                                        } else {
                                            narrative += 'Key metrics show varied performance';
                                        }
                                        if (worstMetric && worstChange < 0) {
                                            narrative += ', while ' + getDisplayName(worstMetric) + ' requires attention.';
                                        } else {
                                            narrative += '.';
                                        }
                                    }
                                    return narrative;
                                })()}
                            </p>
                            ${parserMetadata.confidence && parserMetadata.confidence.overall < 0.7 ? 
                                `<table cellpadding="0" cellspacing="0" border="0" width="100%" style="margin-top: 15px;">
                                    <tr>
                                        <td style="padding: 12px 15px; background: #fef3c7; border-left: 3px solid #d97706; border-radius: 4px;">
                                            <p style="margin: 0; color: #78350f; font-size: 13px; line-height: 1.5; font-weight: 500;">
                                                <strong style="color: #92400e;">⚠ Note:</strong> Some metrics were extracted with lower confidence. Please review for accuracy.
                                            </p>
                                        </td>
                                    </tr>
                                </table>` : ''}
                        </td>
                    </tr>
                    
                    <!-- Key Metrics Section -->
                    <tr>
                        <td style="padding: 15px 30px 30px 30px;" class="mobile-padding-large">
                            <h2 style="margin: 0 0 20px 0; color: ${colors.headerText}; font-size: 18px; font-weight: 600; letter-spacing: -0.3px;">
                                Key Performance Indicators
                            </h2>
                            <table cellpadding="0" cellspacing="0" border="0" width="100%">`;
            
            // Select exactly 6 KPIs with reservation priority
            const selectedKPIs = [];
            const reservationMetrics = [];
            const positiveGrowthMetrics = [];
            const otherMetrics = [];
            
            // Categorize all metrics
            Object.keys(dashboardData).forEach(metric => {
                // Skip metrics with non-US country names
                if (containsNonUSCountry(metric)) {
                    return;
                }
                
                const data = dashboardData[metric];
                if (!data || !data.value) return;
                
                // Smart metric selection: choose the better-looking metric (YoY vs MoM)
                let change, changeType;
                const yoy = data.yoy || 0;
                const mom = data.mom || 0;
                
                // If both are positive, choose the larger one
                if (yoy >= 0 && mom >= 0) {
                    change = Math.max(yoy, mom);
                    changeType = change === yoy ? 'YoY' : 'MoM';
                }
                // If one is positive and one is negative, choose the positive one
                else if (yoy >= 0 || mom >= 0) {
                    change = yoy >= 0 ? yoy : mom;
                    changeType = yoy >= 0 ? 'YoY' : 'MoM';
                }
                // If both are negative, choose the less negative one (closer to 0)
                else {
                    change = Math.max(yoy, mom);
                    changeType = change === yoy ? 'YoY' : 'MoM';
                }
                
                // Fall back to any available change if neither YoY nor MoM exist
                if (!data.yoy && !data.mom) {
                    change = data.change || 0;
                    changeType = 'vs prev';
                }
                
                // Store the selected change type in the data
                data.selectedChangeType = changeType;
                data.selectedChange = change;
                
                const metricLower = metric.toLowerCase();
                
                // Check if it's a reservation-related metric (including aggregated)
                if (metricLower.includes('reservation') || 
                    metricLower.includes('booking') || 
                    metricLower.includes('table') ||
                    metric === 'Reservations Button' ||
                    metric === 'reservation_button_click' ||
                    metric === 'Reservations') {
                    reservationMetrics.push({ metric, data, change });
                } 
                // Check if it's a core KPI with positive growth
                else if (change > 0 && (
                    metric === 'Total Views' ||
                    metric === 'Phone Calls' ||
                    metric === 'Website Clicks' ||
                    metric === 'Directions Requests' ||
                    metric === 'Total Cost' ||
                    metric === 'New Users' ||
                    metric === 'Active users' ||
                    metric === 'Sessions' ||
                    metric === 'Total revenue' ||
                    metricLower.includes('gift card') ||
                    metricLower.includes('catering') ||
                    metricLower.includes('private event')
                )) {
                    positiveGrowthMetrics.push({ metric, data, change });
                }
                // Other important metrics
                else if (
                    metric === 'Total Views' ||
                    metric === 'Phone Calls' ||
                    metric === 'Website Clicks' ||
                    metric === 'Directions Requests' ||
                    metric === 'Total Cost' ||
                    metric === 'New Users'
                ) {
                    otherMetrics.push({ metric, data, change });
                }
            });
            
            // Sort by value or change to get the most impressive metrics
            reservationMetrics.sort((a, b) => b.data.value - a.data.value);
            positiveGrowthMetrics.sort((a, b) => b.change - a.change);
            otherMetrics.sort((a, b) => b.data.value - a.data.value);
            
            // Build the final list of 6 KPIs
            // First add all reservation metrics
            reservationMetrics.forEach(m => {
                if (selectedKPIs.length < 6) {
                    selectedKPIs.push(m);
                }
            });
            
            // Then add positive growth metrics
            positiveGrowthMetrics.forEach(m => {
                if (selectedKPIs.length < 6 && !selectedKPIs.find(s => s.metric === m.metric)) {
                    selectedKPIs.push(m);
                }
            });
            
            // Finally add other important metrics if needed
            otherMetrics.forEach(m => {
                if (selectedKPIs.length < 6 && !selectedKPIs.find(s => s.metric === m.metric)) {
                    selectedKPIs.push(m);
                }
            });
            
            // Ensure we have exactly 6 metrics
            selectedKPIs.splice(6);
            
            // Add KPI cards (3 per row for exactly 6 cards)
            selectedKPIs.forEach((kpiData, index) => {
                const { metric, data } = kpiData;
                // Use the smart-selected change value and type
                const change = data.selectedChange || kpiData.change;
                const changeType = data.selectedChangeType || 'vs prev';
                const displayName = getDisplayName(metric);
                const changeColor = change >= 0 ? '#059669' : '#dc2626';
                const changeIcon = change >= 0 ? '↑' : '↓';
                
                // Uniform styling for all metrics
                const cardBackground = '#f8fafc';
                const borderColor = '#e2e8f0';
                const labelColor = '#64748b';
                
                if (index % 3 === 0) {
                    emailHTML += '<tr>';
                }
                
                emailHTML += `
                    <td width="33.33%" style="padding: 6px; vertical-align: top;" class="mobile-stack mobile-padding">
                        <table cellpadding="0" cellspacing="0" border="0" width="100%" style="background: ${isDarkMode ? colors.cardBg : cardBackground}; border: 1px solid ${isDarkMode ? colors.borderColor : borderColor}; border-radius: 8px;">
                            <tr>
                                <td style="padding: 16px; height: 100px; vertical-align: top;">
                                    <table cellpadding="0" cellspacing="0" border="0" width="100%" style="height: 100%;">
                                        <tr>
                                            <td style="height: 20px; vertical-align: top;">
                                                <p style="margin: 0; color: ${isDarkMode ? colors.secondaryText : labelColor}; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; line-height: 1;">
                                                    ${displayName}
                                                </p>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="height: 40px; vertical-align: middle;">
                                                <p style="margin: 0; color: ${isDarkMode ? colors.primaryText : '#0f172a'}; font-size: 20px; font-weight: 600; letter-spacing: -0.5px; line-height: 1; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;">
                                                    ${metric === 'Total Cost' || metric.includes('Cost') ? formatValue(data.value, true) : formatValue(data.value)}
                                                </p>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="height: 20px; vertical-align: bottom;">
                                                ${change !== undefined && change !== null ? `
                                                <p style="margin: 0; font-size: 12px; font-weight: 600; line-height: 1;">
                                                    <span style="color: ${isDarkMode ? (change >= 0 ? colors.successColor : colors.dangerColor) : changeColor};">${changeIcon}</span>
                                                    <span style="color: ${isDarkMode ? (change >= 0 ? colors.successColor : colors.dangerColor) : changeColor};">${formatPercentageChange(change).replace(/[+-]/, '')}</span>
                                                    <span style="color: ${isDarkMode ? colors.secondaryText : labelColor}; font-weight: 400; font-size: 10px; text-transform: uppercase; letter-spacing: 0.3px;"> ${changeType}</span>
                                                </p>` : '<p style="margin: 0; color: #94a3b8; font-size: 10px; line-height: 1;">—</p>'}
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                    </td>`;
                
                if (index % 3 === 2 || index === selectedKPIs.length - 1) {
                    // Fill empty cells if needed
                    while ((index % 3) < 2) {
                        emailHTML += '<td width="33.33%" style="padding: 6px;"></td>';
                        index++;
                    }
                    emailHTML += '</tr>';
                }
            });
            
            emailHTML += `
                            </table>
                        </td>
                    </tr>
                    
                    <!-- Google Ads Conversion Performance -->
                    ${(() => {
                        // Get all conversion actions from dashboardData that are marked as conversion actions
                        const conversionData = [];
                        Object.keys(dashboardData).forEach(metric => {
                            // Skip metrics with non-US country names
                            if (containsNonUSCountry(metric)) {
                                return;
                            }
                            
                            const data = dashboardData[metric];
                            // Filter out "Total" entries, aggregated items, and only include real conversion actions
                            if (data.isConversionAction === true && 
                                !data.aggregatedInto &&
                                !metric.toLowerCase().includes('total') && 
                                metric !== 'Total') {
                                conversionData.push({
                                    name: metric,
                                    displayName: getDisplayName(metric),
                                    value: data.value,
                                    change: data.change || data.yoy || data.mom || 0
                                });
                            }
                        });
                        
                        if (conversionData.length > 0 && dashboardData['Total Cost']) {
                            // Sort by value descending
                            conversionData.sort((a, b) => b.value - a.value);
                            const totalCost = dashboardData['Total Cost'].value || 0;
                            
                            // Limit to top 8 for email readability
                            const displayData = conversionData.slice(0, 8);
                            const hasMore = conversionData.length > 8;
                            
                            return `
                    <tr>
                        <td style="padding: 0 30px 30px 30px;" class="mobile-padding">
                            <h2 style="margin: 0 0 20px 0; color: ${colors.headerText}; font-size: 18px; font-weight: 600; letter-spacing: -0.3px;">
                                Google Ads Conversion Performance
                            </h2>
                            
                            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="background: ${colors.tableBg}; border: 1px solid ${colors.borderColor}; border-radius: 8px;">
                                <thead>
                                    <tr style="background: ${isDarkMode ? 'rgba(109, 40, 217, 0.1)' : 'rgba(139, 92, 246, 0.05)'};">
                                        <th style="padding: 14px 18px; text-align: left; color: ${colors.primaryText}; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border-radius: 8px 0 0 0;">
                                            Conversion Action
                                        </th>
                                        <th style="padding: 14px 18px; text-align: center; color: ${colors.primaryText}; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border-radius: 0 8px 0 0;">
                                            Volume
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${displayData.map((conversion, index) => {
                                        const costPerConv = conversion.value > 0 ? (totalCost / conversion.value).toFixed(2) : null;
                                        const changeColor = conversion.change > 0 ? colors.successColor : conversion.change < 0 ? colors.dangerColor : colors.secondaryText;
                                        const changeIcon = conversion.change > 0 ? '↑' : conversion.change < 0 ? '↓' : '—';
                                        
                                        // Highlight top performer with subtle purple background
                                        const isTopPerformer = index === 0;
                                        const rowBg = isTopPerformer 
                                            ? (isDarkMode ? 'rgba(109, 40, 217, 0.15)' : 'rgba(139, 92, 246, 0.08)')
                                            : 'transparent';
                                        
                                        return `
                                    <tr style="background: ${rowBg};">
                                        <td style="padding: 16px 18px; border-bottom: 1px solid ${colors.borderColor};">
                                            <div>
                                                <strong style="color: ${colors.primaryText}; font-size: 14px; font-weight: 600;">
                                                    ${conversion.displayName}
                                                </strong>
                                                <div style="color: ${colors.secondaryText}; font-size: 11px; margin-top: 2px;">from Google Ads</div>
                                            </div>
                                        </td>
                                        <td style="padding: 16px 18px; text-align: center; border-bottom: 1px solid ${colors.borderColor};">
                                            <span style="font-size: 15px; font-weight: 600; color: ${colors.primaryText}; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;">
                                                ${formatValue(conversion.value)}
                                            </span>
                                        </td>
                                    </tr>`;
                                    }).join('')}
                                    ${hasMore ? `
                                    <tr>
                                        <td colspan="2" style="padding: 12px 18px; text-align: center; border-bottom: 1px solid ${colors.borderColor}; color: ${colors.secondaryText}; font-style: italic; font-size: 12px;">
                                            +${conversionData.length - 8} more conversion actions
                                        </td>
                                    </tr>` : ''}
                                </tbody>
                                <tfoot>
                                    <tr style="background: ${isDarkMode ? 'rgba(109, 40, 217, 0.1)' : 'rgba(139, 92, 246, 0.05)'};">
                                        <td style="padding: 14px 18px; border-radius: 0 0 0 8px;">
                                            <strong style="color: ${colors.primaryText}; font-size: 13px; text-transform: uppercase;">
                                                Total${hasMore ? ' (All Actions)' : ''}
                                            </strong>
                                        </td>
                                        <td style="padding: 14px 18px; text-align: center; border-radius: 0 0 8px 0;">
                                            <strong style="color: ${colors.primaryText}; font-size: 15px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;">
                                                ${formatValue(conversionData.reduce((sum, c) => sum + c.value, 0))}
                                            </strong>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                            
                            <!-- Google Ads Value Proposition -->
                            ${dashboardData['Total Cost'] ? `
                            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="margin-top: 16px;">
                                <tr>
                                    <td style="padding: 12px; background: ${colors.narrativeBg}; border-radius: 4px;">
                                        <p style="margin: 0; color: #ffffff; font-size: 13px; line-height: 1.5;">
                                            <strong style="color: #ffffff;">ROI:</strong> 
                                            ${(() => {
                                                const totalCost = dashboardData['Total Cost'].value || 0;
                                                
                                                // Get conversion action data
                                                const conversionActions = [];
                                                let totalAdsConversions = 0;
                                                Object.keys(dashboardData).forEach(metric => {
                                                    const data = dashboardData[metric];
                                                    if (data.isConversionAction === true) {
                                                        conversionActions.push({
                                                            name: metric,
                                                            displayName: getDisplayName(metric),
                                                            value: data.value,
                                                            change: data.change || data.yoy || data.mom || 0
                                                        });
                                                        totalAdsConversions += data.value;
                                                    }
                                                });
                                                
                                                // Sort to find highest value actions
                                                conversionActions.sort((a, b) => b.value - a.value);
                                                
                                                // Find key aggregated conversion types
                                                const phoneCallsAds = conversionActions.find(a => a.displayName === 'Phone Calls (Ads)');
                                                const reservations = conversionActions.find(a => a.displayName === 'Reservations');
                                                const restaurantVisits = conversionActions.find(a => a.displayName === 'Restaurant Visits');
                                                const onlineOrders = conversionActions.find(a => a.displayName === 'Online Orders');
                                                
                                                // Build informative narrative
                                                const costPerAction = totalAdsConversions > 0 ? (totalCost / totalAdsConversions).toFixed(2) : 0;
                                                let narrative = `Your <strong>${formatValue(totalCost, true)}</strong> investment generated <strong>${formatValue(totalAdsConversions)}</strong> customer actions`;
                                                
                                                // Add specific highlights for aggregated metrics
                                                const highlights = [];
                                                if (reservations && reservations.value > 0) {
                                                    highlights.push(`<strong>${formatValue(reservations.value)}</strong> reservations`);
                                                }
                                                if (phoneCallsAds && phoneCallsAds.value > 0) {
                                                    highlights.push(`<strong>${formatValue(phoneCallsAds.value)}</strong> phone inquiries`);
                                                }
                                                if (restaurantVisits && restaurantVisits.value > 0) {
                                                    highlights.push(`<strong>${formatValue(restaurantVisits.value)}</strong> restaurant visits`);
                                                }
                                                
                                                if (highlights.length > 0) {
                                                    narrative += `, including ${highlights.join(', ')}`;
                                                }
                                                
                                                if (costPerAction > 0) {
                                                    narrative += ` at <strong>$${costPerAction}</strong> per action. `;
                                                    
                                                    // Add context based on cost efficiency
                                                    if (costPerAction < 10) {
                                                        narrative += `This cost efficiency is excellent for the restaurant industry.`;
                                                    } else if (costPerAction < 25) {
                                                        narrative += `Solid ROI with room to optimize further.`;
                                                    } else {
                                                        narrative += `Focus on improving conversion rates to reduce cost per action.`;
                                                    }
                                                } else {
                                                    narrative += '.';
                                                }
                                                
                                                return narrative;
                                            })()}
                                        </p>
                                    </td>
                                </tr>
                            </table>` : ''}
                        </td>
                    </tr>`;
                        } else {
                            return '';
                        }
                    })()}
                    
                    <!-- Mid-report Narrative -->
                    <tr>
                        <td style="padding: 0 30px 20px 30px;" class="mobile-padding">
                            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="background: ${colors.narrativeBg}; border-radius: 6px;">
                                <tr>
                                    <td style="padding: 18px;">
                                        <p style="margin: 0; color: #ffffff; font-size: 14px; line-height: 1.6;">
                                            <strong style="color: #ffffff;">Quick Stats:</strong> 
${(() => {
                                    let text = 'We captured <strong>' + formatValue(totalConversions) + '</strong> customer actions in ' + reportMonth;
                                    
                                    // Add context about growth
                                    if (totalConversions > 1000) {
                                        text += ', showing strong market demand. ';
                                    } else if (totalConversions > 500) {
                                        text += ', maintaining steady engagement. ';
                                    } else {
                                        text += '. ';
                                    }
                                    
                                    if (dashboardData['Phone Calls'] && phoneCallsData.value) {
                                        text += 'Phone calls reached <strong>' + formatValue(phoneCallsData.value) + '</strong>';
                                        if (phoneCallsData.yoy) {
                                            const trend = phoneCallsData.yoy > 0 ? 'up' : 'down';
                                            text += ', ' + trend + ' ' + formatPercentageChange(phoneCallsData.yoy).replace(/[+-]/, '') + ' YoY';
                                            if (phoneCallsData.yoy > 10) {
                                                text += '. Customers are increasingly calling for reservations.';
                                            } else if (phoneCallsData.yoy < -10) {
                                                text += '. Consider promoting your phone number more prominently.';
                                            } else {
                                                text += '.';
                                            }
                                        } else {
                                            text += '.';
                                        }
                                    }
                                    return text;
                                })()}
                                        </p>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                    
                    <!-- New Users by Channel Visualization -->
                    <tr>
                        <td style="padding: 0 30px 30px 30px;">
                            <h2 style="margin: 0 0 20px 0; color: ${colors.headerText}; font-size: 18px; font-weight: 600; letter-spacing: -0.3px;">
                                New Users by Channel
                            </h2>
                            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="background: ${colors.tableBg}; border: 1px solid ${colors.borderColor}; border-radius: 6px; padding: 20px;">
                                <tr>
                                    <td>
                                        ${(() => {
                                            // Extract channel data from dashboardData - comprehensive search
                                            const channels = [
                                                { name: 'Organic Search', key: ['Organic Search', 'organic search', 'Organic', 'organic_search', 'Organic Search sessions', 'Organic Search users'], color: '#6d28d9' },
                                                { name: 'Direct', key: ['Direct', 'direct', 'Direct Traffic', 'Direct sessions', 'Direct users', 'direct_traffic'], color: '#6d28d9' },
                                                { name: 'Google Ads', key: ['Google Ads', 'google ads', 'Paid Search', 'paid search', 'Cross-network', 'cross-network', 'paid_search', 'cross_network', 'cpc'], color: '#6d28d9' },
                                                { name: 'Organic Social', key: ['Organic Social', 'organic social', 'Social', 'social', 'Social Media', 'organic_social', 'social_media'], color: '#6d28d9' },
                                                { name: 'Paid Social', key: ['Paid Social', 'paid social', 'paid_social'], color: '#6d28d9' },
                                                { name: 'Email', key: ['Email', 'email', 'Email Marketing', 'email_marketing'], color: '#6d28d9' },
                                                { name: 'Referral', key: ['Referral', 'referral', 'Referrals', 'referral_traffic'], color: '#6d28d9' },
                                                { name: 'Display', key: ['Display', 'display', 'Display ads', 'display_ads'], color: '#6d28d9' },
                                                { name: 'Unassigned', key: ['Unassigned', 'unassigned', '(not set)', 'not_set'], color: '#6d28d9' }
                                            ];
                                            
                                            let channelData = [];
                                            let maxValue = 0;
                                            
                                            // First try to find direct channel data (from extractChannelPerformance)
                                            channels.forEach(channel => {
                                                // Check for direct channel data stored with isChannel flag
                                                Object.keys(dashboardData).forEach(key => {
                                                    const data = dashboardData[key];
                                                    if (data && data.isChannel && data.name === channel.name) {
                                                        const existing = channelData.find(c => c.name === channel.name);
                                                        if (!existing) {
                                                            channelData.push({
                                                                name: channel.name,
                                                                value: data.value || data.sessions || 0,
                                                                change: data.yoy || data.change || 0,
                                                                color: channel.color
                                                            });
                                                            maxValue = Math.max(maxValue, data.value || data.sessions || 0);
                                                        }
                                                    }
                                                });
                                            });
                                            
                                            // If no direct channel data found, try comprehensive search
                                            if (channelData.length === 0) {
                                                Object.keys(dashboardData).forEach(metric => {
                                                    const data = dashboardData[metric];
                                                    if (!data || !data.value) return;
                                                    
                                                    const metricLower = metric.toLowerCase();
                                                    
                                                    // Check if this metric contains channel data
                                                    channels.forEach(channel => {
                                                        let matched = false;
                                                        
                                                        // Check all key variations
                                                        channel.key.forEach(key => {
                                                            const keyLower = key.toLowerCase();
                                                            
                                                            // More flexible matching
                                                            if (!matched && (
                                                                metricLower === keyLower ||
                                                                metricLower.includes(keyLower + ' users') ||
                                                                metricLower.includes(keyLower + ' sessions') ||
                                                                metricLower.includes(keyLower + ' traffic') ||
                                                                (metricLower.includes(keyLower) && (metricLower.includes('user') || metricLower.includes('session') || metricLower.includes('traffic')))
                                                            )) {
                                                                // Check if we already have this channel
                                                                const existing = channelData.find(c => c.name === channel.name);
                                                                if (!existing) {
                                                                    channelData.push({
                                                                        name: channel.name,
                                                                        value: data.value,
                                                                        change: data.yoy || data.mom || data.change || 0,
                                                                        color: channel.color
                                                                    });
                                                                    maxValue = Math.max(maxValue, data.value);
                                                                    matched = true;
                                                                }
                                                            }
                                                        });
                                                    });
                                                });
                                            }
                                            
                                            // If no channel data found, use sample data for demonstration
                                            if (channelData.length === 0) {
                                                channelData = [
                                                    { name: 'Organic Search', value: 8500, change: 5.4, color: '#6d28d9' },
                                                    { name: 'Direct', value: 4700, change: 27.4, color: '#6d28d9' },
                                                    { name: 'Paid Search', value: 3200, change: -12.3, color: '#6d28d9' },
                                                    { name: 'Social', value: 1800, change: 15.2, color: '#6d28d9' },
                                                    { name: 'Email', value: 950, change: -8.1, color: '#6d28d9' },
                                                    { name: 'Referral', value: 650, change: 22.7, color: '#6d28d9' }
                                                ];
                                                maxValue = 8500;
                                            }
                                            
                                            // Sort by value descending
                                            channelData.sort((a, b) => b.value - a.value);
                                            
                                            let visualization = '';
                                            
                                            channelData.forEach(channel => {
                                                const barWidth = Math.max(5, (channel.value / maxValue) * 100);
                                                const changeIcon = channel.change >= 0 ? '↑' : '↓';
                                                const changeColor = channel.change >= 0 ? colors.successColor : colors.dangerColor;
                                                
                                                visualization += `
                                        <table cellpadding="0" cellspacing="0" border="0" width="100%" style="margin-bottom: 20px;">
                                            <tr>
                                                <td style="padding-bottom: 6px;">
                                                    <table cellpadding="0" cellspacing="0" border="0" width="100%">
                                                        <tr>
                                                            <td width="35%" style="vertical-align: middle;">
                                                                <p style="margin: 0; color: ${colors.channelText}; font-size: 13px; font-weight: 500;">${channel.name}</p>
                                                            </td>
                                                            <td width="35%" style="text-align: center; vertical-align: middle;">
                                                                <span style="color: ${colors.primaryText}; font-size: 15px; font-weight: 600; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;">${formatValue(channel.value)}</span>
                                                            </td>
                                                            <td width="30%" style="text-align: right; vertical-align: middle;">
                                                                <span style="color: ${changeColor}; font-size: 12px; font-weight: 600;">
                                                                    ${changeIcon} ${formatPercentageChange(channel.change).replace(/[+-]/, '')}
                                                                </span>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <div style="width: 100%; height: 20px; background: ${isDarkMode ? 'rgba(139, 92, 246, 0.1)' : 'rgba(139, 92, 246, 0.08)'}; border-radius: 4px; overflow: hidden;">
                                                        <div style="width: ${barWidth}%; height: 20px; background: linear-gradient(90deg, #8b5cf6, #9333ea); border-radius: 4px;"></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </table>`;
                                            });
                                            
                                            return visualization;
                                        })()}
                                        
                                        <!-- Summary -->
                                        <table cellpadding="0" cellspacing="0" border="0" width="100%" style="margin-top: 20px; padding-top: 16px; border-top: 1px solid ${colors.borderColor};">
                                            <tr>
                                                <td>
                                                    <p style="margin: 0; color: ${colors.insightText}; font-size: 12px; line-height: 1.6;">
                                                        <strong style="color: ${colors.insightText};">Channel Insights:</strong> 
                                                        ${(() => {
                                                            const newUsers = dashboardData['New users'] || dashboardData['New Users'] || dashboardData['Active users'];
                                                            let text = '';
                                                            
                                                            if (newUsers && newUsers.value) {
                                                                // Smart metric selection: choose the better metric
                                                                const yoy = newUsers.yoy || 0;
                                                                const mom = newUsers.mom || 0;
                                                                let change, changeType;
                                                                
                                                                // Apply same logic as KPI cards
                                                                if (yoy >= 0 && mom >= 0) {
                                                                    change = Math.max(yoy, mom);
                                                                    changeType = change === yoy ? 'YoY' : 'vs prev period';
                                                                } else if (yoy >= 0 || mom >= 0) {
                                                                    change = yoy >= 0 ? yoy : mom;
                                                                    changeType = yoy >= 0 ? 'YoY' : 'vs prev period';
                                                                } else {
                                                                    change = Math.max(yoy, mom);
                                                                    changeType = change === yoy ? 'YoY' : 'vs prev period';
                                                                }
                                                                
                                                                // Fall back if neither exists
                                                                if (!newUsers.yoy && !newUsers.mom) {
                                                                    change = newUsers.change || 0;
                                                                    changeType = 'vs prev period';
                                                                }
                                                                
                                                                text = `Acquired <strong style="color: ${colors.strongText};">${formatValue(newUsers.value)}</strong> new users`;
                                                                
                                                                if (change) {
                                                                    const trend = change > 0 ? 'up' : 'down';
                                                                    text += `, ${trend} ${formatPercentageChange(change).replace(/[+-]/, '')} ${changeType}. `;
                                                                } else {
                                                                    text += ' this period. ';
                                                                }
                                                                
                                                                // Add insight about top channels from the data above
                                                                const organicData = dashboardData['Organic Search'] || dashboardData['organic_search'];
                                                                const directData = dashboardData['Direct'] || dashboardData['direct'];
                                                                
                                                                if (organicData && organicData.value > 5000) {
                                                                    text += 'Organic search is your powerhouse channel, ';
                                                                    if (organicData.yoy > 10) {
                                                                        text += 'and it continues to grow. SEO investments are paying off.';
                                                                    } else {
                                                                        text += 'maintain your SEO momentum.';
                                                                    }
                                                                } else if (directData && directData.value > 3000) {
                                                                    text += 'Strong direct traffic indicates good brand recognition. ';
                                                                    text += 'Keep building that customer loyalty.';
                                                                } else {
                                                                    text += 'Focus on your top channels shown above for maximum impact.';
                                                                }
                                                            } else {
                                                                text = 'Traffic is distributed across multiple channels. Monitor the breakdown above to identify growth opportunities.';
                                                            }
                                                            
                                                            return text;
                                                        })()}
                                                    </p>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                    
                    <!-- Strategic Recommendations -->
                    <tr>
                        <td style="padding: 0 30px 30px 30px;">
                            <h2 style="margin: 0 0 20px 0; color: ${colors.headerText}; font-size: 18px; font-weight: 600; letter-spacing: -0.3px;">
                                Next Steps
                            </h2>
                            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="background: ${colors.narrativeBg}; border-radius: 6px;">
                                <tr>
                                    <td style="padding: 18px;">
                                <p style="margin: 0 0 12px 0; color: #ffffff; font-size: 14px; line-height: 1.6;">
                                    Key opportunities:
                                </p>
                                <ul style="margin: 0; padding-left: 20px; color: #ffffff;">
${(() => {
                                        let items = '';
                                        
                                        // Analyze channel data from the New Users by Channel section
                                        const channelInsights = [];
                                        
                                        // Get channel data that was extracted earlier
                                        Object.keys(dashboardData).forEach(metric => {
                                            // Skip metrics with non-US country names
                                            if (containsNonUSCountry(metric)) {
                                                return;
                                            }
                                            
                                            const data = dashboardData[metric];
                                            if (!data || !data.value) return;
                                            
                                            const metricLower = metric.toLowerCase();
                                            const change = data.yoy || data.mom || data.change || 0;
                                            
                                            // Identify channel metrics
                                            if ((metricLower.includes('organic') && (metricLower.includes('user') || metricLower.includes('session') || metricLower.includes('traffic'))) ||
                                                (metricLower.includes('direct') && (metricLower.includes('user') || metricLower.includes('session') || metricLower.includes('traffic'))) ||
                                                (metricLower.includes('paid') && (metricLower.includes('user') || metricLower.includes('session'))) ||
                                                (metricLower.includes('social') && (metricLower.includes('user') || metricLower.includes('session'))) ||
                                                (metricLower.includes('email') && (metricLower.includes('user') || metricLower.includes('session'))) ||
                                                (metricLower.includes('referral') && (metricLower.includes('user') || metricLower.includes('session')))) {
                                                
                                                let channelName = '';
                                                if (metricLower.includes('organic')) channelName = 'Organic Search';
                                                else if (metricLower.includes('direct')) channelName = 'Direct';
                                                else if (metricLower.includes('paid') || metricLower.includes('google ads')) channelName = 'Paid Search';
                                                else if (metricLower.includes('social')) channelName = 'Social';
                                                else if (metricLower.includes('email')) channelName = 'Email';
                                                else if (metricLower.includes('referral')) channelName = 'Referral';
                                                
                                                if (channelName && !containsNonUSCountry(channelName)) {
                                                    channelInsights.push({
                                                        channel: channelName,
                                                        value: data.value,
                                                        change: change
                                                    });
                                                }
                                            }
                                        });
                                        
                                        // Sort channels by growth rate
                                        const growthChannels = channelInsights.filter(c => c.change > 10).sort((a, b) => b.change - a.change);
                                        const decliningChannels = channelInsights.filter(c => c.change < -5).sort((a, b) => a.change - b.change);
                                        const topTrafficChannels = channelInsights.sort((a, b) => b.value - a.value).slice(0, 2);
                                        
                                        // Build recommendations based on channel performance
                                        if (growthChannels.length > 0) {
                                            const topGrowth = growthChannels[0];
                                            items += '<li style="margin-bottom: 10px; font-size: 14px;"><strong>' + topGrowth.channel + ' (' + topGrowth.change.toFixed(0) + '% growth):</strong> Your best performer in ' + reportMonth + '. Double down on ';
                                            if (topGrowth.channel === 'Organic Search') {
                                                items += 'content creation and local SEO. Update your Google Business Profile weekly.';
                                            } else if (topGrowth.channel === 'Direct') {
                                                items += 'brand awareness campaigns. Your reputation is driving direct visits.';
                                            } else if (topGrowth.channel === 'Paid Search') {
                                                items += 'these campaigns. Increase budget by 15-20% on top performers.';
                                            } else {
                                                items += 'this channel with increased investment and testing.';
                                            }
                                            items += '</li>';
                                        }
                                        
                                        if (decliningChannels.length > 0) {
                                            const worstDecline = decliningChannels[0];
                                            items += '<li style="margin-bottom: 10px; font-size: 14px;"><strong>' + worstDecline.channel + ' optimization opportunity:</strong> ';
                                            if (worstDecline.channel === 'Email') {
                                                items += 'Time to refresh your email strategy. A/B test new subject lines and preview text for quick wins.';
                                            } else if (worstDecline.channel === 'Social') {
                                                items += 'Perfect timing to test new content formats. Short-form video is driving 2x engagement for restaurants.';
                                            } else if (worstDecline.channel === 'Paid Search' || worstDecline.channel === 'Paid Social') {
                                                items += 'Budget can be reallocated to higher-performing channels while we test new creative approaches.';
                                            } else {
                                                items += 'This presents an opportunity to test fresh approaches and capture untapped audience segments.';
                                            }
                                            items += '</li>';
                                        }
                                        
                                        // Check for channel diversification
                                        if (topTrafficChannels.length > 0) {
                                            const topChannel = topTrafficChannels[0];
                                            const totalTraffic = channelInsights.reduce((sum, c) => sum + c.value, 0);
                                            const topChannelShare = (topChannel.value / totalTraffic) * 100;
                                            
                                            if (topChannelShare > 40) {
                                                items += '<li style="margin-bottom: 10px; font-size: 14px;"><strong>Diversification needed:</strong> ' + topChannel.channel + ' drives ' + topChannelShare.toFixed(0) + '% of your traffic. Reduce risk by strengthening secondary channels, especially email marketing and social media.</li>';
                                            }
                                        }
                                        
                                        // Add paid search optimization if relevant
                                        const paidChannel = channelInsights.find(c => c.channel === 'Paid Search');
                                        if (paidChannel && dashboardData['Total Cost']) {
                                            if (paidChannel.change < 0) {
                                                items += '<li style="margin-bottom: 10px; font-size: 14px;"><strong>Paid ads refinement:</strong> Great time to test new ad variations. We can improve efficiency by focusing budget on your top 3 converting keywords.</li>';
                                            } else if (paidChannel.change > 20) {
                                                items += '<li style="margin-bottom: 10px; font-size: 14px;"><strong>Paid ads momentum:</strong> ' + paidChannel.change.toFixed(0) + '% growth shows your targeting is working. Increase daily budgets by 20% on top campaigns and test similar audiences.</li>';
                                            }
                                        }
                                        
                                        // Add insights based on aggregated conversion actions
                                        if (dashboardData['Reservations'] && dashboardData['Reservations'].isAggregated) {
                                            const reservations = dashboardData['Reservations'];
                                            if (reservations.value > 500 && reservations.yoy < -10) {
                                                items += '<li style="margin-bottom: 10px; font-size: 14px;"><strong>Reservation optimization:</strong> Despite high volume (' + formatValue(reservations.value) + '), reservations are down ' + Math.abs(reservations.yoy).toFixed(0) + '%. Test new CTAs and placement on high-traffic pages.</li>';
                                            } else if (reservations.value > 500 && reservations.yoy > 10) {
                                                items += '<li style="margin-bottom: 10px; font-size: 14px;"><strong>Reservation success:</strong> ' + formatValue(reservations.value) + ' bookings (+' + reservations.yoy.toFixed(0) + '%) shows your booking flow is working. Consider A/B testing to push even higher.</li>';
                                            }
                                        }
                                        
                                        if (dashboardData['Phone Calls (Ads)'] && dashboardData['Phone Calls (Ads)'].isAggregated) {
                                            const phoneCalls = dashboardData['Phone Calls (Ads)'];
                                            if (phoneCalls.value > 200) {
                                                items += '<li style="margin-bottom: 10px; font-size: 14px;"><strong>Call tracking insight:</strong> With ' + formatValue(phoneCalls.value) + ' ad-driven calls, ensure your team is tracking conversion quality. High-intent callers often convert 3x better than form fills.</li>';
                                            }
                                        }
                                        
                                        if (dashboardData['Restaurant Visits'] && dashboardData['Restaurant Visits'].isAggregated) {
                                            const visits = dashboardData['Restaurant Visits'];
                                            if (visits.value > 100) {
                                                items += '<li style="margin-bottom: 10px; font-size: 14px;"><strong>Foot traffic win:</strong> ' + formatValue(visits.value) + ' tracked restaurant visits from ads. Enable location extensions on all campaigns to maximize this.</li>';
                                            }
                                        }
                                        
                                        // If no specific insights, provide general guidance
                                        if (items === '') {
                                            items += '<li style="margin-bottom: 10px; font-size: 14px;"><strong>Content priority:</strong> Create weekly blog posts about seasonal menu items. This drives both SEO and social engagement.</li>';
                                            items += '<li style="margin-bottom: 10px; font-size: 14px;"><strong>Quick win:</strong> Add reservation buttons to all social profiles. We see competitors getting 50+ monthly bookings from this alone.</li>';
                                            items += '<li style="margin-bottom: 10px; font-size: 14px;"><strong>Test opportunity:</strong> Launch a referral program. Similar restaurants see 15% of new customers from referrals.</li>';
                                        }
                                        
                                        return items;
                                    })()}
                                </ul>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                    <!-- Closing Narrative -->
                    <tr>
                        <td style="padding: 0 30px 30px 30px;" class="mobile-padding">
                            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 6px;" class="dark-mode-card dark-mode-border">
                                <tr>
                                    <td style="padding: 20px;">
                                <p style="margin: 0 0 12px 0; color: #1e293b; font-size: 15px; line-height: 1.6;" class="dark-mode-text mobile-font-size">
                                    ${(() => {
                                        let summary = '';
                                        
                                        // Find the best performing metric
                                        if (bestMetric && bestChange > 20) {
                                            summary = `Outstanding ${reportMonth} with ${bestMetric} up ${bestChange.toFixed(0)}%. `;
                                        } else if (totalViews > 50000) {
                                            summary = `We reached ${formatValue(totalViews)} potential customers in ${reportMonth}. `;
                                        } else if (totalConversions > 500) {
                                            summary = `Solid ${reportMonth} performance with ${formatValue(totalConversions)} customer actions. `;
                                        } else {
                                            summary = `We're building momentum with consistent growth in ${reportMonth}. `;
                                        }
                                        
                                        // Add specific win if reservations are strong (check both GBP button and aggregated Ads reservations)
                                        const reservationsButton = dashboardData['Reservations Button'];
                                        const reservationsAds = dashboardData['Reservations'];
                                        const totalReservations = (reservationsButton ? reservationsButton.value : 0) + 
                                                                 (reservationsAds && reservationsAds.isAggregated ? reservationsAds.value : 0);
                                        
                                        if (totalReservations > 100) {
                                            summary += `The ${formatValue(totalReservations)} total reservation actions show strong purchase intent.`;
                                        } else if (phoneCallsData && phoneCallsData.value > 200) {
                                            summary += `Phone engagement is particularly strong with ${formatValue(phoneCallsData.value)} calls.`;
                                        } else if (dashboardData['Phone Calls (Ads)'] && dashboardData['Phone Calls (Ads)'].value > 100) {
                                            summary += `Paid campaigns drove ${formatValue(dashboardData['Phone Calls (Ads)'].value)} phone inquiries.`;
                                        } else {
                                            summary += `We're seeing consistent engagement across all channels.`;
                                        }
                                        
                                        return summary;
                                    })()}
                                </p>
                                <p style="margin: 0; color: #1e293b; font-size: 15px; line-height: 1.6;" class="dark-mode-text mobile-font-size">
                                    The recommendations above are based on ${reportMonth}'s data patterns. I'm available to discuss implementation strategies or dive deeper into any metrics that interest you.
                                </p>
                                <p style="margin: 15px 0 0 0; color: #1e293b; font-size: 15px;" class="dark-mode-text mobile-font-size">
                                    Best Regards,<br>
                                    <strong style="color: #0f172a;" class="dark-mode-text">Jay & Team</strong>
                                </p>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                    <!-- Footer -->
                    <tr>
                        <td style="background-color: #f8fafc; padding: 24px; border-radius: 0 0 8px 8px; text-align: center; border-top: 1px solid #e2e8f0;" class="dark-mode-card dark-mode-border mobile-padding">
                            <p style="margin: 0; color: #64748b; font-size: 12px;" class="dark-mode-subtext">
                                Generated on ${today} at ${now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}
                            </p>
                            <p style="margin: 8px 0 0 0; color: #94a3b8; font-size: 11px;" class="dark-mode-subtext">
                                This report contains confidential business metrics. Please handle accordingly.
                            </p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>`;
            
            // Display the email HTML in both preview and textarea
            document.getElementById('emailHTML').value = emailHTML;
            document.getElementById('emailPreview').innerHTML = emailHTML;
            document.getElementById('emailOutput').style.display = 'block';
            
            // Set the suggested subject line
            const subjectLineElement = document.getElementById('subjectLineText');
            if (subjectLineElement) {
                subjectLineElement.textContent = `${restaurantName} - ${reportMonth} Marketing Report`;
            }
            
            // Store original email for reset functionality
            window.originalEmailHTML = emailHTML;
            
            // Scroll to the email output
            document.getElementById('emailOutput').scrollIntoView({ behavior: 'smooth' });
        }
        
        function copyEmailHTML() {
            const emailHTML = document.getElementById('emailHTML').value;
            
            // Create a temporary div to hold the HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = emailHTML;
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            document.body.appendChild(tempDiv);
            
            // Select the content
            const range = document.createRange();
            range.selectNodeContents(tempDiv);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            // Copy to clipboard
            try {
                document.execCommand('copy');
                
                // Show feedback
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span>✓</span> Copied!';
                btn.style.background = '#059669';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
            } catch (err) {
                alert('Failed to copy. Please select and copy manually.');
            }
            
            // Clean up
            document.body.removeChild(tempDiv);
            selection.removeAllRanges();
        }
        
        function copyEmailForGmail() {
            const emailHTML = document.getElementById('emailHTML').value;
            
            // Create a temporary container
            const container = document.createElement('div');
            container.innerHTML = emailHTML;
            container.style.position = 'fixed';
            container.style.pointerEvents = 'none';
            container.style.opacity = '0';
            container.style.fontSize = '14px';
            document.body.appendChild(container);
            
            // Select and copy the rendered HTML
            const selection = window.getSelection();
            const range = document.createRange();
            range.selectNodeContents(container);
            selection.removeAllRanges();
            selection.addRange(range);
            
            try {
                // This copies the rich HTML format that Gmail can paste
                document.execCommand('copy');
                
                // Show feedback
                alert('Email copied! Open Gmail, compose a new message, and paste (Ctrl/Cmd + V) into the message body.');
            } catch (err) {
                console.error('Copy failed:', err);
                alert('Copy failed. Try using the Preview button and copying from there.');
            }
            
            // Clean up
            document.body.removeChild(container);
            selection.removeAllRanges();
        }
        
        function previewEmail() {
            const emailHTML = document.getElementById('emailHTML').value;
            const previewWindow = window.open('', 'Email Preview', 'width=650,height=800');
            previewWindow.document.write(emailHTML);
            previewWindow.document.close();
        }
        
        // New editing functions
        let editModeEnabled = false;
        
        function toggleEditMode() {
            editModeEnabled = !editModeEnabled;
            const preview = document.getElementById('emailPreview');
            const tips = document.getElementById('editingTips');
            const btnText = document.getElementById('editModeText');
            
            if (editModeEnabled) {
                // Enable editing mode
                preview.style.border = '2px solid var(--primary)';
                tips.style.display = 'block';
                btnText.textContent = 'Disable Editing';
                
                // Make all text elements editable
                makeEmailEditable();
            } else {
                // Disable editing mode
                preview.style.border = '1px solid var(--border)';
                tips.style.display = 'none';
                btnText.textContent = 'Enable Editing';
                
                // Remove editing capabilities
                makeEmailReadOnly();
            }
        }
        
        function makeEmailEditable() {
            const preview = document.getElementById('emailPreview');
            
            // Find all text elements and make them editable
            const editableElements = preview.querySelectorAll('h1, h2, h3, p, td, li, strong, span');
            editableElements.forEach(el => {
                // Skip if it's a container with other elements
                if (el.children.length === 0 || el.tagName === 'SPAN' || el.tagName === 'STRONG') {
                    el.contentEditable = true;
                    el.style.cursor = 'text';
                    el.style.outline = 'none';
                    
                    // Add hover effect
                    el.addEventListener('mouseenter', function() {
                        if (editModeEnabled) {
                            this.style.backgroundColor = 'rgba(139, 92, 246, 0.05)';
                            this.style.borderRadius = '4px';
                        }
                    });
                    
                    el.addEventListener('mouseleave', function() {
                        if (editModeEnabled) {
                            this.style.backgroundColor = '';
                        }
                    });
                    
                    // Update stored HTML on edit
                    el.addEventListener('input', updateStoredHTML);
                }
            });
            
            // Add delete functionality to sections
            const deletableSections = preview.querySelectorAll('tr, div[style*="background"]');
            deletableSections.forEach(section => {
                section.addEventListener('contextmenu', function(e) {
                    if (editModeEnabled) {
                        e.preventDefault();
                        if (confirm('Delete this section?')) {
                            section.style.transition = 'opacity 0.3s';
                            section.style.opacity = '0';
                            setTimeout(() => {
                                section.remove();
                                updateStoredHTML();
                            }, 300);
                        }
                    }
                });
            });
        }
        
        function makeEmailReadOnly() {
            const preview = document.getElementById('emailPreview');
            const editableElements = preview.querySelectorAll('[contenteditable="true"]');
            editableElements.forEach(el => {
                el.contentEditable = false;
                el.style.cursor = '';
                el.style.backgroundColor = '';
            });
        }
        
        function updateStoredHTML() {
            // Update the HTML textarea with current preview content
            const preview = document.getElementById('emailPreview');
            document.getElementById('emailHTML').value = preview.innerHTML;
        }
        
        function copyEditedEmail() {
            const preview = document.getElementById('emailPreview');
            
            // First, make sure everything is read-only
            makeEmailReadOnly();
            
            // Create a selection range for the entire preview
            const selection = window.getSelection();
            const range = document.createRange();
            range.selectNodeContents(preview);
            selection.removeAllRanges();
            selection.addRange(range);
            
            try {
                // Copy the rich HTML format
                document.execCommand('copy');
                
                // Show success message
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span>✓</span> Copied!';
                btn.style.background = '#059669';
                
                alert('Email copied! Open Gmail and paste (Ctrl/Cmd + V) into the message body.');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
            } catch (err) {
                alert('Copy failed. Try selecting the preview manually and copying.');
            }
            
            selection.removeAllRanges();
        }
        
        function previewInNewWindow() {
            const preview = document.getElementById('emailPreview');
            const previewWindow = window.open('', 'Email Preview', 'width=650,height=800');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Email Preview</title>
                    <style>
                        body { margin: 0; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; }
                    </style>
                </head>
                <body>
                    ${preview.innerHTML}
                </body>
                </html>
            `);
            previewWindow.document.close();
        }
        
        function resetEmail() {
            if (confirm('Reset all changes and restore original email?')) {
                document.getElementById('emailPreview').innerHTML = window.originalEmailHTML;
                document.getElementById('emailHTML').value = window.originalEmailHTML;
                
                // Disable edit mode if it's on
                if (editModeEnabled) {
                    toggleEditMode();
                }
            }
        }
        
        function toggleHTMLView() {
            const preview = document.getElementById('emailPreview');
            const htmlView = document.getElementById('emailHTML');
            const btn = event.target.closest('button');
            
            if (htmlView.style.display === 'none') {
                // Show HTML view
                preview.style.display = 'none';
                htmlView.style.display = 'block';
                btn.innerHTML = '<span>📧</span> View Preview';
                
                // Update HTML from preview in case there were edits
                htmlView.value = preview.innerHTML;
            } else {
                // Show preview
                preview.style.display = 'block';
                htmlView.style.display = 'none';
                btn.innerHTML = '<span>{ }</span> View HTML';
            }
        }
        
        function loadSampleReport() {
            const sample = `# 3rd Cousin: August 1, 2025 – August 31, 2025

## GBP Performance

| Metric             | Value  | Y/Y Change | M/M Change |
|:-------------------|:------:|:----------:|:----------:|
| Total Views        | 55,393 | +264%      | -22%       |
| Website Clicks     | 889    |  -3%       |  -3%       |
| Phone Calls        | 89     | +33%       | -50%       |
| Directions Requests| 590    | +50%       | +27%       |
| Total Actions      | 1,568  | +14%       | —          |
| Reviews Count      | 380    |  +3%       | +0.4%      |
| Rating             | 4.5    | +0.1%      | —          |

## Campaign Performance

Total costs for this period: $2,999.68

| Conversion Action             | Conversion Volume | % Change  |
|:------------------------------|:----------------:|:---------:|
| mobile_number (Search)        | 9                | -62.5%    |
| Inquire Now (Search)          | 4                | +300.0%   |
| book_reservation (Search)     | 113              | -36.8%    |
| Restaurant visits (Search)    | 8                | -11.1%    |
| mobile_number (Reservations)  | 557              | -57.9%    |
| book_reservation (Reservations)| 947             | -39.5%    |
| Restaurant visits (Reservations)| 195            | -14.9%    |

## Analytics Overview

| Metric                | Value   | % Change  |
|:----------------------|:-------:|:---------:|
| Active Users          | 11,381  | -16%      |
| New Users             | 11,243  | -12%      |
| Total Revenue         | $0      | —         |
| Average Engagement Time| 29 sec | —         |

## Page & Screen Performance

| Page Title / Screen Name    | Views  | % Change |
|:----------------------------|:------:|:--------:|
| Home                        | 13,845 | -26%     |
| Menu                        | 1,180  | -3%      |
| Reservations                | 1,060  | -22%     |
| Chef's Tasting              | 1,140  | +9%      |
| A La Carte                  | 1,088  | -6%      |
| Contact Us / Location       | 160    | -15%     |

## Channel Performance

| Channel          | Sessions | % Change  |
|:-----------------|:--------:|:---------:|
| Organic Search   | 1,772    | +27%      |
| Direct           | 1,253    | -13%      |
| Paid Search      | 663      | -43%      |
| Organic Social   | 107      | -31%      |
| Paid Social      | 4,352    | +8%       |
| Cross-network    | 2,953    | -41%      |

## Key Insights

-  Website clicks stable, strong annual growth in total actions  
-  Phone calls and directions requests up sharply Y/Y, strong local intent  
-  Chef's Tasting content views +9% MoM  
-  Organic Search (+27%) leading channel growth  
-  Paid Social showing momentum with +8% growth
-  Opportunity to improve Paid Search efficiency and Organic Social engagement

## Recommendations

1. Maximize high-performing channels: Boost budget for Organic Search, Paid Social, and Cross-network
2. Re-engage direct traffic: Launch loyalty/email campaigns to counter declining direct visits
3. Revitalize social media: Update content and increase posting frequency to recover Organic Social dips
4. Optimize conversion points on menu and reservation pages
5. Test new ad creative for Paid Search to improve -43% performance`;
            
            document.getElementById('reportText').value = sample;
            parseReport();
        }

        // Initialize the dashboard when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initialized');
            
            // Load dark mode preference from localStorage
            const savedDarkMode = localStorage.getItem('emailDarkMode') === 'true';
            const darkModeCheckbox = document.getElementById('emailDarkMode');
            if (darkModeCheckbox) {
                darkModeCheckbox.checked = savedDarkMode;
            }
            
            // Ensure all functions are available
            window.loadSampleReport = loadSampleReport;
            window.parseReport = parseReport;
            window.generateEmailReport = generateEmailReport;
            window.switchTab = switchTab;
            window.switchSection = switchSection;
            window.clearReport = clearReport;
            window.copyEditedEmail = copyEditedEmail;
            window.toggleEditMode = toggleEditMode;
            window.previewInNewWindow = previewInNewWindow;
            window.resetEmail = resetEmail;
            window.toggleHTMLView = toggleHTMLView;
        });
    </script>
</body>
</html>